<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simulador de Vida: Pobre a Rico</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß¨</text></svg>">
    <!-- Import Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --text-color: #E0E0E0;
            --accent-color: #39FF14;
            /* Neon Green */
            --danger-color: #FF3939;
            --info-color: #4da6ff;
            --secondary-text: #A0A0A0;
            --font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }



        /* --- Header --- */
        header {
            flex: 0 0 auto;
            background-color: #1a1a1a;
            padding: 15px;
            border-bottom: 1px solid #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .money-display {
            color: var(--accent-color);
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(57, 255, 20, 0.3);
            transition: color 0.3s, transform 0.2s;
        }

        .money-display.gain {
            color: #39FF14;
            transform: scale(1.1);
        }

        .money-display.loss {
            color: #FF3939;
            transform: scale(1.1);
        }

        /* Settings Button styled as transparent icon */
        .settings-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .date-display {
            color: var(--secondary-text);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .job-display {
            font-size: 0.8rem;
            color: #ddd;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            /* Stack title and bar */
            background: #252525;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #444;
            gap: 2px;
        }

        .job-xp-bg {
            height: 4px;
            background: #111;
            border-radius: 2px;
            width: 100%;
            overflow: hidden;
            margin-top: 2px;
        }

        .job-xp-fill {
            height: 100%;
            background: var(--info-color);
            width: 0%;
            transition: width 0.3s;
        }

        .job-row-top {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .bar-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bar-label {
            font-size: 0.75rem;
            color: var(--secondary-text);
            display: flex;
            justify-content: space-between;
        }

        .progress-bg {
            height: 6px;
            background-color: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 50%;
            transition: width 0.4s ease;
        }

        .health-fill {
            background-color: #ff4d4d;
        }

        .happiness-fill {
            background-color: #4dffea;
        }

        .intelligence-fill {
            background-color: #cf39ff;
        }

        .energy-fill {
            background-color: #ffd700;
        }

        @keyframes blinkRed {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        .critical {
            animation: blinkRed 1s infinite;
        }

        /* Activity Modal Buttons */
        .act-btn {
            background: #252525;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 10px;
            width: 100%;
            color: #fff;
            text-align: left;
        }

        .act-btn:active {
            background: #333;
        }

        .act-info h4 {
            margin: 0;
            color: var(--accent-color);
            font-size: 1rem;
        }

        .act-info p {
            margin: 2px 0 0;
            font-size: 0.8rem;
            color: #aaa;
        }

        .act-cost {
            text-align: right;
            font-size: 0.9rem;
            font-weight: bold;
            color: #ff6b6b;
        }


        /* --- Main Content (Log) --- */
        main {
            flex: 1 1 auto;
            position: relative;
            /* For floating text */
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scroll-behavior: smooth;
        }

        .float-text {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
            animation: floatUp 1.2s forwards;
            text-shadow: 1px 1px 2px black;
            z-index: 100;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                top: 40%;
                transform: translate(-50%, 0) scale(0.8);
            }

            50% {
                transform: translate(-50%, -20px) scale(1.2);
            }

            100% {
                opacity: 0;
                top: 20%;
                transform: translate(-50%, -40px) scale(1);
            }
        }

        .event-card {
            background-color: var(--card-bg);
            border-left: 3px solid var(--accent-color);
            padding: 12px 15px;
            border-radius: 4px;
            animation: fadeIn 0.4s ease-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-size: 0.95rem;
            line-height: 1.4;
            flex-shrink: 0;
        }

        .event-card.bad {
            border-left-color: var(--danger-color);
            color: #ffaaaa;
        }

        .event-card.good {
            border-left-color: var(--accent-color);
            color: #ccffcc;
        }

        .event-card.info {
            border-left-color: var(--info-color);
        }

        .event-date {
            font-size: 0.7rem;
            color: #666;
            display: block;
            margin-bottom: 3px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Event Choice Modal */
        .choice-btn {
            background-color: #333;
            color: #fff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #444;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
        }

        .choice-btn:active {
            background-color: #444;
        }

        .choice-text {
            display: block;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .choice-sub {
            font-size: 0.8rem;
            color: #aaa;
        }

        /* Shop Items */
        .shop-item {
            background: #252525;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shop-details h4 {
            margin: 0 0 5px 0;
            font-size: 0.95rem;
            color: var(--text-color);
        }

        .shop-details p {
            margin: 0;
            font-size: 0.8rem;
            color: #aaa;
        }

        .shop-cost {
            font-size: 0.85rem;
            color: var(--accent-color);
            font-weight: bold;
            margin-top: 4px;
        }

        .shop-maint {
            font-size: 0.75rem;
            color: #ff6b6b;
        }

        .btn-buy {
            padding: 6px 12px;
            font-size: 0.75rem;
            background: var(--accent-color);
            color: #000;
            border: none;
            border-radius: 4px;
            font-weight: bold;
        }

        .btn-buy:disabled {
            background: #444;
            color: #888;
        }

        .owned-tag {
            color: #4dffea;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Footer (Bottom Nav) */
        footer {
            flex: 0 0 auto;
            background-color: #1a1a1a;
            border-top: 1px solid #333;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            height: auto;
            min-height: 60px;
            padding: 4px;
            padding-bottom: max(4px, env(safe-area-inset-bottom));
        }

        footer button {
            background: transparent;
            border: none;
            border-radius: 4px;
            padding: 4px;
            color: #888;
            font-size: 0.65rem;
            gap: 2px;
            height: 100%;
        }

        footer button:active:not([disabled]) {
            background-color: #252525;
            transform: scale(0.95);
        }

        footer button.primary {
            background: transparent;
            color: var(--accent-color);
            box-shadow: none;
        }

        footer button .btn-icon {
            font-size: 1.4rem;
            display: block;
            margin-bottom: 2px;
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(0.8);
        }

        button.primary {
            background-color: var(--accent-color);
            color: #000;
            border: none;
            box-shadow: 0 0 8px rgba(57, 255, 20, 0.2);
        }

        button.primary:active:not([disabled]) {
            background-color: #2ecc12;
        }

        .btn-icon {
            font-size: 1.3rem;
            margin-bottom: 2px;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: #1E1E1E;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .modal-body {
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .job-item {
            background: #252525;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .job-details h4 {
            margin: 0 0 5px 0;
            font-size: 1rem;
            color: var(--accent-color);
        }

        .job-details p {
            margin: 0;
            font-size: 0.8rem;
            color: #aaa;
        }

        .job-req {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }

        .job-item.locked {
            opacity: 0.6;
        }

        .btn-select-job {
            padding: 6px 12px;
            font-size: 0.75rem;
            background: #444;
            color: #fff;
            border: none;
            border-radius: 4px;
        }

        .btn-select-job.active-job {
            background: var(--accent-color);
            color: #000;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #fff;
            padding: 0;
        }

        /* Settings specific */
        .settings-group {
            border: 1px solid #333;
            padding: 10px;
            border-radius: 6px;
            background: #252525;
        }

        .settings-group h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: #888;
        }

        /* --- TROPHY SYSTEM --- */
        .trophy-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(200%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 10000;
            pointer-events: none;
        }

        .trophy-popup.active {
            transform: translateX(0);
        }

        .trophy-icon {
            font-size: 2rem;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-5px);
            }
        }

        .trophy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            padding: 10px;
        }

        .trophy-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid #444;
            opacity: 0.5;
            transition: transform 0.2s;
        }

        .trophy-card.unlocked {
            opacity: 1;
            border-color: #FFD700;
            background: linear-gradient(to bottom, #2a2a2a, #332a00);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
            cursor: pointer;
        }

        .trophy-card.unlocked:hover {
            transform: scale(1.05);
        }

        .trophy-card .t-icon {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }

        .trophy-card .t-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
        }

        .trophy-card .t-desc {
            font-size: 0.7rem;
            color: #aaa;
            display: none;
            margin-top: 5px;
        }

        .trophy-card:hover .t-desc {
            display: block;
        }

        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
        }

        .btn-full {
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            flex-direction: row;
        }

        .status-msg {
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: #fff;
            border-bottom: 3px solid var(--accent-color);
        }

        .market-card {
            background: #1a1a1a;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Finance Panel CSS */
        .finance-panel {
            background: #222;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #333;
        }

        .fin-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .fin-label {
            color: #888;
        }

        .fin-val {
            font-weight: bold;
            color: #fff;
        }

        .fin-val.passive {
            color: #4dffea;
        }

        .asset-bar {
            height: 8px;
            background: #111;
            border-radius: 4px;
            display: flex;
            overflow: hidden;
            margin-top: 5px;
        }

        .asset-seg {
            height: 100%;
            transition: width 0.3s;
        }

        .seg-cash {
            background-color: #39FF14;
        }

        .seg-inv {
            background-color: #00bcd4;
        }

        /* Cyan */
        .seg-re {
            background-color: #ff9800;
        }

        /* Orange */

        /* ============================================ */
        /* DEV MODE STYLES (REMOVE IN PRODUCTION) */
        /* ============================================ */
        .dev-panel {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            color: #00ff00;
        }

        .dev-header {
            background: #1a1a1a;
            padding: 10px 15px;
            border-bottom: 1px solid #00ff00;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .dev-body {
            padding: 15px;
        }

        .dev-body h4 {
            color: #00ff00;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 5px;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            letter-spacing: 2px;
        }

        .dev-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .dev-buttons button {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 15px;
            cursor: pointer;
        }

        .dev-input-row label {
            flex: 1;
            font-size: 0.85rem;
        }

        .dev-input-row input {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 5px 8px;
            font-family: 'Courier New', monospace;
        }

        .dev-input-row button {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 5px 15px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.2s;
        }

        .dev-input-row button:hover {
            background: #00ff00;
            color: #0a0a0a;
        }

        #dev-state-viewer {
            background: #000;
            border: 1px solid #00ff00;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.7rem;
            color: #00ff00;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 10px 0;
        }

        #dev-auth {
            text-align: center;
            padding: 20px;
        }

        #dev-auth input {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 10px;
            width: 80%;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        #dev-auth button {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 10px 30px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.2s;
        }

        #dev-auth button:hover {
            background: #00ff00;
            color: #0a0a0a;
        }

        .dev-panel .close-btn {
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-size: 1.5rem;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .dev-panel .close-btn:hover {
            background: #00ff00;
            color: #0a0a0a;
        }

        /* === LIFESTYLE SHOP MODAL === */
        .lifestyle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }

        .lifestyle-card {
            background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%);
            border: 2px solid #444;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .lifestyle-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .lifestyle-card.current {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #1e3a1e 0%, #2a4a2a 100%);
        }

        .lifestyle-card.current::before {
            content: "‚úì ACTUAL";
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .lifestyle-card-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }

        .lifestyle-card-desc {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 12px;
            font-style: italic;
        }

        .lifestyle-card-stats {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 12px;
            font-size: 0.85rem;
        }

        .lifestyle-card-stat {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }

        .lifestyle-card-stat-label {
            color: #999;
        }

        .lifestyle-card-stat-value {
            color: #fff;
            font-weight: bold;
        }

        .lifestyle-card-stat-value.positive {
            color: #4CAF50;
        }

        .lifestyle-card-stat-value.negative {
            color: #f44336;
        }

        .lifestyle-card-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lifestyle-card-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.5);
        }

        .lifestyle-card-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .shop-tab {
            flex: 1;
            padding: 12px 20px;
            background: #2a2a3e;
            border: 2px solid #444;
            border-radius: 8px;
            color: #aaa;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .shop-tab:hover {
            border-color: #667eea;
            color: #fff;
        }

        .shop-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .lifestyle-tab-content {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }


        /* --- MY HOME UI --- */
        .family-card {
            background: #252525;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid var(--accent-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 768px) {
            .lifestyle-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="header-top">
            <div class="date-display" id="date-display">A√±o 18 - Mes 1</div>
            <div>
                <button class="settings-btn" id="shop-trigger" style="margin-right:10px;">üõí</button>
                <button class="settings-btn" id="home-trigger" style="margin-right:10px;">üè†</button>
                <button class="settings-btn" id="trophy-trigger" style="margin-right:10px;">üèÜ</button>
                <button class="settings-btn" id="settings-trigger">‚öôÔ∏è</button>
            </div>
        </div>

        <div class="finance-panel">
            <div class="fin-row">
                <span>Efectivo: <span class="money-display" id="money-display">$0</span></span>
                <span>Neto: <span id="networth-val">$0</span></span>
            </div>
            <div class="fin-row" style="font-size:0.8rem;">
                <span>Activo: <span id="income-active" style="color:var(--accent-color)">$0/m</span></span>
                <span>Pasivo: <span id="income-passive" class="fin-val passive">$0/m</span></span>
            </div>
            <div class="asset-bar" id="fn-asset-bar">
                <div class="asset-seg seg-cash" style="width:100%"></div>
                <div class="asset-seg seg-inv" style="width:0%"></div>
                <div class="asset-seg seg-re" style="width:0%"></div>
            </div>
        </div>

        <div class="job-display" id="job-trigger">
            <div class="job-row-top">
                <span id="job-title-display">Mendigo ($0/mes)</span>
                <span>‚ÑπÔ∏è Cambiar</span>
            </div>
            <div class="job-xp-bg">
                <div class="job-xp-fill" id="job-xp-bar"></div>
            </div>
            <div id="diploma-display" style="font-size: 0.7rem; color: var(--accent-color); margin-top: 2px;"></div>
        </div>

        <div class="stat-grid">
            <!-- Row 1 -->
            <div class="bar-group">
                <div class="bar-label"><span>üí™ Salud F√≠sica</span> <span id="health-val">100%</span></div>
                <div class="progress-bg">
                    <div class="progress-fill health-fill" id="health-bar" style="width: 100%;"></div>
                </div>
            </div>
            <div class="bar-group">
                <div class="bar-label"><span>üß† Salud Mental</span> <span id="mhealth-val">100%</span></div>
                <div class="progress-bg">
                    <div class="progress-fill" id="mhealth-bar" style="width: 100%; background: #70a1ff;"></div>
                </div>
            </div>
            <!-- Row 2 -->
            <div class="bar-group">
                <div class="bar-label"><span>Felicidad</span> <span id="happiness-val">100%</span></div>
                <div class="progress-bg">
                    <div class="progress-fill happiness-fill" id="happiness-bar" style="width: 100%;"></div>
                </div>
            </div>
            <div class="bar-group">
                <div class="bar-label"><span>Energ√≠a</span> <span id="energy-val">100%</span></div>
                <div class="progress-bg">
                    <div class="progress-fill energy-fill" id="energy-bar" style="width: 100%;"></div>
                </div>
            </div>
            <!-- Row 3 -->
            <div class="bar-group">
                <div class="bar-label"><span>Inteligencia</span> <span id="intel-val">10</span></div>
                <div class="progress-bg">
                    <div class="progress-fill intelligence-fill" id="intel-bar" style="width: 10%;"></div>
                </div>
            </div>
        </div>
    </header>

    <main id="event-log">
        <div class="event-card info">
            <span class="event-date">Inicio</span>
            Bienvenido. Tienes 18 a√±os. Comienza tu historia.
        </div>
    </main>

    <footer>
        <button id="btn-work">
            <span class="btn-icon">üíº</span>Trabajar
        </button>
        <button id="btn-study">
            <span class="btn-icon">‚ö°</span>Mejorar
        </button>
        <button id="btn-rest">
            <span class="btn-icon">üí§</span>Descansar
        </button>
        <button id="btn-next" class="primary">
            <span class="btn-icon">üìÖ</span>Sig. Mes
        </button>
    </footer>

    <!-- Event Choice Modal -->
    <div class="modal-overlay" id="event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Evento</span>
            </div>
            <div class="modal-body">
                <p id="event-text" style="font-size: 1rem; line-height: 1.5; margin-bottom: 20px;">...</p>
                <div id="event-choices">
                    <!-- Choices injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Trophy Notification -->
    <div id="trophy-notification" class="trophy-popup">
        <div class="trophy-icon">üèÜ</div>
        <div>
            <div style="font-size:0.8rem; font-weight:bold; letter-spacing:1px;">LOGRO DESBLOQUEADO</div>
            <div id="trophy-msg-name" style="font-size:1.1rem; font-weight:900;">Nombre del Trofeo</div>
        </div>
    </div>

    <!-- Trophy Modal -->
    <div class="modal-overlay" id="trophy-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üèÜ Galer√≠a de Trofeos</h2>
                <button class="close-btn" id="close-trophy-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="trophy-grid" id="trophy-list">
                    <!-- Trophies injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Job Modal -->
    <div class="modal-overlay" id="job-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Oportunidades de Empleo</span>
                <button class="close-btn" id="close-job-modal">&times;</button>
            </div>
            <div class="modal-body" id="job-list-container">
                <!-- Job items injected here -->
            </div>
        </div>
    </div>

    <!-- Generic Alert Modal -->
    <div class="modal-overlay" id="end-game-modal" style="z-index: 200;">
        <div class="modal-content">
            <h2>¬°Jubilaci√≥n! üë¥</h2>
            <div id="end-game-summary" style="margin: 20px 0; text-align: left;"></div>
            <h3 id="end-game-score" style="color: var(--gold-color); text-align: center; font-size: 1.5rem;"></h3>

            <h4 style="margin-top:20px; border-bottom:1px solid #333;">Legado (Herencia)</h4>
            <p style="font-size:0.9rem; color:#aaa;">Elige qu√© dejarle a tu pr√≥xima vida:</p>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="act-btn" onclick="Game.claimLegacy('money')">
                    <div class="act-info">
                        <h4>Fortuna</h4>
                        <p>Hereda el 10% de tu dinero.</p>
                    </div>
                </button>
                <button class="act-btn" onclick="Game.claimLegacy('genetics')">
                    <div class="act-info">
                        <h4>Gen√©tica</h4>
                        <p>Hereda el 20% de tu Inteligencia.</p>
                    </div>
                </button>
            </div>

            <div style="margin-top:20px;">
                <button class="btn-select-job" style="width:100%" onclick="Game.restartGame()">Nueva Vida (Sin
                    Herencia)</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="alert-modal" style="z-index: 100;">
        <div class="modal-content" style="max-width:300px; text-align: center;">
            <div class="modal-body">
                <h3 id="alert-title" style="margin-top:0; color:var(--text-color);">Alerta</h3>
                <p id="alert-msg" style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">Mensaje</p>
                <button class="btn-full primary" id="alert-ok-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- Activity Modal -->
    <div class="modal-overlay" id="activity-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Actividades</span>
                <button class="close-btn" id="close-act-modal">&times;</button>
            </div>

            <div class="act-tabs" style="display:flex; justify-content:space-between; padding:10px; gap:5px;">
                <button class="tab-btn active" onclick="GameUI.switchActTab('courses')">Educaci√≥n</button>
                <button class="tab-btn" onclick="GameUI.switchActTab('projects')">Proyectos</button>
                <button class="tab-btn" onclick="GameUI.switchActTab('crime')">Crimen</button>
                <button class="tab-btn" onclick="GameUI.switchActTab('social')">Social</button>
            </div>

            <div class="modal-body">
                <div id="act-tab-courses">
                    <h4 style="margin-top:0; color:#aaa; border-bottom:1px solid #333; padding-bottom:5px;">Acciones
                        R√°pidas</h4>
                    <button class="act-btn" onclick="Game.doActivity('study')">
                        <div class="act-info">
                            <h4>Estudiar</h4>
                            <p>Mejora tu Inteligencia.</p>
                        </div>
                        <div class="act-cost">-$200<br>-25 E</div>
                    </button>
                    <button class="act-btn" onclick="Game.doActivity('gym')">
                        <div class="act-info">
                            <h4>Gimnasio</h4>
                            <p>Ejercicio moderado.</p>
                        </div>
                        <div class="act-cost">-$40<br>-20 E</div>
                    </button>
                    <button class="act-btn" onclick="Game.doActivity('meditate')">
                        <div class="act-info">
                            <h4>üßò Meditaci√≥n</h4>
                            <p>Calma tu mente y reduce el estr√©s.</p>
                        </div>
                        <div class="act-cost">Gratis<br>-10 E</div>
                    </button>
                    <button class="act-btn" onclick="Game.doActivity('therapy')">
                        <div class="act-info">
                            <h4>üõãÔ∏è Terapia</h4>
                            <p>Sesi√≥n profesional para tu salud mental.</p>
                        </div>
                        <div class="act-cost">-$100<br>-5 E</div>
                    </button>
                    <button class="act-btn" onclick="Game.doActivity('marathon')">
                        <div class="act-info">
                            <h4>Marat√≥n</h4>
                            <p>Gran impulso a Salud y Felicidad.</p>
                        </div>
                        <div class="act-cost">-$100<br>-50 E</div>
                    </button>
                    <h4 style="margin-top:20px; color:#aaa; border-bottom:1px solid #333; padding-bottom:5px;">Educaci√≥n
                        Superior</h4>
                    <div id="courses-list"></div>

                </div>

                <div id="act-tab-projects" class="hidden">
                    <div id="projects-container"></div>
                </div>

                <div id="act-tab-crime" class="hidden">
                    <div
                        style="background:#330000; padding:10px; border-radius:5px; margin-bottom:15px; border:1px solid #ff0000;">
                        <h4 style="margin:0; color:#ff5555;">‚ö†Ô∏è ZONA ILEGAL</h4>
                        <p style="font-size:0.8rem; color:#aaa;">Alto riesgo. La polic√≠a vigila.</p>
                    </div>
                    <button class="act-btn" onclick="Game.commitCrime('scam')">
                        <div class="act-info">
                            <h4>Estafa Piramidal</h4>
                            <p>Enga√±a a incautos.</p>
                        </div>
                        <div class="act-cost">Risk: +5%<br>Karma: -5</div>
                    </button>
                    <button class="act-btn" onclick="Game.commitCrime('embezzle')">
                        <div class="act-info">
                            <h4>Malversar Fondos</h4>
                            <p>Robo corporativo silencioso.</p>
                        </div>
                        <div class="act-cost">Risk: +15%<br>Karma: -10</div>
                    </button>
                    <button class="act-btn" onclick="Game.commitCrime('deal')">
                        <div class="act-info">
                            <h4>Negocio Ilegal</h4>
                            <p>Tr√°fico y contrabando.</p>
                        </div>
                        <div class="act-cost">Risk: +30%<br>Karma: -25</div>
                    </button>
                </div>

                <div id="act-tab-social" class="hidden">
                    <button class="act-btn" onclick="Game.party()">
                        <div class="act-info">
                            <h4>Salir de Fiesta üéâ</h4>
                            <p>P√°salo bien y conoce gente nueva.</p>
                        </div>
                        <div class="act-cost">-$150<br>-40 E</div>
                    </button>
                    <button class="act-btn" onclick="Game.showLifestyleShop()"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="act-info">
                            <h4>üè† Lifestyle Shop</h4>
                            <p>Compra vivienda y veh√≠culos.</p>
                        </div>
                        <div class="act-cost">Estatus: <span id="status-display-btn">0</span></div>
                    </button>
                    <h4 style="margin-top:20px; color:#aaa; border-bottom:1px solid #333; padding-bottom:5px;">Mis
                        Contactos</h4>
                    <div id="friends-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lifestyle Shop Modal -->
    <div class="modal-overlay" id="lifestyle-modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üè† Lifestyle Shop</h2>
                <button class="close-modal" id="close-lifestyle">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Status Bar -->
                <div
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">üí∞ Dinero</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #fff;" id="lifestyle-money">$0
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">‚≠ê Estatus</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #fff;" id="lifestyle-status">0
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">üè† Vivienda</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #fff;"
                                id="lifestyle-current-housing">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">üöó Veh√≠culo</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #fff;"
                                id="lifestyle-current-vehicle">-</div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="shop-tabs" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="shop-tab active" onclick="UI.switchLifestyleTab('housing')" id="tab-housing">
                        üè† Viviendas
                    </button>
                    <button class="shop-tab" onclick="UI.switchLifestyleTab('vehicles')" id="tab-vehicles">
                        üöó Veh√≠culos
                    </button>
                    <button class="shop-tab" onclick="UI.switchLifestyleTab('pets')" id="tab-pets">
                        üêæ Mascotas
                    </button>
                </div>

                <!-- Housing Tab -->
                <div id="lifestyle-tab-housing" class="lifestyle-tab-content">
                    <div class="lifestyle-grid" id="housing-grid"></div>
                </div>

                <!-- Vehicles Tab -->
                <div id="lifestyle-tab-vehicles" class="lifestyle-tab-content hidden">
                    <div class="lifestyle-grid" id="vehicles-grid"></div>
                </div>

                <!-- Pets Tab -->
                <div id="lifestyle-tab-pets" class="lifestyle-tab-content hidden">
                    <div class="lifestyle-grid" id="pets-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Home Modal -->
    <div class="modal-overlay" id="home-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè† Mi Hogar</h2>
                <button class="close-btn" id="close-home-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="my-home-summary"
                    style="background:#2a2a3e; padding:15px; border-radius:10px; margin-bottom:20px; text-align:center;">
                    <div style="font-size:0.9rem; color:#aaa;">Gastos Familiares</div>
                    <div style="font-size:1.5rem; color:#ff3939; font-weight:bold;" id="home-total-expenses">$0/mes
                    </div>
                </div>

                <div id="family-list">
                    <!-- Family Members Injected Here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Shop Modal -->
    <div class="modal-overlay" id="shop-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Mercado & Finanzas</span>
                <button class="close-btn" id="close-shop-modal">&times;</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="GameUI.switchShopTab('goods')">Bienes</button>
                <button class="tab-btn" onclick="GameUI.switchShopTab('invest')">Inversiones</button>
                <button class="tab-btn" onclick="GameUI.switchShopTab('realestate')">Inmuebles</button>
            </div>

            <div class="modal-body">
                <div id="shop-tab-goods">
                    <div id="shop-list-container">
                        <!-- Shop items injected here -->
                    </div>
                </div>
            </div>
            <div id="shop-tab-invest" class="hidden">
                <div id="invest-list-container">
                    <!-- Investments injected here -->
                </div>
            </div>
            <div id="shop-tab-realestate" class="hidden">
                <div id="realestate-list-container"></div>
            </div>
        </div>
    </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Ajustes & Guardado</span>
                <button class="close-btn" id="close-settings-modal">&times;</button>
            </div>
            <div class="modal-body">

                <!-- Diet/Lifestyle Section -->
                <div class="settings-group">
                    <h4>üçΩÔ∏è Estilo de Vida</h4>
                    <label style="display:block; margin-bottom:5px; color:#aaa;">Dieta:</label>
                    <select id="diet-selector"
                        style="width:100%; padding: 10px; margin-bottom: 10px; background: #333; color: white; border: none; border-radius: 5px;">
                        <option value="fast_food">Comida R√°pida ($100/mes, -2 Salud F√≠sica)</option>
                        <option value="balanced" selected>Balanceada ($300/mes)</option>
                        <option value="chef">Chef Privado ($1000/mes, +2 Salud F√≠sica)</option>
                    </select>
                </div>

                <!-- Auth Section -->
                <div class="settings-group" id="auth-section">
                    <h4>Cuenta (Cloud Save)</h4>
                    <div id="auth-form">
                        <input type="email" id="email-input" placeholder="Email">
                        <input type="password" id="pass-input" placeholder="Contrase√±a">
                        <button class="btn-full primary" id="btn-login">Iniciar / Registrar</button>
                    </div>
                    <div id="user-info" class="hidden">
                        <p style="font-size: 0.85rem; margin-bottom:10px;">Usuario: <span id="user-email"></span></p>
                        <button class="btn-full" id="btn-logout">Cerrar Sesi√≥n</button>
                    </div>
                    <div class="status-msg" id="auth-msg"></div>
                </div>

                <!-- Save/Load Section -->
                <div class="settings-group">
                    <h4>Partida</h4>
                    <button class="btn-full" id="btn-save" disabled>üíæ Guardar en Nube</button>
                    <button class="btn-full" id="btn-load" disabled>üìÇ Cargar de Nube</button>
                    <div class="status-msg" id="save-msg">Inicia sesi√≥n para guardar.</div>
                </div>

            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- DEV MODE PANEL (REMOVE IN PRODUCTION) -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="dev-modal">
        <div class="dev-panel">
            <div class="dev-header">
                <span>üîß DEV MODE</span>
                <button class="close-btn" id="close-dev-modal">&times;</button>
            </div>
            <div class="dev-body">
                <!-- Password section (shown first time) -->
                <div id="dev-auth" class="hidden">
                    <p style="margin-bottom: 15px;">üîí Enter password to unlock Dev Mode</p>
                    <input type="password" id="dev-password" placeholder="Password">
                    <button id="dev-auth-btn">UNLOCK</button>
                </div>

                <!-- Main panel (shown after auth) -->
                <div id="dev-content" class="hidden">
                    <h4>‚ö° CHEATS</h4>
                    <div class="dev-buttons">
                        <button onclick="DevMode.addMoney()">+$100,000</button>
                        <button onclick="DevMode.maxStats()">Max Stats</button>
                        <button onclick="DevMode.advanceYear()">+1 Year</button>
                    </div>

                    <h4>üìä FULL STAT EDITOR</h4>

                    <!-- Money & Time -->
                    <div class="dev-input-row">
                        <label>üí∞ Money:</label>
                        <input type="number" id="dev-money" placeholder="Current: $0">
                        <button onclick="DevMode.setStat('money')">Set</button>
                    </div>
                    <div class="dev-input-row">
                        <label>üìÖ Age (months):</label>
                        <input type="number" id="dev-age" min="0" placeholder="Total months">
                        <button onclick="DevMode.setStat('totalMonths')">Set</button>
                    </div>

                    <!-- Health Stats -->
                    <div class="dev-input-row">
                        <label>üí™ Physical Health:</label>
                        <input type="number" id="dev-phealth" min="0" max="100" placeholder="0-100">
                        <button onclick="DevMode.setStat('physicalHealth')">Set</button>
                    </div>
                    <div class="dev-input-row">
                        <label>üß† Mental Health:</label>
                        <input type="number" id="dev-mhealth" min="0" max="100" placeholder="0-100">
                        <button onclick="DevMode.setStat('mentalHealth')">Set</button>
                    </div>
                    <div class="dev-input-row">
                        <label>üòä Happiness:</label>
                        <input type="number" id="dev-happiness" min="0" max="100" placeholder="0-100">
                        <button onclick="DevMode.setStat('happiness')">Set</button>
                    </div>
                    <div class="dev-input-row">
                        <label>‚ö° Energy:</label>
                        <input type="number" id="dev-energy" min="0" max="100" placeholder="0-100">
                        <button onclick="DevMode.setStat('energy')">Set</button>
                    </div>

                    <!-- Skills -->
                    <div class="dev-input-row">
                        <label>üß† Intelligence:</label>
                        <input type="number" id="dev-int" min="0" max="100" placeholder="0-100">
                        <button onclick="DevMode.setStat('intelligence')">Set</button>
                    </div>
                    <div class="dev-input-row">
                        <label>üìà Experience:</label>
                        <input type="number" id="dev-exp" min="0" placeholder="0+">
                        <button onclick="DevMode.setStat('experience')">Set</button>
                    </div>

                    <!-- Career -->
                    <div class="dev-input-row">
                        <label>üíº Job XP:</label>
                        <input type="number" id="dev-jobxp" min="0" max="100" placeholder="0-100">
                        <button onclick="DevMode.setStat('jobXP')">Set</button>
                    </div>
                    <div class="dev-input-row">
                        <label>üçΩÔ∏è Diet:</label>
                        <select id="dev-diet"
                            style="flex:1; background:#1a1a1a; border:1px solid #00ff00; color:#00ff00; padding:5px; font-family:'Courier New',monospace;">
                            <option value="fast_food">Fast Food</option>
                            <option value="balanced">Balanced</option>
                            <option value="chef">Private Chef</option>
                        </select>
                        <button onclick="DevMode.setStat('diet')">Set</button>
                    </div>

                    <!-- Lifestyle -->
                    <div class="dev-input-row">
                        <label>üè† Housing:</label>
                        <select id="dev-housing"
                            style="flex:1; background:#1a1a1a; border:1px solid #00ff00; color:#00ff00; padding:5px; font-family:'Courier New',monospace;">
                            <option value="couch">Sof√°</option>
                            <option value="studio">Estudio</option>
                            <option value="apartment">Apartamento</option>
                            <option value="house">Casa</option>
                            <option value="mansion">Mansi√≥n</option>
                        </select>
                        <button onclick="DevMode.setStat('housing')">Set</button>
                    </div>
                    <div class="dev-input-row">
                        <label>üöó Vehicle:</label>
                        <select id="dev-vehicle"
                            style="flex:1; background:#1a1a1a; border:1px solid #00ff00; color:#00ff00; padding:5px; font-family:'Courier New',monospace;">
                            <option value="none">A Pie</option>
                            <option value="bike">Bicicleta</option>
                            <option value="scooter">Scooter</option>
                            <option value="car_used">Coche Usado</option>
                            <option value="car_new">Coche Nuevo</option>
                            <option value="luxury">Lujo</option>
                            <option value="jet">Jet</option>
                        </select>
                        <button onclick="DevMode.setStat('vehicle')">Set</button>
                    </div>

                    <h4>üñ•Ô∏è STATE VIEWER</h4>
                    <pre id="dev-state-viewer">// State will appear here</pre>
                    <button class="dev-buttons" onclick="DevMode.refreshState()" style="width:100%;">Refresh
                        State</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE CONFIG ---
        // TODO: Replace with your actual Supabase URL and Key
        const SUPABASE_URL = 'https://ulqifkyuklkjywlpkauw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVscWlma3l1a2xranl3bHBrYXV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyODE0ODQsImV4cCI6MjA4NTg1NzQ4NH0.CVgCUF_Hy06Ks2Q0xyJiKUBsx_G-y5PA59ArRRtLjYE';

        let sb = null;
        try {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
                sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch (e) {
            console.error("Supabase init error:", e);
        }

        // --- 1. CONFIG & DATA ---
        const CONFIG = {
            startAge: 18,
            costOfLiving: 500,
            studyCost: 200,
            baseWage: 0 // Base added to job salary if relevant
        };

        const CHILD_COST = 400; // Monthly cost per child

        const PETS = [
            { id: 'dog', name: 'Perro üê∂', cost: 200, maint: 50, desc: 'Fiel amigo. Evita tristeza extrema.' },
            { id: 'cat', name: 'Gato üê±', cost: 150, maint: 40, desc: 'Independiente. Compa√±√≠a tranquila.' },
            { id: 'hamster', name: 'Hamster üêπ', cost: 50, maint: 10, desc: 'Peque√±o y f√°cil de cuidar.' }
        ];

        const TROPHIES = [
            { id: 'first_million', name: 'Primer Mill√≥n', desc: 'Acumula $1,000,000 en efectivo.', icon: 'üí∞', condition: (s) => s.money >= 1000000 },
            { id: 'marathon', name: 'Maratonista', desc: 'Completa una marat√≥n.', icon: 'üèÉ', condition: (s) => false }, // Manually triggers
            { id: 'ceo', name: 'CEO', desc: 'Alcanza el puesto de CEO.', icon: 'üìà', condition: (s) => s.currJobId === 'tech_cto' || s.currJobId === 'corp_ceo' },
            { id: 'famous_spouse', name: 'Amor Estelar', desc: 'C√°sate con un famoso.', icon: 'üíç', condition: (s) => s.partner && (s.partner.jobTitle.includes('Estrella') || s.partner.jobTitle.includes('Famoso')) && s.partner.status === 'married' },
            { id: 'polymath', name: 'Pol√≠mata', desc: 'Maximea inteligencia y completa 3 cursos.', icon: 'üß†', condition: (s) => s.intelligence >= 100 && s.education.length >= 3 },
            { id: 'centenarian', name: 'Centenario', desc: 'Vive hasta los 100 a√±os.', icon: 'üéÇ', condition: (s) => s.totalMonths >= 1200 }
        ];

        const RARE_ITEMS = [
            { id: 'classic_car', name: 'Ferrari 250 GTO', price: 5000000, desc: 'Una joya cl√°sica √∫nica. (+50 Estatus)', icon: 'üèéÔ∏è', maint: 5000, effect: { type: 'status', val: 50 } },
            { id: 'limited_watch', name: 'Patek Philippe', price: 250000, desc: 'Edici√≥n limitada. (+20 Estatus)', icon: '‚åö', maint: 100, effect: { type: 'status', val: 20 } }
        ];

        const JOBS = [
            // None
            { id: 'unemployed', title: 'Sin Empleo', salary: 0, career: 'none', req: {} },

            // Tech Path (Inteligence Focus)
            { id: 'tech_trainee', title: 'Trainee IT', salary: 800, career: 'tech', req: { int: 20 } },
            { id: 'tech_jr', title: 'Junior Dev', salary: 1500, career: 'tech', req: { int: 40, exp: 5 } },
            { id: 'tech_sr', title: 'Senior Dev', salary: 3500, career: 'tech', req: { int: 70, exp: 20, deg: 'dev_bootcamp' } },
            { id: 'tech_cto', title: 'CTO', salary: 8000, career: 'tech', req: { int: 90, exp: 50, deg: 'dev_bootcamp' } },

            // Corporate Path (Balanced)
            { id: 'corp_assist', title: 'Asistente', salary: 1000, career: 'corp', req: { int: 15, happy: 50 } },
            { id: 'corp_analyst', title: 'Analista', salary: 2000, career: 'corp', req: { int: 40, exp: 10 } },
            { id: 'corp_manager', title: 'Gerente', salary: 4000, career: 'corp', req: { int: 60, exp: 30 } },
            { id: 'corp_ceo', title: 'CEO', salary: 12000, career: 'corp', req: { int: 85, exp: 70, deg: 'mba_biz' } },

            // Sports Path (Health/Energy Focus)
            { id: 'sport_amateur', title: 'Amateur Deport.', salary: 500, career: 'sport', req: { health: 60, energy: 50 } },
            { id: 'sport_pro', title: 'Deportista Pro', salary: 3000, career: 'sport', req: { health: 80, exp: 10 } },
            { id: 'sport_star', title: 'Estrella Mundial', salary: 15000, career: 'sport', req: { health: 95, exp: 40, happy: 70, deg: 'sport_cert' } },
            { id: 'sport_legend', title: 'Leyenda', salary: 25000, career: 'sport', req: { health: 100, exp: 80, deg: 'sport_cert' } }
        ];

        const COURSES = [
            { id: 'dev_bootcamp', title: 'Bootcamp Full Stack', cost: 5000, duration: 6, penalty: 30, degree: 'Dev Certified' },
            { id: 'mba_biz', title: 'MBA Ejecutivo', cost: 15000, duration: 12, penalty: 40, degree: 'Master Business' },
            { id: 'sport_cert', title: 'Certificaci√≥n Entrenador', cost: 3000, duration: 4, penalty: 20, degree: 'Coach Lic.' }

        ];

        const ASSETS = [
            { id: 'stock', name: 'Acciones (S&P)', startPrice: 100, vol: 0.05 },
            { id: 'crypto', name: 'Bitcoin', startPrice: 5000, vol: 0.25 },
            { id: 'gold', name: 'Oro', startPrice: 200, vol: 0.02 }
        ];

        const REAL_ESTATE = [
            { id: 'apt_small', name: 'Apt. Peque√±o', price: 50000, rent: 200, maint: 50 },
            { id: 'house', name: 'Casa Familiar', price: 150000, rent: 650, maint: 150 },
            { id: 'office', name: 'Oficina Comercial', price: 500000, rent: 2200, maint: 600 },
            { id: 'building', name: 'Edificio Residencial', price: 2000000, rent: 9000, maint: 3000 }
        ];

        const SHOP_ITEMS = [
            { id: 'book_stats', name: 'Libros T√©cnicos', price: 150, maint: 0, desc: '+10% ganancia al Estudiar', effect: { type: 'study_boost', val: 1.1 } },
            { id: 'bike', name: 'Bicicleta', price: 300, maint: 0, desc: 'Reduce costos transporte (-$20/mes)', effect: { type: 'col_red', val: 20 } },
            { id: 'phone', name: 'Smartphone Alta Gama', price: 800, maint: 20, desc: '+2 Felicidad/mes', effect: { type: 'happy_boost', val: 2 } },
            { id: 'suit', name: 'Traje Elegante', price: 500, maint: 0, desc: '+10% Salario (Oficina)', effect: { type: 'wage_mult', val: 1.1 } }, // Simplified to all jobs for MVP
            { id: 'laptop', name: 'Laptop Gamer', price: 2000, maint: 0, desc: '+20% Salario (Devs) y Felicidad', effect: { type: 'wage_mult_high', val: 1.2 } },
            { id: 'car', name: 'Autom√≥vil', price: 5000, maint: 200, desc: 'Gran estatus (+5 Felicidad/mes)', effect: { type: 'happy_boost', val: 5 } },
            { id: 'apt', name: 'Apartamento Lujoso', price: 50000, maint: 800, desc: 'Vida de rico. +20 Felicidad/mes', effect: { type: 'happy_boost', val: 20 } }
        ];

        // --- HOUSING OPTIONS ---
        const HOUSING = [
            { id: 'couch', name: 'üõãÔ∏è Sof√° de Amigo', cost: 0, maint: 0, happiness: -10, energyRecovery: -5, status: 0, desc: 'Gratis pero inc√≥modo' },
            { id: 'studio', name: 'üè† Estudio Alquiler', cost: 5000, maint: 800, happiness: 5, energyRecovery: 0, status: 10, desc: 'Tu propio espacio' },
            { id: 'apartment', name: 'üè¢ Apartamento', cost: 50000, maint: 1500, happiness: 15, energyRecovery: 5, status: 30, desc: 'C√≥modo y espacioso' },
            { id: 'house', name: 'üè° Casa Propia', cost: 200000, maint: 2500, happiness: 30, energyRecovery: 10, status: 60, desc: 'El sue√±o americano' },
            { id: 'mansion', name: 'üè∞ Mansi√≥n', cost: 1000000, maint: 8000, happiness: 50, energyRecovery: 20, status: 100, desc: 'Vida de lujo' }
        ];

        // --- VEHICLE OPTIONS ---
        const VEHICLES = [
            { id: 'none', name: 'üö∂ A Pie', cost: 0, maint: 0, energyReduction: 0, status: 0, desc: 'Transporte p√∫blico' },
            { id: 'bike', name: 'üö≤ Bicicleta', cost: 500, maint: 20, energyReduction: 2, status: 5, desc: 'Ecol√≥gico y saludable' },
            { id: 'scooter', name: 'üõµ Scooter', cost: 3000, maint: 100, energyReduction: 5, status: 15, desc: 'R√°pido en la ciudad' },
            { id: 'car_used', name: 'üöó Coche Usado', cost: 15000, maint: 300, energyReduction: 8, status: 25, desc: 'Funcional y confiable' },
            { id: 'car_new', name: 'üöô Coche Nuevo', cost: 40000, maint: 500, energyReduction: 10, status: 50, desc: 'Comodidad moderna' },
            { id: 'luxury', name: 'üèéÔ∏è Coche de Lujo', cost: 150000, maint: 2000, energyReduction: 12, status: 80, desc: 'Estatus y poder' },
            { id: 'jet', name: '‚úàÔ∏è Jet Privado', cost: 5000000, maint: 50000, energyReduction: 15, status: 150, desc: 'El cielo es el l√≠mite' }
        ];

        const TRAITS = [
            { id: 'genius', name: 'üß† Genio', desc: '+50% Int gain, -10% Happiness max', effect: { stat: 'intelligence', mult: 1.5 } },
            { id: 'athlete', name: 'üèÉ Atleta', desc: '+Salud gain, +Energy cost', effect: { stat: 'health', mult: 1.2 } },
            { id: 'charismatic', name: 'üó£Ô∏è Carism√°tico', desc: 'Networking m√°s f√°cil', effect: { stat: 'social', mult: 1.3 } },
            { id: 'sickly', name: 'ü§í Enfermizo', desc: '-Salud max, -Salud gain', effect: { stat: 'health', mult: 0.8 } },
            { id: 'lucky', name: 'üçÄ Afortunado', desc: 'M√°s eventos buenos', effect: { stat: 'luck', mult: 1.2 } },
            { id: 'bookworm', name: 'üìö Rat√≥n de Biblioteca', desc: 'Estudiar cuesta menos energ√≠a', effect: { stat: 'studyCost', mult: 0.8 } }
        ];

        const PROJECT_TYPES = [
            { id: 'youtube', name: 'Canal de YouTube', cost: 100, duration: 6, penalty: 10, req: { intelligence: 10 }, desc: 'Diversi√≥n y vlog. Bajo costo.' },
            { id: 'book', name: 'Escribir Libro', cost: 50, duration: 12, penalty: 20, req: { intelligence: 40 }, desc: 'Novela o ensayo. Requiere dedicaci√≥n.' },
            { id: 'app', name: 'Desarrollar App', cost: 500, duration: 18, penalty: 30, req: { intelligence: 70 }, desc: 'Alta tecnolog√≠a. Alto potencial.' }
        ];

        // --- ELITE EVENTS ---
        const ELITE_EVENTS = [
            {
                id: 'business_dinner',
                minStatus: 100,
                text: 'üç∑ Cena de Negocios: Un CEO te invita a cenar.',
                effect: () => {
                    if (Math.random() > 0.5) {
                        return { money: 5000, msg: 'Hiciste contactos valiosos. +$5000', type: 'good' };
                    } else {
                        return { experience: 10, msg: 'Aprendiste de los mejores. +10 Exp', type: 'good' };
                    }
                }
            },
            {
                id: 'yacht_party',
                minStatus: 150,
                text: 'üõ•Ô∏è Fiesta en Yate: Invitaci√≥n exclusiva.',
                effect: () => {
                    return { happiness: 20, msg: 'Conociste gente influyente. +20 Felicidad', type: 'good' };
                }
            },
            {
                id: 'investment_tip',
                minStatus: 120,
                text: 'üíº Tip de Inversi√≥n: Un magnate comparte un secreto.',
                effect: () => {
                    return { money: 10000, msg: 'Invertiste sabiamente. +$10,000', type: 'good' };
                }
            },
            {
                id: 'exclusive_club',
                minStatus: 180,
                text: 'üé© Club Exclusivo: Te invitan a un club privado.',
                effect: () => {
                    return { happiness: 15, experience: 5, msg: 'Networking de √©lite. +Exp +Felicidad', type: 'good' };
                }
            }
        ];

        // --- EVENTS DB ---
        const EVENTS = [
            // Instant Events
            { id: 1, type: 'instant', text: "Encontraste $50 en el suelo.", effect: (s) => ({ money: 50, msg: "¬°Suerte! +$50", type: 'good' }) },
            { id: 2, type: 'instant', text: "Perdiste tu billetera.", effect: (s) => ({ money: -100, happiness: -5, msg: "Qu√© mala suerte. -$100", type: 'bad' }) },
            { id: 3, type: 'instant', text: "Te enfermaste de gripe.", effect: (s) => ({ mentalHealth: -5, physicalHealth: -10, energy: -20, msg: "Gripe fuerte. -Salud, -Energ√≠a", type: 'bad' }) },
            { id: 4, type: 'instant', text: "Un amigo te invita a cenar.", condition: s => s.friends.length > 0, effect: (s) => ({ happiness: 10, msg: "Cena gratis. +Felicidad", type: 'good' }) },
            { id: 5, type: 'instant', text: "Tu ropa se rompi√≥.", effect: (s) => ({ money: -50, msg: "Gastos de ropa. -$50", type: 'bad' }) },

            // Choice Events
            {
                id: 6, type: 'choice', text: "Te ofrecen un 'negocio' r√°pido pero dudoso.",
                choices: [
                    {
                        text: "Aceptar (Riesgo)", sub: "Ganar mucho o perder mucho", action: (s) => {
                            return Math.random() > 0.5
                                ? { money: 1000, msg: "¬°Sali√≥ bien! Ganaste $1000", type: 'good' }
                                : { money: -500, happiness: -10, msg: "Era una estafa. Perdiste $500", type: 'bad' };
                        }
                    },
                    { text: "Rechazar", sub: "Mejor prevenir", action: (s) => ({ happiness: 2, msg: "Evitaste problemas.", type: 'info' }) }
                ]
            },
            {
                id: 7, type: 'choice', text: "Tu jefe te pide trabajar horas extra no pagadas.",
                condition: s => s.currJobId !== 'unemployed',
                choices: [
                    { text: "Hacerlo", sub: "Ganas experiencia, pierdes energ√≠a", action: (s) => ({ experience: 2, energy: -30, happiness: -5, msg: "Tu jefe lo valora. +Exp", type: 'info' }) },
                    { text: "Negarse", sub: "Mantienes dignidad", action: (s) => ({ happiness: 5, msg: "Te respetaste a ti mismo. +Felicidad", type: 'good' }) }
                ]
            },
            {
                id: 8, type: 'choice', text: "Oferta de curso online con descuento.",
                choices: [
                    {
                        text: "Comprar ($150)", sub: "+Inteligencia", action: (s) => {
                            if (s.money < 150) return { msg: "No tienes dinero suficiente.", type: 'bad' };
                            return { money: -150, intelligence: 5, msg: "Aprendiste mucho. +Int", type: 'good' };
                        }
                    },
                    { text: "No gracias", sub: "Ahorrar dinero", action: (s) => ({ msg: "Pasaste la oferta.", type: 'info' }) }
                ]
            },
            {
                id: 9, type: 'choice', text: "Un mendigo te pide ayuda.",
                choices: [
                    {
                        text: "Dar $10", sub: "Te sientes bien", action: (s) => {
                            if (s.money < 10) return { msg: "No tienes cambio.", type: 'info' };
                            return { money: -10, happiness: 5, msg: "Ayudaste a alguien. +Felicidad", type: 'good' };
                        }
                    },
                    { text: "Ignorar", sub: "Nada cambia", action: (s) => ({ msg: "Seguiste caminando.", type: 'info' }) }
                ]
            },
            {
                id: 10, type: 'choice', text: "Encuentras un gatito abandonado.",
                condition: s => !s.pets.some(p => p.id === 'cat_stray'),
                choices: [
                    {
                        text: "Adoptarlo ($50/mes)", sub: "+Felicidad constante, -Dinero", action: (s) => {
                            state.pets.push({ id: 'cat_stray', name: 'Gato Callejero' });
                            return { money: -100, happiness: 15, msg: "Tienes nueva mascota (Gastos vet -$100).", type: 'good' };
                        }
                    },
                    { text: "Llevarlo a refugio", sub: "Haces lo correcto", action: (s) => ({ happiness: 2, msg: "El gatito est√° a salvo.", type: 'info' }) }
                ]
            },

            // --- SOCIAL EVENTS EXPANSION ---
            // 1. Emergency: Friend Loan
            {
                id: 11, type: 'choice', text: "¬°Emergencia! Un amigo necesita dinero urgente.",
                condition: (s) => s.friends.length > 0 && s.money > 200,
                choices: [
                    {
                        text: "Prestar $200", sub: "Es riesgoso pero amable", action: (s) => {
                            const friend = s.friends[Math.floor(Math.random() * s.friends.length)];
                            friend.relation = Math.min(100, friend.relation + 20);
                            return { money: -200, happiness: 5, msg: `Le prestaste a ${friend.name}. Te lo agradece mucho.`, type: 'good' };
                        }
                    },
                    {
                        text: "Negarte", sub: "Cuidar tu dinero", action: (s) => {
                            const friend = s.friends[Math.floor(Math.random() * s.friends.length)];
                            friend.relation -= 15;
                            return { happiness: -5, msg: `${friend.name} se decepcion√≥ de ti.`, type: 'bad' };
                        }
                    }
                ]
            },
            // 2. Wedding Invitation
            {
                id: 12, type: 'choice', text: "Boda de tu mejor amigo. ¬øAsistir?",
                condition: (s) => s.friends.length > 0 && s.money > 500,
                choices: [
                    {
                        text: "¬°S√≠! (Regalo $500)", sub: "Fiesta y alegr√≠a", action: (s) => {
                            const friend = s.friends[0]; // Best friend usually first or random
                            friend.relation = Math.min(100, friend.relation + 15);
                            return { money: -500, happiness: 20, msg: "¬°Qu√© gran boda! Bailaste toda la noche.", type: 'good' };
                        }
                    },
                    {
                        text: "No ir", sub: "Ahorrar ($500)", action: (s) => {
                            const friend = s.friends[0];
                            friend.relation -= 25;
                            return { happiness: -10, msg: "Tu amigo no te lo perdonar√° pronto.", type: 'bad' };
                        }
                    }
                ]
            },
            // 3. Family Drama
            {
                id: 13, type: 'choice', text: "Tus padres tienen una emergencia m√©dica.",
                condition: (s) => s.money > 1000,
                choices: [
                    { text: "Ayudar ($1000)", sub: "Es tu familia", action: (s) => ({ money: -1000, happiness: 10, msg: "Hiciste lo correcto. Se est√°n recuperando.", type: 'good' }) },
                    { text: "No puedo", sub: "La econom√≠a est√° mal", action: (s) => ({ happiness: -20, mentalHealth: -10, msg: "La culpa te carcome.", type: 'bad' }) }
                ]
            },
            // 4. Child Milestone
            {
                id: 14, type: 'instant', text: "¬°Tu hijo trajo buenas notas!",
                condition: (s) => s.children.length > 0,
                effect: (s) => {
                    const child = s.children[Math.floor(Math.random() * s.children.length)];
                    return { happiness: 15, msg: `¬°Orgullo de padre/madre! ${child.name} es brillante.`, type: 'good' };
                }
            },
            {
                id: 15, type: 'instant', text: "Tu hijo hizo un dibujo de la familia.",
                condition: (s) => s.children.length > 0,
                effect: (s) => ({ happiness: 10, msg: "Lo pegaste en la nevera. Qu√© tierno.", type: 'good' })
            },
            // 5. Old Friend Reconnect
            {
                id: 16, type: 'instant', text: "Un viejo amigo te escribi√≥.",
                condition: (s) => s.friends.length > 0,
                effect: (s) => {
                    const f = s.friends[Math.floor(Math.random() * s.friends.length)];
                    f.relation += 10;
                    return { happiness: 5, msg: `Chat con ${f.name} reaviv√≥ la amistad.`, type: 'good' };
                }
            }
        ];

        // --- 2. GAME STATE ---
        let state = {
            totalMonths: 0,
            money: 600,
            physicalHealth: 100,
            mentalHealth: 100,
            happiness: 100,
            diet: 'balanced', // fast_food, balanced, chef
            intelligence: 10,
            energy: 100,
            experience: 0,
            jobXP: 0,
            promotions: 0,
            currJobId: 'unemployed', // Current job ID
            education: [],
            activeCourse: null,
            activeProject: null, // { id, name, typeId, progress, duration, penalty }
            creations: [], // { name, type, royalty, quality }
            inventory: [],
            consecutiveWork: 0,
            sickDuration: 0,
            portfolio: { stock: { qty: 0, avg: 0 }, crypto: { qty: 0, avg: 0 }, gold: { qty: 0, avg: 0 } },
            marketPrices: { stock: 100, crypto: 5000, gold: 200 },
            realEstate: [], // Array of owned IDs
            rePrices: {}, // Dynamic prices for RE
            pendingEvent: null, // { id, timer }
            financialFreedom: false,
            friends: [], // {id, name, jobTitle, relation, bonusJobId}
            partner: null, // {name, salary, relation, status: 'dating'|'living'|'married', jobTitle}
            children: [], // { name, ageMonths, gender }
            pets: [], // { id, name }
            housing: 'couch', // Current housing ID
            vehicle: 'none', // Current vehicle ID
            status: 0 // Social status (0-250+)
        };

        // Init RE Prices if empty
        REAL_ESTATE.forEach(re => {
            if (!state.rePrices[re.id]) state.rePrices[re.id] = re.price;
        });

        // Load Legacy
        const legacyData = JSON.parse(localStorage.getItem('lifeSim_legacy'));
        if (legacyData) {
            if (legacyData.type === 'money') state.money += legacyData.val;
            if (legacyData.type === 'genetics') state.intelligence += legacyData.val;
            console.log("Legacy loaded:", legacyData);
            // Clear legacy after loading so it's one-time use
            localStorage.removeItem('lifeSim_legacy');
        }

/*      // --- 4. GAME CONTROLLER ---
        const Game = {
            init() {
                const charGen = document.getElementById('char-gen-screen');
                const mainUI = document.getElementById('main-ui');

                // If new game (no months) and no attributes selected, show CharGen
                // We check state.traits length to see if already generated.
                if (state.totalMonths === 0 && (!state.traits || state.traits.length === 0)) {
                    charGen.classList.remove('hidden');
                    mainUI.classList.add('hidden');
                    charGen.style.display = 'flex';
                    this.generateCharacter();
                } else {
                    // Loaded game or already generated
                    charGen.classList.add('hidden');
                    charGen.style.display = 'none';
                    mainUI.classList.remove('hidden');
                    // this.startInterval(); // Optional auto-play
                }

                UI.render();
            },

            generateCharacter() {
                // 1. Pick 2 unique traits
                let available = [...TRAITS];
                let picks = [];
                for (let i = 0; i < 2; i++) {
                    const idx = Math.floor(Math.random() * available.length);
                    picks.push(available[idx]);
                    available.splice(idx, 1);
                }

                // 2. Pick Background
                const rand = Math.random();
                let bg = 'normal';
                let bgText = "Normal: Ahorros modestos ($1,000)";

                if (rand < 0.3) {
                    bg = 'debt'; // -$5000
                    bgText = "Deuda Estudiantil: Comienzas debiendo $5,000";
                } else if (rand > 0.8) {
                    bg = 'rich'; // $5000
                    bgText = "Peque√±a Herencia: Recibes $5,000";
                }

                // Temporary storage
                this._tempChar = { traits: picks.map(t => t.id), bg: bg };

                // Render
                const tContainer = document.getElementById('char-traits');
                tContainer.innerHTML = picks.map(t => `
                    <div style="background:#333; padding:10px; border-radius:5px;">
                        <div style="color:#fff; font-weight:bold;">${t.name}</div>
                        <div style="font-size:0.8rem; color:#ccc;">${t.desc}</div>
                    </div>
                `).join('');

                const bgContainer = document.getElementById('char-bg');
                bgContainer.innerHTML = bgText;
                bgContainer.style.color = bg === 'debt' ? '#ff5555' : (bg === 'rich' ? '#4dffea' : '#fff');
            },

            confirmStart() {
                if (!this._tempChar) return;

                state.traits = this._tempChar.traits;
                state.background = this._tempChar.bg;

                // Apply Money
                if (state.background === 'debt') state.money = -5000;
                else if (state.background === 'rich') state.money = 5000;
                else state.money = 1000;

                // UI Transition
                document.getElementById('char-gen-screen').style.display = 'none';
                document.getElementById('main-ui').classList.remove('hidden');

                UI.log("¬°Nueva vida comenzada!", "good");
                UI.render();
            },
            */ const UI = {
            els: {
                date: document.getElementById('date-display'),
                money: document.getElementById('money-display'),
                jobTitle: document.getElementById('job-title-display'),
                jobTrigger: document.getElementById('job-trigger'),
                bars: {
                    health: document.getElementById('health-bar'),
                    happy: document.getElementById('happiness-bar'),
                    energy: document.getElementById('energy-bar'),
                    intel: document.getElementById('intel-bar'),
                    mhealth: document.getElementById('mhealth-bar')
                },
                vals: {
                    health: document.getElementById('health-val'),
                    happy: document.getElementById('happiness-val'),
                    energy: document.getElementById('energy-val'),
                    intel: document.getElementById('intel-val'),
                    mhealth: document.getElementById('mhealth-val')
                },
                log: document.getElementById('event-log'),
                btns: {
                    work: document.getElementById('btn-work'),
                    study: document.getElementById('btn-study'),
                    rest: document.getElementById('btn-rest'),
                    next: document.getElementById('btn-next'),
                    settings: document.getElementById('settings-trigger')
                },
                modals: {
                    job: document.getElementById('job-modal'),
                    jobList: document.getElementById('job-list-container'),
                    closeJob: document.getElementById('close-job-modal'),
                    settings: document.getElementById('settings-modal'),
                    closeSettings: document.getElementById('close-settings-modal'),
                    event: document.getElementById('event-modal'),
                    eventText: document.getElementById('event-text'),
                    eventChoices: document.getElementById('event-choices'),
                    shop: document.getElementById('shop-modal'),
                    shopList: document.getElementById('shop-list-container'),
                    closeShop: document.getElementById('close-shop-modal'),
                    shopBtn: document.getElementById('shop-trigger'),
                    act: document.getElementById('activity-modal'),
                    closeAct: document.getElementById('close-act-modal'),
                    closeAct: document.getElementById('close-act-modal'),
                    endGame: document.getElementById('end-game-modal'),
                    endSummary: document.getElementById('end-game-summary'),
                    endScore: document.getElementById('end-game-score'),
                    alert: document.getElementById('alert-modal'),
                    alertTitle: document.getElementById('alert-title'),
                    alertMsg: document.getElementById('alert-msg'),
                    alertBtn: document.getElementById('alert-ok-btn')
                },
                auth: {
                    section: document.getElementById('auth-section'),
                    form: document.getElementById('auth-form'),
                    userInfo: document.getElementById('user-info'),
                    email: document.getElementById('user-email'),
                    msg: document.getElementById('auth-msg'),
                    loginBtn: document.getElementById('btn-login'),
                    logoutBtn: document.getElementById('btn-logout'),
                    emailInput: document.getElementById('email-input'),
                    passInput: document.getElementById('pass-input'),
                    saveBtn: document.getElementById('btn-save'),
                    loadBtn: document.getElementById('btn-load'),
                    saveMsg: document.getElementById('save-msg')
                }
            },

            render() {
                // Date
                const totalM = (CONFIG.startAge * 12) + state.totalMonths;
                const yrs = Math.floor(totalM / 12);
                const mos = (totalM % 12) + 1;
                this.els.date.innerText = `A√±o ${yrs} - Mes ${mos}`;

                this.els.date.innerText = `A√±o ${yrs} - Mes ${mos}`;

                // Money Animation
                this.animateNumber(this.els.money, parseInt(this.els.money.innerText.replace(/[^0-9-]/g, '')) || 0, state.money);

                // Finance Panel
                const fin = Game.calculateFinancials();
                document.getElementById('networth-val').innerText = `$${Math.floor(fin.netWorth).toLocaleString()}`;

                // Color passive income
                const piEl = document.getElementById('income-passive');
                piEl.innerText = `$${Math.floor(fin.passiveIncome)}/m`;

                const aiEl = document.getElementById('income-active');
                aiEl.innerText = `$${Math.floor(fin.activeIncome)}/m`;

                // Bars
                const safeNet = Math.max(1, fin.netWorth); // Avoid /0
                const cashPct = Math.max(0, (fin.cash / safeNet) * 100);
                const invPct = Math.max(0, (fin.investments / safeNet) * 100);
                const rePct = Math.max(0, (fin.realEstate / safeNet) * 100);

                const bar = document.getElementById('fn-asset-bar');
                bar.children[0].style.width = `${cashPct}%`;
                bar.children[1].style.width = `${invPct}%`;
                bar.children[2].style.width = `${rePct}%`;

                // Achievement Check
                if (fin.passiveIncome >= fin.expenses && !state.financialFreedom) {
                    state.financialFreedom = true;
                    this.showAlert("¬°LIBERTAD FINANCIERA! üöÄ", "Tus ingresos pasivos superan tus gastos. ¬°Eres libre!");
                }

                // Job
                const job = JOBS.find(j => j.id === state.currJobId) || JOBS[0];
                this.els.jobTitle.innerText = `${job.title} ($${job.salary}/mes)`;
                // XP Bar
                document.getElementById('job-xp-bar').style.width = `${state.jobXP}%`;

                // Calculate Energy Cost for display (optional, but good for UX)
                let energyCost = Math.max(10, 30 - (state.promotions * 2));
                const workBtnIcon = this.els.btns.work.querySelector('.btn-icon');

                // Diploma Display
                const diploContainer = document.getElementById('diploma-display');
                if (state.education && state.education.length > 0) {
                    diploContainer.innerHTML = 'üéì ' + state.education.map(d => COURSES.find(c => c.id === d)?.degree || d).join(', ');
                } else {
                    diploContainer.innerHTML = '';
                }

                // Active Course Status (in log or header? header is full. maybe just toast logic on nextMonth)

                // Bars

                // Bars
                const setBar = (type, val, max = 100) => {
                    const pct = Math.min(100, Math.max(0, (val / max) * 100));
                    this.els.bars[type].style.width = `${pct}%`;
                    this.els.vals[type].innerText = type === 'intel' ? val : `${Math.floor(val)}%`;
                };

                setBar('health', state.physicalHealth);
                if (state.physicalHealth < 20) this.els.bars.health.classList.add('critical');
                else this.els.bars.health.classList.remove('critical');

                setBar('mhealth', state.mentalHealth);
                if (state.mentalHealth < 20) this.els.bars.mhealth.classList.add('critical');
                else this.els.bars.mhealth.classList.remove('critical');

                setBar('happy', state.happiness);
                setBar('energy', state.energy);
                setBar('intel', state.intelligence, 100);

                // Button States (Energy Check)
                const hasEnergy = state.energy >= 20;
                const isSick = state.sickDuration > 0;

                this.els.btns.work.disabled = !hasEnergy || isSick;
                this.els.btns.study.disabled = !hasEnergy; // This is now 'Mejorar' btn
                this.els.btns.rest.disabled = state.energy >= 100;

                if (isSick) {
                    this.els.btns.work.innerHTML = '<span class="btn-icon">ü§í</span>Enfermo';
                } else {
                    this.els.btns.work.innerHTML = '<span class="btn-icon">üíº</span>Trabajar';
                }

                // Auto Scroll
                setTimeout(() => {
                    this.els.log.scrollTop = this.els.log.scrollHeight;
                }, 50);
            },

            log(msg, type = 'normal') {
                const card = document.createElement('div');
                card.className = `event-card ${type}`;
                const totalM = (CONFIG.startAge * 12) + state.totalMonths;
                const yrs = Math.floor(totalM / 12);
                const mos = (totalM % 12) + 1;

                card.innerHTML = `<span class="event-date">A√±o ${yrs}/${mos}</span>${msg}`;
                this.els.log.appendChild(card);

                if (type === 'bad') {
                    AudioSys.playBad();
                    Haptics.error();
                }
            },

            floatText(text, color) {
                const el = document.createElement('div');
                el.className = 'float-text';
                el.innerText = text;
                el.style.color = color;
                el.style.left = (50 + (Math.random() * 20 - 10)) + '%';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 1300);
            },

            flashMoney(amount) {
                const el = this.els.money;
                const isGain = amount > 0;
                el.classList.remove('gain', 'loss');
                void el.offsetWidth;
                el.classList.add(isGain ? 'gain' : 'loss');

                const color = isGain ? '#39FF14' : '#FF3939';
                const sign = isGain ? '+' : '';
                this.floatText(`${sign}$${Math.abs(amount)}`, color);
            },

            updateAuthUI(user) {
                if (user) {
                    this.els.auth.form.classList.add('hidden');
                    this.els.auth.userInfo.classList.remove('hidden');
                    this.els.auth.email.innerText = user.email;
                    this.els.auth.saveBtn.disabled = false;
                    this.els.auth.loadBtn.disabled = false;
                    this.els.auth.saveMsg.innerText = "Sesi√≥n activa.";
                    this.els.auth.saveMsg.style.color = "#4dffea";
                } else {
                    this.els.auth.form.classList.remove('hidden');
                    this.els.auth.userInfo.classList.add('hidden');
                    this.els.auth.email.innerText = "";
                    this.els.auth.saveBtn.disabled = true;
                    this.els.auth.loadBtn.disabled = true;
                    this.els.auth.saveMsg.innerText = "Inicia sesi√≥n para guardar.";
                    this.els.auth.saveMsg.style.color = "#888";
                }
            },

            animateNumber(el, start, end) {
                if (start === end) return;
                const duration = 500;
                const startTime = performance.now();

                const step = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    // Ease out quart
                    const ease = 1 - Math.pow(1 - progress, 4);

                    const current = Math.floor(start + (end - start) * ease);
                    el.innerText = `$${current.toLocaleString()}`;

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        el.innerText = `$${end.toLocaleString()}`; // Ensure final value
                    }
                };
                requestAnimationFrame(step);
            },

            showAlert(title, msg, callback) {
                this.els.modals.alertTitle.innerText = title;
                this.els.modals.alertMsg.innerText = msg;
                this.els.modals.alert.classList.add('active');
                this.els.modals.alertBtn.onclick = () => {
                    this.els.modals.alert.classList.remove('active');
                    if (callback) callback();
                };
            },

            switchShopTab(tab) {
                const goods = document.getElementById('shop-tab-goods');
                const invest = document.getElementById('shop-tab-invest');
                const re = document.getElementById('shop-tab-realestate');
                const btns = document.querySelectorAll('.tab-btn'); // Note: this selects ALL tab-btns globally not scoped.
                // Fixing selector to be scoped to shop modal manually/implicitly by order or ID would be better but for now carefully indexing

                // Let's rely on event.target logic or explicit IDs in future. For now, we know the Shop ones are first rendered?
                // Actually with Act Modal also having tabs, querySelectorAll('.tab-btn') gets ALL active tabs.
                // We better Scope this or use specific IDs for buttons.
                // IMPORTANT: Since we added tabs to Act Modal, we need to be careful.
                // Refactoring to simple ID toggling to be safe.

                const shopBtns = document.getElementById('shop-modal').querySelectorAll('.tab-btn');

                goods.classList.add('hidden');
                invest.classList.add('hidden');
                re.classList.add('hidden');
                shopBtns.forEach(b => b.classList.remove('active'));

                if (tab === 'goods') {
                    goods.classList.remove('hidden');
                    shopBtns[0].classList.add('active');
                } else if (tab === 'invest') {
                    invest.classList.remove('hidden');
                    shopBtns[1].classList.add('active');
                    this.renderInvestments();
                } else if (tab === 'realestate') {
                    re.classList.remove('hidden');
                    shopBtns[2].classList.add('active');
                    this.renderRealEstate();
                }
            },

            switchLifestyleTab(tab) {
                const housingTab = document.getElementById('lifestyle-tab-housing');
                const vehiclesTab = document.getElementById('lifestyle-tab-vehicles');
                const housingBtn = document.getElementById('tab-housing');
                const vehiclesBtn = document.getElementById('tab-vehicles');

                // Hide all tabs
                housingTab.classList.add('hidden');
                vehiclesTab.classList.add('hidden');

                // Remove active from all buttons
                housingBtn.classList.remove('active');
                vehiclesBtn.classList.remove('active');

                // Show selected tab
                if (tab === 'housing') {
                    housingTab.classList.remove('hidden');
                    housingBtn.classList.add('active');
                } else if (tab === 'vehicles') {
                    vehiclesTab.classList.remove('hidden');
                    vehiclesBtn.classList.add('active');
                } else if (tab === 'pets') {
                    document.getElementById('lifestyle-tab-pets').classList.remove('hidden');
                    document.getElementById('tab-pets').classList.add('active');
                }
            },

            switchActTab(tab) {
                const courses = document.getElementById('act-tab-courses');
                const projects = document.getElementById('act-tab-projects');
                const crime = document.getElementById('act-tab-crime');
                const social = document.getElementById('act-tab-social');
                const actBtns = document.getElementById('activity-modal').querySelectorAll('.tab-btn');

                courses.classList.add('hidden');
                projects.classList.add('hidden');
                crime.classList.add('hidden');
                social.classList.add('hidden');
                actBtns.forEach(b => b.classList.remove('active'));

                if (tab === 'courses') {
                    courses.classList.remove('hidden');
                    actBtns[0].classList.add('active');
                    Game.renderCourses(); // Helper to re-render courses
                } else if (tab === 'projects') {
                    projects.classList.remove('hidden');
                    actBtns[1].classList.add('active');
                    this.renderProjects();
                } else if (tab === 'crime') {
                    crime.classList.remove('hidden');
                    actBtns[2].classList.add('active');
                    // No dynamic render needed for now, static buttons
                } else {
                    social.classList.remove('hidden');
                    actBtns[3].classList.add('active');
                    this.renderSocialTab();
                }
            },

            renderProjects() {
                const container = document.getElementById('projects-container');
                container.innerHTML = '';

                // 1. Active Project
                if (state.activeProject) {
                    const p = state.activeProject;
                    const el = document.createElement('div');
                    el.className = 'project-card active';
                    el.style.cssText = "background:#222; padding:15px; border-radius:8px; border:1px solid #FFD700; margin-bottom:20px;";

                    const progressPct = (p.progress / p.duration) * 100;

                    el.innerHTML = `
                        <div style="font-weight:bold; color:#FFD700; margin-bottom:5px;">Proyecto Activo: ${p.name}</div>
                        <div style="font-size:0.9rem; color:#aaa; margin-bottom:10px;">Progreso: ${p.progress}/${p.duration} meses</div>
                        <div style="background:#444; height:10px; border-radius:5px; overflow:hidden;">
                            <div style="background:#FFD700; height:100%; width:${progressPct}%"></div>
                        </div>
                        <div style="font-size:0.8rem; color:#888; margin-top:5px;">Penalizaci√≥n Energ√≠a: -${p.penalty}</div>
                     `;
                    container.appendChild(el);
                } else {
                    // Start New Project List
                    const header = document.createElement('h4');
                    header.innerText = "Iniciar Nuevo Proyecto";
                    header.style.cssText = "color:#aaa; border-bottom:1px solid #333; padding-bottom:5px; margin-top:0;";
                    container.appendChild(header);

                    PROJECT_TYPES.forEach(type => {
                        const btn = document.createElement('button');
                        btn.className = 'act-btn';
                        btn.onclick = () => Game.startProject(type.id);
                        btn.innerHTML = `
                            <div class="act-info">
                                <h4>${type.name}</h4>
                                <p>${type.desc}</p>
                                <p style="font-size:0.8rem; color:#aaa;">Req: ${type.req.intelligence || 0} Int</p>
                            </div>
                            <div class="act-cost">
                                -$${type.cost}<br>
                                -${type.penalty} E/m
                            </div>
                        `;
                        container.appendChild(btn);
                    });
                }

                // 2. Creations List
                if (state.creations.length > 0) {
                    const header = document.createElement('h4');
                    header.innerText = "Tus Creaciones üé®";
                    header.style.cssText = "margin-top:20px; color:#aaa; border-bottom:1px solid #333; padding-bottom:5px;";
                    container.appendChild(header);

                    state.creations.forEach(c => {
                        const el = document.createElement('div');
                        el.className = 'creation-item';
                        el.style.cssText = "display:flex; justify-content:space-between; align-items:center; background:#1a1a1a; padding:10px; margin-bottom:5px; border-radius:5px;";
                        el.innerHTML = `
                            <div>
                                <div style="color:#fff; font-weight:bold;">${c.name}</div>
                                <div style="font-size:0.8rem; color:#888;">${c.quality} | ${c.type}</div>
                            </div>
                            <div style="color:#4dffea; font-family:monospace;">+$${c.royalty}/mes</div>
                         `;
                        container.appendChild(el);
                    });
                }
            },

            renderSocialTab() {
                const list = document.getElementById('friends-list');
                list.innerHTML = '';

                // --- PARTNER SECTION ---
                const pSection = document.createElement('div');
                pSection.style.cssText = "border-bottom: 1px solid #444; margin-bottom: 15px; padding-bottom: 10px;";

                if (!state.partner) {
                    pSection.innerHTML = `
                        <h4 style="color:#aaa; margin-top:0;">Situaci√≥n Sentimental</h4>
                        <div class="market-card" style="justify-content:center; padding: 20px;">
                            <button class="act-btn" style="width:100%;" onclick="Game.findLove()">
                                Buscar Pareja ‚ô• ($100)
                            </button>
                        </div>
                    `;
                } else {
                    const p = state.partner;
                    const statusLabels = { 'dating': 'Saliendo', 'living': 'Conviviendo', 'married': 'Casados' };
                    let nextStepBtn = '';

                    if (p.status === 'dating' && p.relation > 60) {
                        nextStepBtn = `<button class="act-btn" style="flex:1; background:#00bcd4;" onclick="Game.advanceRel()">Mudarse Juntos</button>`;
                    } else if (p.status === 'living' && p.relation > 90) {
                        nextStepBtn = `<button class="act-btn" style="flex:1; background:#ff9800;" onclick="Game.advanceRel()">Proponer Matrimonio ($2k)</button>`;
                    }

                    pSection.innerHTML = `
                        <h4 style="color:#aaa; margin-top:0;">üíï Pareja: ${statusLabels[p.status]}</h4>
                        <div class="market-card" style="display:block;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <div>
                                    <div style="font-weight:bold; color:#ff69b4;">${p.name}</div>
                                    <div style="font-size:0.8rem; color:#aaa;">${p.jobTitle} ($${p.salary}/m)</div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:0.9rem;">Relaci√≥n: ${p.relation}%</div>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button class="act-btn" style="flex:1;" onclick="Game.datePartner()">Cita ($80)</button>
                                ${nextStepBtn}
                                <button class="act-btn" style="flex:1; background:#552222;" onclick="Game.breakup()">Romper</button>
                            </div>
                        </div>
                    `;
                }
                list.appendChild(pSection);

                // --- CHARITY ---
                const charity = document.createElement('div');
                charity.style.marginTop = "20px";
                charity.innerHTML = `
                    <h4 style="color:#aaa; border-bottom:1px solid #333; padding-bottom:5px;">Filantrop√≠a</h4>
                     <button class="act-btn" onclick="Game.donateCharity(100)">
                        <div class="act-info">
                            <h4>Donar $100</h4>
                            <p>Ayuda a los necesitados.</p>
                        </div>
                        <div class="act-cost">+1 Karma</div>
                    </button>
                    <button class="act-btn" onclick="Game.donateCharity(1000)">
                        <div class="act-info">
                            <h4>Donar $1,000</h4>
                            <p>Haz una gran diferencia.</p>
                        </div>
                        <div class="act-cost">+10 Karma</div>
                    </button>
                `;
                list.appendChild(charity);

                // --- FRIENDS SECTION ---
                const fHeader = document.createElement('h4');
                fHeader.innerText = "Amigos & Contactos";
                fHeader.style.color = "#aaa";
                list.appendChild(fHeader);

                if (state.friends.length === 0) {
                    const empty = document.createElement('p');
                    empty.className = 'status-msg';
                    empty.innerText = 'No tienes amigos. ¬°Sal de fiesta!';
                    list.appendChild(empty);
                } else {
                    state.friends.forEach(f => {
                        const isNet = f.relation > 80;

                        const el = document.createElement('div');
                        el.className = 'market-card';
                        el.innerHTML = `
                       <div>
                           <div style="font-weight:bold; color:#fff;">${f.name} ${isNet ? '‚≠ê' : ''}</div>
                           <div style="font-size:0.8rem; color:#aaa;">${f.jobTitle}</div>
                           <div style="font-size:0.75rem; color:${isNet ? '#4dffea' : '#888'};">Relaci√≥n: ${f.relation}/100</div>
                       </div>
                       <button class="act-btn" style="width:auto; min-height:auto; padding:5px 10px; font-size:0.8rem;" onclick="Game.maintainFriend('${f.id}')">
                           Llamar ($50)
                       </button>
                    `;
                        list.appendChild(el);
                    });
                }
            },

            renderRealEstate() {
                const container = document.getElementById('realestate-list-container');
                container.innerHTML = '';

                REAL_ESTATE.forEach(prop => {
                    // Check how many we own of this type (initially designed as unique in plan but lets support multiples or just one logic? 
                    // Plan said "Array of strings (IDs)". If we allow multiple, we count them.
                    const ownedCount = state.realEstate.filter(id => id === prop.id).length;
                    const currentPrice = state.rePrices[prop.id];

                    // Net Income calc
                    const net = prop.rent - prop.maint;

                    const el = document.createElement('div');
                    el.className = 'market-card';
                    el.style.cssText = "display:flex; flex-direction:column; align-items:flex-start; margin-bottom:10px; padding:10px; background:#1e1e1e; border:1px solid #444; border-radius:6px;";

                    el.innerHTML = `
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center; margin-bottom:5px;">
                            <span style="font-weight:bold; color:#fff; font-size:1rem;">${prop.name}</span>
                            <span style="color:var(--accent-color); font-weight:bold;">$${currentPrice.toLocaleString()}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; width:100%; font-size:0.8rem; color:#aaa; margin-bottom:8px;">
                            <span>Renta: $${prop.rent} | Mant: $${prop.maint}</span>
                            <span>Neto: <span style="color:#${net > 0 ? '4dffea' : 'ff3939'}">+$${net}/mes</span></span>
                        </div>
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <span style="font-size:0.8rem; color:#888;">Propiedad: ${ownedCount}</span>
                            <div style="display:flex; gap:5px;">
                                <button class="act-btn" style="padding:4px 10px; min-height:auto; width:auto; font-size:0.8rem;" onclick="Game.buyRealEstate('${prop.id}')">Comprar</button>
                                ${ownedCount > 0 ? `<button class="act-btn" style="padding:4px 10px; min-height:auto; width:auto; font-size:0.8rem; background:#552222;" onclick="Game.sellRealEstate('${prop.id}')">Vender</button>` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            renderInvestments() {
                const container = document.getElementById('invest-list-container');
                container.innerHTML = '';

                ASSETS.forEach(asset => {
                    const price = state.marketPrices[asset.id];
                    const holding = state.portfolio[asset.id];
                    const profit = (price - holding.avg) * holding.qty;
                    const profitClass = profit >= 0 ? 'good' : 'bad';
                    const profitTxt = profit !== 0 ? `<br><span class="${profitClass}">P/L: $${profit.toFixed(0)}</span>` : '';

                    const el = document.createElement('div');
                    el.className = 'market-card';
                    el.innerHTML = `
                        <div>
                            <div style="font-weight:bold; color:#fff;">${asset.name}</div>
                            <div style="font-size:0.8rem; color:#aaa;">Precio: $${price.toFixed(2)}</div>
                            <div style="font-size:0.8rem;">Posees: ${holding.qty} (Media: $${holding.avg.toFixed(0)})${profitTxt}</div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                             <button class="act-btn" style="padding:5px 10px; font-size:0.8rem; min-height:auto;" onclick="Game.trade('${asset.id}', 'buy')">Comprar</button>
                             <button class="act-btn" style="padding:5px 10px; font-size:0.8rem; min-height:auto; background:#552222;" onclick="Game.trade('${asset.id}', 'sell')">Vender</button>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            renderShop() {
                const list = this.els.modals.shopList;
                list.innerHTML = ''; // Start fresh

                // If tab is Invest, re-render invest
                const investTab = document.getElementById('shop-tab-invest');
                if (investTab && !investTab.classList.contains('hidden')) {
                    this.renderInvestments();
                    return;
                }

                // Render Rare Items
                if (state.shopRare && state.shopRare.length > 0) {
                    const rareHeader = document.createElement('h4');
                    rareHeader.innerText = "üåü Objetos Raros";
                    rareHeader.style.cssText = "color:#FFD700; border-bottom:1px solid #FFD700; margin-bottom:10px;";
                    list.appendChild(rareHeader);

                    state.shopRare.forEach(item => {
                        const owned = state.inventory.includes(item.id);
                        const el = document.createElement('div');
                        el.style.cssText = "display:flex; justify-content:space-between; align-items:center; background:linear-gradient(45deg, #332a00, #1a1a1a); padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid #FFD700;";

                        el.innerHTML = `
                            <div>
                                <div style="font-weight:bold; color:#FFD700;">${item.icon} ${item.name}</div>
                                <div style="font-size:0.8rem; color:#aaa;">${item.desc}</div>
                                <div style="font-size:0.8rem; color:#aaa;">Mant: $${item.maint}/mes</div>
                            </div>
                            <button class="btn-select-job" style="border-color:#FFD700; color:#FFD700;" ${owned ? 'disabled' : ''} onclick="Game.buyRareItem('${item.id}')">
                                ${owned ? 'Comprado' : '$' + item.price.toLocaleString()}
                            </button>
                        `;
                        list.appendChild(el);
                    });
                }

                // Render Goods
                SHOP_ITEMS.forEach(item => {
                    const owned = state.inventory.includes(item.id);
                    const el = document.createElement('div');
                    // Style inline for simplicity as requested
                    el.style.cssText = "display:flex; justify-content:space-between; align-items:center; background:#1a1a1a; padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid #333;";

                    el.innerHTML = `
                        <div>
                            <div style="font-weight:bold; color:var(--text-color);">${item.name}</div>
                            <div style="font-size:0.8rem; color:#888;">${item.desc}</div>
                            <div style="font-size:0.8rem; color:#aaa;">Mant: $${item.maint}/mes</div>
                        </div>
                        <button class="btn-select-job" ${owned ? 'disabled' : ''} onclick="Game.buyItem('${item.id}')">
                            ${owned ? 'Comprado' : '$' + item.price}
                        </button>
                    `;
                    list.appendChild(el);
                });
            },

            renderMyHome() {
                const list = document.getElementById('family-list');
                list.innerHTML = '';

                // Summary of expenses
                const fins = Game.calculateFinancials();
                const totalFam = (fins.breakdown.pets || 0) + (fins.breakdown.children || 0);
                document.getElementById('home-total-expenses').innerText = `-$${totalFam}/mes`;

                // Partner
                if (state.partner && (state.partner.status === 'living' || state.partner.status === 'married')) {
                    const p = state.partner;
                    const el = document.createElement('div');
                    el.className = 'family-card';
                    el.innerHTML = `
                        <div>
                            <div style="font-weight:bold; color:#ff69b4;">${p.name} (Pareja)</div>
                            <div style="font-size:0.8rem; color:#aaa;">Ingreso: +$${p.salary}</div>
                        </div>
                        <div style="font-size:1.2rem;">‚ù§Ô∏è</div>
                    `;
                    list.appendChild(el);
                }

                // Children
                state.children.forEach(child => {
                    const isIndep = child.ageMonths >= 216;
                    const el = document.createElement('div');
                    el.className = 'family-card';
                    el.style.borderLeftColor = isIndep ? '#aaa' : '#39FF14';
                    el.innerHTML = `
                        <div>
                            <div style="font-weight:bold; color:#fff;">${child.name} (${Math.floor(child.ageMonths / 12)} a√±os)</div>
                            <div style="font-size:0.8rem; color:#aaa;">${isIndep ? 'Independiente' : `Costo: -$${CHILD_COST}/mes`}</div>
                        </div>
                        <div style="font-size:1.2rem;">${isIndep ? 'üéì' : 'üë∂'}</div>
                    `;
                    list.appendChild(el);
                });

                // Pets
                state.pets.forEach(pet => {
                    const el = document.createElement('div');
                    el.className = 'family-card';
                    el.style.borderLeftColor = '#FFA500';
                    el.innerHTML = `
                        <div>
                            <div style="font-weight:bold; color:#fff;">${pet.name}</div>
                            <div style="font-size:0.8rem; color:#aaa;">${PETS.find(p => p.id === pet.id)?.desc || ''}</div>
                        </div>
                        <div style="font-size:1.2rem;">üêæ</div>
                    `;
                    list.appendChild(el);
                });

                if (state.children.length === 0 && state.pets.length === 0 && (!state.partner || (state.partner.status !== 'living' && state.partner.status !== 'married'))) {
                    list.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">Vives solo. ¬°Consigue pareja o adopta una mascota!</div>';
                }
            }
        };
        window.GameUI = UI;

        // --- AUDIO SYSTEM ---
        const AudioSys = {
            ctx: null,
            init() {
                if (this.ctx) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    this.ctx = new AudioContext();
                }
            },
            playTone(freq, type, duration) {
                if (!this.ctx) this.init();
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playClick() { this.playTone(400, 'sine', 0.1); },
            playMoney() { this.playTone(800, 'triangle', 0.2); },
            playSuccess() {
                this.playTone(600, 'sine', 0.1);
                setTimeout(() => this.playTone(800, 'sine', 0.2), 100);
            },
            playBad() {
                this.playTone(150, 'sawtooth', 0.4);
            },
            playNotification() {
                this.playTone(500, 'sine', 0.1);
                setTimeout(() => this.playTone(1000, 'sine', 0.1), 100);
            }
        };

        const Haptics = {
            pulse() {
                if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(10);
            },
            success() {
                if (window.navigator && window.navigator.vibrate) window.navigator.vibrate([10, 50, 10]);
            },
            error() {
                if (window.navigator && window.navigator.vibrate) window.navigator.vibrate([50, 50, 50]);
            }
        };

        // --- 4. GAME LOGIC ---
        const Game = {
            init() {
                const charGen = document.getElementById('char-gen-screen');
                const mainUI = document.getElementById('main-ui');

                // Ensure Arrays Exist (Fix for legacy saves)
                if (!state.pets) state.pets = [];
                if (!state.children) state.children = [];
                if (!state.inventory) state.inventory = [];
                if (!state.unlockedTrophies) state.unlockedTrophies = []; // Trophy Init

                if (state.totalMonths === 0 && (!state.traits || state.traits.length === 0)) {
                    charGen.classList.remove('hidden');
                    mainUI.classList.add('hidden');
                    charGen.style.display = 'flex';
                    this.generateCharacter();
                } else {
                    charGen.classList.add('hidden');
                    charGen.style.display = 'none';
                    mainUI.classList.remove('hidden');
                }
                UI.render();
            },

            // --- TROPHY SYSTEM ---
            checkAchievements() {
                if (!state.unlockedTrophies) state.unlockedTrophies = [];
                TROPHIES.forEach(t => {
                    if (!state.unlockedTrophies.includes(t.id)) {
                        if (t.condition(state)) {
                            this.awardTrophy(t.id);
                        }
                    }
                });
            },

            awardTrophy(id) {
                if (state.unlockedTrophies.includes(id)) return;
                const trophy = TROPHIES.find(t => t.id === id);
                if (!trophy) return;

                state.unlockedTrophies.push(id);
                this.showTrophyNotification(trophy);
                AudioSys.playSuccess();
                Haptics.success();
                DB.saveGame(); // Auto-save on achievement
            },

            showTrophyNotification(t) {
                const notif = document.getElementById('trophy-notification');
                const title = document.getElementById('trophy-title');
                const desc = document.getElementById('trophy-desc');

                title.innerText = `LOGRO DESBLOQUEADO: ${t.name}`;
                desc.innerText = t.desc;

                notif.classList.add('active');
                setTimeout(() => notif.classList.remove('active'), 5000);
            },

            openTrophyGallery() {
                const modal = document.getElementById('trophy-modal');
                const list = document.getElementById('trophy-list');
                list.innerHTML = '';

                TROPHIES.forEach(t => {
                    const unlocked = state.unlockedTrophies.includes(t.id);
                    const el = document.createElement('div');
                    el.className = `trophy-card ${unlocked ? 'unlocked' : 'locked'}`;
                    // Inline styles for simplicity 
                    el.style.cssText = `
                        background: ${unlocked ? 'linear-gradient(45deg, #ffd700, #ffecb3)' : '#333'};
                        color: ${unlocked ? '#000' : '#888'};
                        padding: 15px;
                        border-radius: 8px;
                        text-align: center;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        box-shadow: ${unlocked ? '0 0 10px #ffd700' : 'none'};
                        opacity: ${unlocked ? '1' : '0.7'};
                    `;

                    el.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 5px;">${unlocked ? t.icon : 'üîí'}</div>
                        <div style="font-weight: bold; font-size: 0.9rem;">${t.name}</div>
                        <div style="font-size: 0.75rem; display: ${unlocked ? 'block' : 'none'}; margin-top:5px;">${t.desc}</div>
                    `;
                    list.appendChild(el);
                });

                modal.classList.add('active');
            },



            awardTrophy(id) {
                if (state.unlockedTrophies.includes(id)) return;
                state.unlockedTrophies.push(id);

                const trophy = TROPHIES.find(t => t.id === id);
                if (trophy) {
                    this.showTrophyNotification(trophy);
                    UI.log(`üèÜ Logro Desbloqueado: ${trophy.name}`, 'good');
                    AudioSys.playClick(); // Use generic sound for now
                }

                // Save immediately
                DB.saveGame();
            },

            showTrophyNotification(t) {
                const el = document.getElementById('trophy-notification');
                if (!el) return;
                document.getElementById('trophy-msg-name').innerText = t.name;
                el.classList.add('active');
                setTimeout(() => {
                    el.classList.remove('active');
                }, 4000);
            },

            openTrophyGallery() {
                const container = document.getElementById('trophy-list');
                container.innerHTML = '';

                TROPHIES.forEach(t => {
                    const unlocked = state.unlockedTrophies && state.unlockedTrophies.includes(t.id);
                    const card = document.createElement('div');
                    card.className = `trophy-card ${unlocked ? 'unlocked' : ''}`;
                    card.innerHTML = `
                        <div class="t-icon">${unlocked ? t.icon : 'üîí'}</div>
                        <div class="t-name">${t.name}</div>
                        <div class="t-desc">${t.desc}</div>
                    `;
                    container.appendChild(card);
                });

                document.getElementById('trophy-modal').classList.add('active');
            },

            generateCharacter() {
                let available = [...TRAITS];
                let picks = [];
                for (let i = 0; i < 2; i++) {
                    const idx = Math.floor(Math.random() * available.length);
                    picks.push(available[idx]);
                    available.splice(idx, 1);
                }

                const rand = Math.random();
                let bg = 'normal';
                let bgText = "Normal: Ahorros modestos ($1,000)";

                if (rand < 0.3) {
                    bg = 'debt'; // -$5000
                    bgText = "Deuda Estudiantil: Comienzas debiendo $5,000";
                } else if (rand > 0.8) {
                    bg = 'rich'; // $5000
                    bgText = "Peque√±a Herencia: Recibes $5,000";
                }

                this._tempChar = { traits: picks.map(t => t.id), bg: bg };

                document.getElementById('char-traits').innerHTML = picks.map(t => `
                        <div style="background:#333; padding:10px; border-radius:5px;">
                            <div style="color:#fff; font-weight:bold;">${t.name}</div>
                            <div style="font-size:0.8rem; color:#ccc;">${t.desc}</div>
                        </div>
                    `).join('');

                const bgContainer = document.getElementById('char-bg');
                bgContainer.innerHTML = bgText;
                bgContainer.style.color = bg === 'debt' ? '#ff5555' : (bg === 'rich' ? '#4dffea' : '#fff');
            },

            confirmStart() {
                if (!this._tempChar) return;
                state.traits = this._tempChar.traits;
                state.background = this._tempChar.bg;
                if (state.background === 'debt') state.money = -5000;
                else if (state.background === 'rich') state.money = 5000;
                else state.money = 1000;
                document.getElementById('char-gen-screen').style.display = 'none';
                document.getElementById('main-ui').classList.remove('hidden');
                UI.log("¬°Nueva vida comenzada!", "good");
                UI.render();
            },

            checkGameOver() {
                if (state.health <= 0) {
                    UI.showAlert("GAME OVER", "Has muerto debido a tu mala salud. ‚ò†Ô∏è", () => location.reload()); // Simple reload for death
                    return true;
                }
                // Retirement Check (Age 65 = 47 years * 12 months = 564 months)
                if (state.totalMonths >= 564) {
                    this.showEndGame();
                    return true;
                }
                return false;
            },

            calculateScore() {
                let score = 0;
                score += state.money * 0.01;
                score += state.happiness * 50;
                score += state.intelligence * 20;
                score += state.education.length * 1000;

                // Children Legacy Bonus
                const childBonus = state.children.length * 0.10; // +10% per child
                score = score * (1 + childBonus);

                const job = JOBS.find(j => j.id === state.currJobId);
                if (job) score += job.salary * 0.5;

                return Math.floor(score);
            },

            showEndGame() {
                const score = this.calculateScore();

                // Submit Score (Fire & Forget)
                DB.submitScore(score);

                UI.els.modals.endSummary.innerHTML = `
                    <p><strong>Edad Final:</strong> 65 a√±os</p>
                    <p><strong>Dinero:</strong> $${state.money.toLocaleString()}</p>
                    <p><strong>Felicidad:</strong> ${Math.floor(state.happiness)}%</p>
                    <p><strong>T√≠tulos:</strong> ${state.education.length}</p>
                    <p><strong>√öltimo Trabajo:</strong> ${JOBS.find(j => j.id === state.currJobId)?.title || 'N/A'}</p>
                `;
                UI.els.modals.endScore.innerText = `Puntuaci√≥n Final: ${score}`;
                UI.els.modals.endGame.classList.add('active');
            },

            claimLegacy(type) {
                let val = 0;
                if (type === 'money') val = Math.floor(state.money * 0.1);
                if (type === 'genetics') val = Math.floor(state.intelligence * 0.2);

                localStorage.setItem('lifeSim_legacy', JSON.stringify({ type, val }));
                location.reload();
            },

            restartGame() {
                location.reload();
            },

            updateStat(key, amount) {
                // Trait Modifiers
                if (state.traits) {
                    // Genius: +50% Int gain
                    if (state.traits.includes('genius') && key === 'intelligence' && amount > 0) {
                        amount *= 1.5;
                        // Side effect: -Happiness max logic handled separately or on limit check
                    }
                    // Athlete: +Health gain
                    if (state.traits.includes('athlete') && key === 'physicalHealth' && amount > 0) {
                        amount *= 1.2;
                    }
                    // Sickly: -Health gain
                    if (state.traits.includes('sickly') && key === 'physicalHealth' && amount > 0) {
                        amount *= 0.5;
                    }
                    // Charismatic: +Social (Status/Friends) - maybe check key 'status' or 'happiness' from social?
                    // Simplified: if key is happiness from social event, maybe boost?
                }

                state[key] += amount;

                // Clamping & Trait Limits
                let maxHealth = 100;
                let maxHappy = 100;

                if (state.traits) {
                    if (state.traits.includes('sickly')) maxHealth = 80;
                    if (state.traits.includes('genius')) maxHappy = 90;
                }

                if (key === 'physicalHealth') {
                    if (state[key] > maxHealth) state[key] = maxHealth;
                    if (state[key] < 0) state[key] = 0;
                } else if (key === 'happiness') {
                    if (state[key] > maxHappy) state[key] = maxHappy;
                    if (state[key] < 0) state[key] = 0;
                } else if (['mentalHealth', 'energy', 'intelligence', 'experience'].includes(key)) {
                    if (state[key] > 100) state[key] = 100;
                    if (state[key] < 0) state[key] = 0;
                }
                if (key === 'karma') {
                    if (state[key] > 100) state[key] = 100;
                    if (state[key] < -100) state[key] = -100;
                }
                if (key === 'policeRisk') {
                    if (state[key] > 100) state[key] = 100;
                    if (state[key] < 0) state[key] = 0;
                }
                if (key === 'money') {
                    UI.flashMoney(amount);
                    if (amount > 0) {
                        AudioSys.playMoney();
                        Haptics.success();
                    }
                }
                this.checkAchievements(); // Check for trophies after any stat change
            },

            commitCrime(type) {
                if (state.prisonMonths > 0) return UI.showAlert("En Prisi√≥n", "No puedes cometer cr√≠menes desde la c√°rcel.");

                let money = 0;
                let risk = 0;
                let karmaLoss = 0;
                let msg = "";

                // Difficlty vs Int check?
                // For now, raw risk/reward

                if (type === 'embezzle') {
                    money = 1000 + (Math.random() * 2000);
                    risk = 15;
                    karmaLoss = 10;
                    msg = "Malversaste fondos de la empresa.";
                } else if (type === 'deal') {
                    money = 5000 + (Math.random() * 5000);
                    risk = 30;
                    karmaLoss = 25;
                    msg = "Hiciste un trato ilegal muy lucrativo.";
                } else if (type === 'scam') {
                    money = 500;
                    risk = 5;
                    karmaLoss = 5;
                    msg = "Estafa piramidal menor.";
                }

                this.updateStat('money', Math.floor(money));
                this.updateStat('policeRisk', risk);
                this.updateStat('karma', -karmaLoss);

                UI.log(`CRIMEN: ${msg} (+$${Math.floor(money)}, +${risk}% Riesgo)`, "bad");

                // Immediate Bust Check (Low chance)
                if (Math.random() * 100 < state.policeRisk / 2) {
                    this.goToPrison();
                } else {
                    UI.render();
                }
            },

            donateCharity(amount) {
                if (state.money < amount) return UI.showAlert("Sin Fondos", "No tienes suficiente dinero.");

                this.updateStat('money', -amount);
                const karmaGain = Math.floor(amount / 100); // $100 = 1 Karma
                this.updateStat('karma', karmaGain);
                this.updateStat('happiness', 5);

                UI.log(`Donaste $${amount} a la caridad. Te sientes mejor.`, "good");
                UI.render();
            },

            goToPrison() {
                const duration = 12; // 1 year fixed for now
                const legalFees = Math.floor(state.money * 0.3) + 2000;

                this.updateStat('money', -legalFees);
                state.prisonMonths = duration;
                state.policeRisk = 0; // Reset risk
                state.consecutiveWork = 0;
                state.currJobId = 'unemployed'; // Fired

                UI.showAlert("¬°ARRESTADO! üëÆ‚Äç‚ôÇÔ∏è", `La polic√≠a te atrap√≥. 
                 \n- Pasas ${duration} meses en prisi√≥n.
                 \n- Pierdes tu trabajo.
                 \n- Gastos legales: $${legalFees}.
                 \n- Salud y felicidad decaen.`, () => {
                    // Fast forward logic or locked mode?
                    // Let's do Fast Forward instant for UX smoothness
                    for (let i = 0; i < duration; i++) {
                        state.totalMonths++;
                        state.physicalHealth -= 1;
                        state.mentalHealth -= 2;
                        state.happiness -= 2;
                        // No income, but maybe age happens
                    }
                    // Reset
                    state.prisonMonths = 0;
                    UI.log(`Saliste de prisi√≥n despu√©s de ${duration} meses. Eres libre, pero a qu√© costo.`, "normal");
                    UI.render();
                });
            },

            work() {
                if (state.sickDuration > 0) {
                    UI.log("Est√°s demasiado enfermo para trabajar.", "bad");
                    return;
                }
                if (state.energy < 20) return;

                // Burnout Check
                state.consecutiveWork++;
                if (state.consecutiveWork > 2) {
                    this.updateStat('physicalHealth', -5);
                    this.updateStat('mentalHealth', -15);
                    this.updateStat('happiness', -15);
                    UI.log("¬°BURNOUT! Est√°s trabajando demasiado seguido. Tu mente y cuerpo sufren.", "bad");
                }

                const job = JOBS.find(j => j.id === state.currJobId);
                if (state.currJobId === 'unemployed') {
                    UI.log("No tienes empleo. Consigue uno tocando la barra de arriba.", "info");
                    return;
                }

                if (!job) {
                    UI.log("Error: Trabajo no encontrado. Contacta soporte.", "bad");
                    console.error("Job not found for ID:", state.currJobId);
                    return;
                }

                // Check for Promotion triggers
                if (state.jobXP >= 100) {
                    this.triggerPerformanceReview(job);
                    return;
                }

                let earned = job.salary;

                // Item Effects: Wage Multiplier
                if (state.inventory.includes('suit')) earned *= 1.1;
                if (state.inventory.includes('laptop') && (job.career === 'tech')) earned *= 1.2;

                // Energy Cost with Efficiency Bonus
                let energyCost = Math.max(10, 30 - (state.promotions * 2));

                // Vehicle reduces energy cost
                const vehicle = VEHICLES.find(v => v.id === state.vehicle);
                if (vehicle) {
                    energyCost = Math.max(5, energyCost - vehicle.energyReduction);
                }

                this.updateStat('money', Math.floor(earned));
                this.updateStat('energy', -energyCost);
                this.updateStat('physicalHealth', -1);
                this.updateStat('mentalHealth', -2); // Work is stressful
                this.updateStat('experience', 1);

                // XP Gain
                if (job.career !== 'none') {
                    state.jobXP = Math.min(100, state.jobXP + 10);
                }

                UI.log(`Trabajaste como ${job.title}. Ganaste $${Math.floor(earned)}.`, "normal");
                UI.render();
            },

            triggerPerformanceReview(currentJob) {
                this.showEventModal({
                    text: "EVALUACI√ìN DE DESEMPE√ëO: Has alcanzado el m√°ximo de experiencia en tu puesto actual. ¬øQu√© har√°s?",
                    choices: [
                        {
                            text: "Exigir Ascenso",
                            sub: "Riesgo alto. Si fallas, pierdes felicidad. Si ganas, asciendes.",
                            action: () => {
                                // 70% chance success
                                if (Math.random() < 0.7) {
                                    this.promote(currentJob);
                                    return { msg: "¬°Ascenso concedido! Tu audacia dio frutos.", type: 'good' };
                                } else {
                                    state.jobXP = 50; // Setback
                                    state.happiness -= 20;
                                    return { msg: "Tu jefe se ri√≥ en tu cara. Int√©ntalo m√°s tarde.", type: 'bad' };
                                }
                            }
                        },
                        {
                            text: "Esperar turno",
                            sub: "Seguro. Tarde o temprano te ascender√°n.",
                            action: () => {
                                this.promote(currentJob);
                                return { msg: "Tu paciencia fue recompensada (eventualmente). Ascendido.", type: 'good' };
                            }
                        }
                    ]
                });
            },

            promote(currentJob) {
                // Find next job in same career
                const careerJobs = JOBS.filter(j => j.career === currentJob.career);
                const currentIndex = careerJobs.findIndex(j => j.id === currentJob.id);

                if (currentIndex >= 0 && currentIndex < careerJobs.length - 1) {
                    const nextJob = careerJobs[currentIndex + 1];
                    state.currJobId = nextJob.id;
                    state.jobXP = 0;
                    state.promotions++;
                } else {
                    // Top of ladder
                    state.jobXP = 100; // Keep at max
                    // Maybe give a bonus?
                    this.updateStat('money', 5000);
                    UI.log("¬°Eres una leyenda en tu campo! Bono de $5000.", "good");
                }
            },

            doActivity(type) {
                if (state.energy < 20) return;

                // --- TRAIT: Bookworm ---
                let studyEnergyCost = 25;
                if (state.traits && state.traits.includes('bookworm')) studyEnergyCost = 15;

                if (type === 'study') {
                    if (state.money < CONFIG.studyCost) return UI.log("Dinero insuficiente.", "bad");
                    this.updateStat('money', -CONFIG.studyCost);
                    this.updateStat('energy', -studyEnergyCost);

                    let gain = 2 + Math.floor(state.intelligence * 0.05);
                    // Item Effect
                    if (state.inventory.includes('book_stats')) gain = Math.ceil(gain * 1.5);

                    this.updateStat('intelligence', gain);
                    UI.log(`Estudiaste intensamente. +${gain} Int.`, "info");
                }
                else if (type === 'gym') {
                    if (state.money < 40) return UI.log("Dinero insuficiente.", "bad");
                    this.updateStat('money', -40);
                    this.updateStat('energy', -20);
                    this.updateStat('physicalHealth', 5);
                    this.updateStat('mentalHealth', 2);
                    this.updateStat('happiness', 2);
                    UI.log("Gym session: ¬°Te sientes fuerte!", "good");
                }
                else if (type === 'meditate') {
                    this.updateStat('energy', -10);
                    this.updateStat('mentalHealth', 5);
                    UI.log("Meditaci√≥n: Tu mente se aclara.", "good");
                }
                else if (type === 'therapy') {
                    if (state.money < 100) return UI.log("No tienes $100.", "bad");
                    this.updateStat('money', -100);
                    this.updateStat('energy', -5);
                    this.updateStat('mentalHealth', 15);
                    UI.log("Terapia: Has procesado tus emociones.", "good");
                }
                else if (type === 'marathon') {
                    if (state.money < 100) return UI.log("Dinero insuficiente.", "bad");
                    this.updateStat('money', -100);
                    this.updateStat('energy', -50);
                    this.updateStat('physicalHealth', 15);
                    this.updateStat('happiness', 10);
                    UI.log("Corriste una marat√≥n. ¬°Gran logro f√≠sico!", "good");
                }

                UI.els.modals.act.classList.remove('active');
                UI.render();
            },


            startProject(typeId) {
                if (state.activeProject) {
                    UI.showAlert("Ya tienes un proyecto activo", "Termina el actual antes de empezar otro.");
                    return;
                }
                const type = PROJECT_TYPES.find(p => p.id === typeId);

                // Requirements Check
                if (type.req.intelligence && state.intelligence < type.req.intelligence) {
                    UI.showAlert("Falta Inteligencia", `Necesitas ${type.req.intelligence} de inteligencia.`);
                    return;
                }
                if (state.money < type.cost) {
                    UI.showAlert("Fondos Insuficientes", `Iniciar cuesta $${type.cost}.`);
                    return;
                }

                this.updateStat('money', -type.cost);
                state.activeProject = {
                    id: Date.now(), // Unique ID
                    typeId: typeId,
                    name: type.name, // Default name for now
                    progress: 0,
                    duration: type.duration,
                    penalty: type.penalty
                };

                UI.showAlert("Proyecto Iniciado", `Has comenzado: ${type.name}. Duraci√≥n: ${type.duration} meses. Consumir√° energ√≠a.`);
                UI.els.modals.act.classList.remove('active');
                UI.render();
            },

            processProjects() {
                if (!state.activeProject) return;

                state.activeProject.progress++;

                // Max Energy Penalty handled in nextMonth alongside courses

                if (state.activeProject.progress >= state.activeProject.duration) {
                    this.completeProject();
                }
            },

            completeProject() {
                const p = state.activeProject;
                const type = PROJECT_TYPES.find(t => t.id === p.typeId);

                // Calculate Success/Quality
                // Base chance + Int bonus + Random
                const intFactor = state.intelligence / 200; // 0 to 0.5
                const rand = Math.random();
                let quality = 'Normal';
                let multiplier = 1;

                if (rand + intFactor > 0.9) {
                    quality = 'Viral/BestSeller üåü';
                    multiplier = 5;
                } else if (rand + intFactor > 0.6) {
                    quality = '√âxito ‚úÖ';
                    multiplier = 2;
                } else if (rand + intFactor < 0.2) {
                    quality = 'Flop üìâ';
                    multiplier = 0.2;
                }

                // Base Revenue calculation
                let baseRev = type.cost * 0.1; // e.g., $100 cost -> $10/mo base
                let royalty = Math.floor(baseRev * multiplier);
                if (royalty < 1) royalty = 1;

                state.creations.push({
                    name: `${type.name} #${state.creations.length + 1}`,
                    type: type.name,
                    royalty: royalty,
                    quality: quality
                });

                UI.showAlert("¬°Proyecto Completado!", `Terminaste tu ${type.name}.\nCalidad: ${quality}\nRegal√≠as: $${royalty}/mes`);
                state.activeProject = null;
            },

            startCourse(courseId) {
                if (state.activeCourse) {
                    UI.showAlert("Ya est√°s estudiando", "Termina tu curso actual antes de empezar otro.");
                    return;
                }
                const course = COURSES.find(c => c.id === courseId);
                if (state.money < course.cost) {
                    UI.showAlert("Fondos Insuficientes", `El curso cuesta $${course.cost}.`);
                    return;
                }
                if (state.education.includes(courseId)) {
                    UI.showAlert("Ya tienes este t√≠tulo", "No puedes cursarlo de nuevo.");
                    return;
                }

                this.updateStat('money', -course.cost);
                state.activeCourse = { id: courseId, monthsLeft: course.duration };

                UI.showAlert("Matriculado", `Has comenzado el ${course.title}. Duraci√≥n: ${course.duration} meses. Prep√°rate para perder energ√≠a.`);
                UI.els.modals.act.classList.remove('active');
                UI.render();
            },

            rest() {
                state.consecutiveWork = 0; // Reset burnout
                this.updateStat('energy', 40);
                this.updateStat('health', 2);
                this.updateStat('happiness', 3);
                UI.log("Tomaste un descanso y te relajaste.", "normal");
                UI.render();
            },

            nextMonth() {
                if (this.checkGameOver()) return;
                state.totalMonths++;

                state.consecutiveWork = 0; // Reset burnout monthly

                // Sickness Check
                if (state.sickDuration > 0) {
                    state.sickDuration--;
                    UI.log("Sigues enfermo (-Salud F√≠sica).", "bad");
                    this.updateStat('physicalHealth', -5);
                } else if (state.physicalHealth < 30) {
                    if (Math.random() < 0.3) {
                        state.sickDuration = 2;
                        UI.log("¬°Te has enfermado gravemente!", "bad");
                        this.updateStat('happiness', -20);
                    } else {
                        UI.log("Tu cuerpo se siente d√©bil. Cuidate.", "info");
                    }
                }

                // Aging (Over 50 years = 600 months)
                if (state.totalMonths > 600) {
                    this.updateStat('physicalHealth', -2); // Extra decay
                    if (Math.random() < 0.2) UI.log("Te duelen las articulaciones por la edad.", "info");
                }

                // Diet Logic
                let dietCost = 0;
                let dietHealth = 0;
                if (state.diet === 'fast_food') { dietCost = 100; dietHealth = -2; }
                else if (state.diet === 'balanced') { dietCost = 300; dietHealth = 0; }
                else if (state.diet === 'chef') { dietCost = 1000; dietHealth = 2; }

                this.updateStat('physicalHealth', dietHealth);

                // Housing & Vehicle Effects
                const housing = HOUSING.find(h => h.id === state.housing);
                const vehicle = VEHICLES.find(v => v.id === state.vehicle);

                if (housing) {
                    this.updateStat('happiness', housing.happiness);
                    this.updateStat('energy', housing.energyRecovery);
                }

                // Mantenimiento de Items & Diet Cost & Housing & Vehicle
                let stats = this.calculateItemEffects();
                let totalCost = CONFIG.costOfLiving + stats.maint + dietCost;

                if (housing) totalCost += housing.maint;
                if (vehicle) totalCost += vehicle.maint;

                this.updateStat('money', -totalCost);
                this.updateStat('happiness', stats.happy);

                let logTone = state.mentalHealth < 30 ? "pessimistic" : "normal";
                let msg = state.mentalHealth < 30 ? `Todo es gris. Gastos: -$${totalCost}.` : `Mes nuevo. Gastos: -$${totalCost} (Vida + Mant)`;
                let type = 'normal';

                if (state.money < 0) {
                    msg += " DEUDA.";
                    this.updateStat('mentalHealth', -10);
                    this.updateStat('happiness', -10);
                    type = 'bad';
                }

                // Elite Events (5% chance if status >= 100)
                if (state.status >= 100 && Math.random() < 0.05) {
                    const eligibleEvents = ELITE_EVENTS.filter(e => state.status >= e.minStatus);
                    if (eligibleEvents.length > 0) {
                        const event = eligibleEvents[Math.floor(Math.random() * eligibleEvents.length)];
                        UI.log(event.text, 'info');
                        const result = event.effect();
                        if (result.money) this.updateStat('money', result.money);
                        if (result.experience) this.updateStat('experience', result.experience);
                        if (result.happiness) this.updateStat('happiness', result.happiness);
                        UI.log(result.msg, result.type);
                    }
                }

                // Rare Item Drops (2% chance)
                if (Math.random() < 0.02) {
                    const rare = RARE_ITEMS[Math.floor(Math.random() * RARE_ITEMS.length)];
                    if (!state.shopRare) state.shopRare = [];
                    if (!state.shopRare.some(r => r.id === rare.id) && !state.inventory.includes(rare.id)) {
                        state.shopRare.push(rare);
                        UI.log(`¬°ATENCI√ìN! Un ${rare.name} est√° disponible en la tienda.`, 'good');
                        // AudioSys.playNotification(); 
                    }
                }

                // Expiry of rare items (10% chance)
                if (state.shopRare) {
                    state.shopRare = state.shopRare.filter(r => Math.random() > 0.1);
                }

                // Education Progress
                let maxEnergy = 100;
                if (state.activeCourse) {
                    state.activeCourse.monthsLeft--;
                    const course = COURSES.find(c => c.id === state.activeCourse.id);
                    maxEnergy -= course.penalty; // Apply penalty to max energy logic

                    if (state.activeCourse.monthsLeft <= 0) {
                        state.education.push(state.activeCourse.id);
                        UI.showAlert("¬°Felicidades!", `Has completado el curso: ${course.title}. Obtuviste el t√≠tulo: ${course.degree}.`);
                        state.activeCourse = null;
                        maxEnergy = 100; // Reset penalty
                    } else {
                        msg += ` | Estudiando: ${course.title} (-${course.penalty} E Max)`;
                    }
                }

                if (state.activeProject) {
                    maxEnergy -= state.activeProject.penalty;
                    msg += ` | Proyecto: ${state.activeProject.name} (-${state.activeProject.penalty} E Max)`;
                }

                state.energy = maxEnergy;

                // Market Fluctuation
                this.updateMarket();
                this.handleMarketEvents(); // Handle crashes/booms

                // Real Estate Logic
                this.processRealEstate();

                // Social Decay
                this.socialDecay();

                // Process Children
                this.processChildren();

                // Process Projects
                this.processProjects();

                // Pet Happiness Safety Net
                if (state.pets.length > 0 && state.happiness < 20) {
                    state.happiness = 20;
                    UI.log("Tu mascota te consol√≥. Felicidad m√≠n 20%.", "good");
                }

                // Crime & Risk Logic
                if (state.policeRisk > 0) {
                    // Decay
                    state.policeRisk -= 5;
                    if (state.policeRisk < 0) state.policeRisk = 0;

                    // Monthly Arrest Check (Low chance)
                    if (state.policeRisk > 0 && Math.random() * 100 < state.policeRisk / 3) {
                        this.goToPrison();
                        return; // Stop processing other events if arrested?
                        // Actually goToPrison does fast forward, so we just let it run.
                    }
                }

                // Partner Logic
                if (state.partner) {
                    state.partner.relation -= 2;
                    if (state.partner.relation < 0) state.partner.relation = 0;

                    // Effects
                    if (state.partner.relation > 80) {
                        this.updateStat('happiness', 10);
                        msg += " üòç";
                    } else if (state.partner.relation < 30) {
                        this.updateStat('happiness', -5);
                        this.updateStat('mentalHealth', -5); // Toxic relationship
                        msg += " üíî";
                    }

                    // Random Argument (2%)
                    if (Math.random() < 0.02) {
                        UI.showAlert("Discusi√≥n de Pareja", "Las cosas est√°n tensas. ¬°Cuidado!", () => {
                            state.partner.relation -= 15;
                            UI.renderSocialTab();
                        });
                    }
                }

                // Log History (Cloud)
                const financials = this.calculateFinancials();
                DB.logHistory(state.totalMonths, financials);

                UI.log(msg, type);
                this.randomEvent();
                UI.render();
            },

            updateMarket() {
                let report = "";
                ASSETS.forEach(asset => {
                    const volatility = asset.vol;
                    const changePct = (Math.random() - 0.5) * 2 * volatility; // e.g. -0.05 to +0.05
                    let newPrice = state.marketPrices[asset.id] * (1 + changePct);
                    newPrice = Math.max(1, newPrice); // Min price 1

                    state.marketPrices[asset.id] = newPrice;

                    // Log big moves
                    if (changePct > volatility * 0.8) report += `üöÄ ${asset.name} sube con fuerza! `;
                    if (changePct < -volatility * 0.8) report += `üìâ ${asset.name} se desploma! `;
                });
                if (report) UI.log(report, "info");
            },

            trade(assetId, type) { // type: 'buy', 'sell'
                const price = state.marketPrices[assetId];
                const holding = state.portfolio[assetId];

                if (type === 'buy') {
                    if (state.money < price) {
                        UI.showAlert("Fondos Insuficientes", "No tienes dinero para comprar este activo.");
                        return;
                    }
                    this.updateStat('money', -price);

                    // Calc Avg Price
                    const totalVal = (holding.qty * holding.avg) + price;
                    holding.qty++;
                    holding.avg = totalVal / holding.qty;
                    UI.renderShop(); // Re-render to show update
                    UI.render(); // Update money header
                } else {
                    if (holding.qty <= 0) return;

                    this.updateStat('money', price);
                    holding.qty--;
                    if (holding.qty === 0) holding.avg = 0;

                    UI.renderShop();
                    UI.render();
                }
            },

            processRealEstate() {
                // 1. Appreciation (0.5%)
                let totalValue = 0;
                Object.keys(state.rePrices).forEach(id => {
                    const oldP = state.rePrices[id];
                    const newP = oldP * 1.005; // +0.5%
                    state.rePrices[id] = newP;
                });

                // 2. Income
                let totalIncome = 0;
                let totalMaint = 0;

                state.realEstate.forEach(ownedId => {
                    const prop = REAL_ESTATE.find(p => p.id === ownedId);
                    if (prop) {
                        totalIncome += prop.rent;
                        totalMaint += prop.maint;
                    }
                });

                if (state.realEstate.length > 0) {
                    const net = totalIncome - totalMaint;
                    this.updateStat('money', net);
                    UI.log(`Inmuebles: +$${totalIncome} Renta - $${totalMaint} Mant. = $${net} Neto.`, "good");
                }
            },

            buyRealEstate(id) {
                const price = state.rePrices[id];
                if (state.money < price) {
                    UI.showAlert("Fondos Insuficientes", "No te alcanza para la inicial.");
                    return;
                }
                this.updateStat('money', -price);
                if (!state.realEstate) state.realEstate = [];
                state.realEstate.push(id);

                const prop = REAL_ESTATE.find(p => p.id === id);
                UI.log(`¬°Nueva Propiedad! Compraste: ${prop.name}`, "good");
                UI.renderRealEstate(); // Force re-render of this tab
                UI.render();
            },

            sellRealEstate(id) {
                const idx = state.realEstate.indexOf(id);
                if (idx === -1) return;

                const price = state.rePrices[id];
                state.realEstate.splice(idx, 1);
                this.updateStat('money', price);

                UI.log(`Vendiste propiedad por $${Math.floor(price)}.`, "good");
                UI.renderRealEstate();
                UI.render();
            },

            randomEvent() {
                // 30% Chance
                if (Math.random() > 0.3) return;

                // Filter valid events based on conditions
                const validEvents = EVENTS.filter(e => !e.condition || e.condition(state));
                if (validEvents.length === 0) return;

                const event = validEvents[Math.floor(Math.random() * validEvents.length)];

                if (event.type === 'instant') {
                    const res = event.effect(state);
                    this.applyEffect(res);
                } else if (event.type === 'choice') {
                    this.showEventModal(event);
                }
            },

            applyEffect(res) {
                if (res.money) this.updateStat('money', res.money);
                if (res.health) this.updateStat('physicalHealth', res.health); // Retro-fit
                if (res.physicalHealth) this.updateStat('physicalHealth', res.physicalHealth);
                if (res.mentalHealth) this.updateStat('mentalHealth', res.mentalHealth);
                if (res.happiness) this.updateStat('happiness', res.happiness);
                if (res.energy) this.updateStat('energy', res.energy);
                if (res.intelligence) this.updateStat('intelligence', res.intelligence);
                if (res.experience) this.updateStat('experience', res.experience);

                UI.log(res.msg || "Evento procesado.", res.type || 'info');
                UI.render();
            },

            showEventModal(event) {
                UI.els.modals.eventText.innerText = event.text;
                UI.els.modals.eventChoices.innerHTML = '';

                event.choices.forEach(choice => {
                    const btn = document.createElement('div');
                    btn.className = 'choice-btn';
                    btn.innerHTML = `<span class="choice-text">${choice.text}</span><span class="choice-sub">${choice.sub}</span>`;
                    btn.onclick = () => {
                        const res = choice.action(state);
                        this.applyEffect(res);
                        UI.els.modals.event.classList.remove('active');
                    };
                    UI.els.modals.eventChoices.appendChild(btn);
                });

                UI.els.modals.event.classList.add('active');
            },

            handleMarketEvents() {
                // 1. Process Pending
                if (state.pendingEvent) {
                    state.pendingEvent.timer--;
                    if (state.pendingEvent.timer <= 0) {
                        // Execute
                        const evt = MARKET_EVENTS.find(e => e.id === state.pendingEvent.id);
                        if (evt) {
                            evt.effect(state);
                            UI.log(evt.msg, evt.id.includes('crash') || evt.id === 'inflation' ? 'bad' : 'good');
                        }
                        state.pendingEvent = null;
                    }
                    return; // Don't trigger new event while one is pending
                }

                // 2. Roll New Event (5% chance)
                // TODO: Define MARKET_EVENTS constant if needed
                /*
                if (Math.random() < 0.05) {
                    const evt = MARKET_EVENTS[Math.floor(Math.random() * MARKET_EVENTS.length)];
                    state.pendingEvent = { id: evt.id, timer: 1 }; // 1 month warning
                    UI.log(`üì∞ NOTICIA: ${evt.warn}`, "info");
                }
                */
            },

            applyToJob(jobId) {
                const job = JOBS.find(j => j.id === jobId);
                if (!job) return;

                // Networking Bonus
                let discount = 1;
                const contact = state.friends.find(f => f.bonusJobId === job.id && f.relation > 80);
                if (contact) {
                    discount = 0.8;
                    UI.log(`¬°NETWORKING! ${contact.name} te recomend√≥. Requisitos -20%.`, "good");
                }

                // Verify Requirements
                const reqs = job.req;
                let missing = [];

                if (reqs.int && state.intelligence < (reqs.int * discount)) missing.push(`Inteligencia ${Math.ceil(reqs.int * discount)}`);
                if (reqs.exp && state.experience < reqs.exp) missing.push(`Experiencia ${reqs.exp}`);
                if (reqs.health && state.physicalHealth < reqs.health) missing.push(`Salud ${reqs.health}`);
                if (reqs.happy && state.happiness < reqs.happy) missing.push(`Felicidad ${reqs.happy}`);
                if (reqs.deg && !state.education.includes(reqs.deg)) {
                    const c = COURSES.find(x => x.id === reqs.deg);
                    missing.push(`T√≠tulo: ${c ? c.degree : reqs.deg}`);
                }

                if (missing.length > 0) {
                    UI.showAlert("Requisitos Insuficientes", `Te falta: ${missing.join(', ')}`);
                    return;
                }

                state.currJobId = jobId;
                state.jobXP = 0; // Reset XP on new job
                // Do not reset promotions count, as it reflects career efficiency
                UI.showAlert("¬°Contratado!", `Has sido contratado como ${job.title}.`);
                UI.log(`Nueva carrera: ${job.title}`, "good");
                UI.render();
                UI.els.modals.job.classList.remove('active');
            },

            checkGameOver() {
                if (state.physicalHealth <= 0) {
                    UI.showAlert("GAME OVER", "Tu cuerpo ha fallado. Has muerto.", () => location.reload());
                    this.disableGame();
                    return true;
                }
                return false;
            },
            disableGame() { Object.values(UI.els.btns).forEach(b => b.disabled = true); },

            buyItem(itemId) {
                const item = SHOP_ITEMS.find(i => i.id === itemId);
                if (state.money < item.price) {
                    UI.showAlert("Fondos Insuficientes", "No tienes suficiente dinero para comprar esto.");
                    return;
                }
                if (state.inventory.includes(itemId)) return;

                this.updateStat('money', -item.price);
                state.inventory.push(itemId);
                UI.log(`Compraste: ${item.name}`, "good");

                // Refresh Shop UI if open
                const container = UI.els.modals.shopList;
                if (container && UI.els.modals.shop.classList.contains('active')) {
                    // Could re-render shop here but lazy way is nice
                    UI.els.modals.shopBtn.click();
                }
                UI.render();
            },

            buyRareItem(itemId) {
                if (state.inventory.includes(itemId)) return;
                const item = state.shopRare.find(i => i.id === itemId);
                if (!item) return;

                if (state.money < item.price) return UI.showAlert("Sin Fondos", "No tienes suficiente dinero para esta joya.");

                this.updateStat('money', -item.price);
                state.inventory.push(itemId);

                // Remove from shop
                state.shopRare = state.shopRare.filter(i => i.id !== itemId);

                UI.log(`¬°ADQUIRISTE UNA RELIQUIA! ${item.name}`, "good");

                // Trigger achievements check
                this.checkAchievements();

                UI.render();
            },

            calculateItemEffects() {
                let maint = 0;
                let happy = 0;
                let colRed = 0;

                state.inventory.forEach(id => {
                    const item = SHOP_ITEMS.find(i => i.id === id);
                    if (!item) return;
                    maint += item.maint;
                    if (item.effect.type === 'col_red') colRed += item.effect.val;
                    if (item.effect.type === 'happy_boost') happy += item.effect.val;
                });

                return { maint: Math.max(0, maint - colRed), happy };
            },

            // --- SOCIAL LOGIC ---
            party() {
                if (state.money < 150) return UI.showAlert("No tienes dinero", "Salir cuesta $150.");
                if (state.energy < 40) return UI.showAlert("Sin energ√≠a", "Est√°s muy cansado.");

                this.updateStat('money', -150);
                this.updateStat('energy', -40);
                this.updateStat('happiness', 15);

                // 40% Chance new friend
                if (Math.random() < 0.4) {
                    this.makeFriend();
                } else {
                    UI.log("Saliste de fiesta. Te divertiste, pero no conociste a nadie clave.", "normal");
                }

                UI.render();
            },

            haveChild() {
                if (!state.partner || (state.partner.status !== 'living' && state.partner.status !== 'married')) {
                    return UI.showAlert("No puedes", "Necesitas vivir con tu pareja o estar casado.");
                }
                const hospitalCost = 1000;
                if (state.money < hospitalCost) return UI.showAlert("Fondos Insuficientes", `El parto cuesta $${hospitalCost}.`);

                this.updateStat('money', -hospitalCost);

                const gender = Math.random() > 0.5 ? 'Ni√±o' : 'Ni√±a';
                const names = gender === 'Ni√±o' ? ['Hugo', 'Mateo', 'Lucas', 'Leo', 'Daniel'] : ['Sof√≠a', 'Luc√≠a', 'Martina', 'Julia', 'Paula'];
                const name = names[Math.floor(Math.random() * names.length)];

                state.children.push({ name, ageMonths: 0, gender });

                this.updateStat('happiness', 20);
                UI.showAlert(`¬°Ha nacido un beb√©! üë∂`, `Es un ${gender} llamado ${name}. ¬°Felicidades! (-$${hospitalCost})`);
                if (document.getElementById('home-modal').classList.contains('active')) UI.renderMyHome();
                UI.renderSocialTab();
            },

            adoptPet(petId) {
                const petDef = PETS.find(p => p.id === petId);
                if (state.money < petDef.cost) return UI.showAlert("Sin dinero", "No puedes adoptar esta mascota.");

                this.updateStat('money', -petDef.cost);
                state.pets.push({ id: petId, name: petDef.name });
                this.updateStat('happiness', 10);
                UI.showAlert("¬°Nueva Mascota! üêæ", `Has adoptado a un ${petDef.name}.`);
                if (document.getElementById('home-modal').classList.contains('active')) UI.renderMyHome();
                UI.render();
            },

            makeFriend() {
                const names = ["Ana", "Carlos", "Sofia", "Miguel", "Lucia", "David", "Elena", "Jorge", "Maria", "Pablo"];
                const rndName = names[Math.floor(Math.random() * names.length)];

                // Pick a random Job ID this friend works at
                const relevantJobs = JOBS.filter(j => j.id !== 'unemployed');
                const rndJob = relevantJobs[Math.floor(Math.random() * relevantJobs.length)];

                const newFriend = {
                    id: Date.now().toString(),
                    name: rndName,
                    jobTitle: rndJob.title,
                    bonusJobId: rndJob.id,
                    relation: 50
                };

                state.friends.push(newFriend);
                UI.log(`¬°Conociste a ${newFriend.name}! Trabaja de ${newFriend.jobTitle}.`, "good");
                // UI.renderFriends(); // TODO: Implement renderFriends function
            },

            maintainFriend(id) {
                if (state.money < 50) return;
                if (state.energy < 10) return;

                const f = state.friends.find(x => x.id === id);
                if (!f) return;

                this.updateStat('money', -50);
                this.updateStat('energy', -10);
                f.relation = Math.min(100, f.relation + 15);

                UI.renderFriends();
                UI.log(`Llamaste a ${f.name}. Relaci√≥n mejorada.`, "normal");
                UI.render();
            },


            // --- PARTNER LOGIC ---
            findLove() {
                if (state.money < 100) return UI.showAlert("Sin dinero", "Necesitas $100 para salir a buscar citas.");
                this.updateStat('money', -100);
                this.updateStat('energy', -20);

                if (Math.random() < 0.35) {
                    // Success
                    const names = ["Valeria", "Gabriela", "Daniela", "Andrea", "Camila", "Juan", "Pedro", "Luis", "Javier"];
                    const name = names[Math.floor(Math.random() * names.length)];
                    const job = JOBS.filter(j => j.id !== 'unemployed')[Math.floor(Math.random() * (JOBS.length - 1))];

                    state.partner = {
                        name: name,
                        jobTitle: job.title,
                        salary: job.salary,
                        relation: 50,
                        status: 'dating'
                    };
                    UI.showAlert("¬°Flechazo! üíò", `Has conocido a ${name}. Es ${job.title}. ¬øSer√° el amor de tu vida?`);
                    UI.renderSocialTab();
                } else {
                    UI.log("Tuviste un par de citas malas. Nadie interesante.", "normal");
                }
                UI.render();
            },

            datePartner() {
                if (!state.partner) return;
                if (state.money < 80) return UI.showAlert("Sin dinero", "No puedes pagar la cena.");

                this.updateStat('money', -80);
                this.updateStat('energy', -15);
                this.updateStat('happiness', 5);

                state.partner.relation = Math.min(100, state.partner.relation + 10);
                UI.log(`Cita rom√°ntica con ${state.partner.name}. ‚ù§Ô∏è`, "good");
                UI.renderSocialTab();
                UI.render();
            },

            advanceRel() {
                if (!state.partner) return;
                const p = state.partner;

                if (p.status === 'dating') {
                    // Move in
                    p.status = 'living';
                    p.relation += 10;
                    this.updateStat('happiness', 20);
                    UI.showAlert("¬°Nuevo Hogar! üè†", "Ahora viv√≠s juntos. Los gastos se comparten (50%).");
                } else if (p.status === 'living') {
                    // Marry
                    if (state.money < 2000) return UI.showAlert("Anillo Caro", "Necesitas $2000 para el anillo.");
                    this.updateStat('money', -2000);
                    p.status = 'married';
                    p.relation = 100;
                    this.updateStat('happiness', 50);
                    UI.showAlert("¬°BODA! üíç", "¬°Vivan los novios! Estabilidad m√°xima.");
                }
                UI.renderSocialTab();
                UI.render();
            },

            breakup() {
                if (!state.partner) return;
                state.partner = null;
                this.updateStat('happiness', -30);
                UI.showAlert("Ruptura üíî", "Se acab√≥. Te sientes vac√≠o.");
                UI.renderSocialTab();
                UI.render();
            },

            socialDecay() {
                if (state.friends.length === 0) return;
                let msg = "";
                state.friends.forEach(f => {
                    f.relation -= 2;
                    if (f.relation < 0) f.relation = 0;
                    if (f.relation < 20) msg = `${f.name} se est√° olvidando de ti. `;
                });
                if (msg) UI.log(msg, "info");
            },

            processChildren() {
                state.children.forEach(child => {
                    child.ageMonths++;
                    if (child.ageMonths === 216) { // 18 Years
                        UI.showAlert("Hijo Independiente üéì", `${child.name} ha cumplido 18 a√±os y se va de casa. Ya no genera gastos.`);
                    }
                });
            },

            // --- HOUSING & VEHICLE SYSTEM ---

            buyHousing(housingId) {
                const housing = HOUSING.find(h => h.id === housingId);
                if (!housing) return;

                if (state.money < housing.cost) {
                    UI.log(`No tienes $${housing.cost.toLocaleString()} para ${housing.name}`, 'bad');
                    return;
                }

                state.money -= housing.cost;
                state.housing = housingId;
                this.updateStatus();
                UI.log(`üè† Compraste: ${housing.name}`, 'good');
                UI.render();
            },

            buyVehicle(vehicleId) {
                const vehicle = VEHICLES.find(v => v.id === vehicleId);
                if (!vehicle) return;

                if (state.money < vehicle.cost) {
                    UI.log(`No tienes $${vehicle.cost.toLocaleString()} para ${vehicle.name}`, 'bad');
                    return;
                }

                state.money -= vehicle.cost;
                state.vehicle = vehicleId;
                this.updateStatus();
                UI.log(`üöó Compraste: ${vehicle.name}`, 'good');
                UI.render();
            },

            updateStatus() {
                const housing = HOUSING.find(h => h.id === state.housing);
                const vehicle = VEHICLES.find(v => v.id === state.vehicle);
                state.status = (housing?.status || 0) + (vehicle?.status || 0);
            },

            showLifestyleShop() {
                // Open modal
                document.getElementById('lifestyle-modal').classList.add('active');

                // Update status bar
                this.updateLifestyleModalStatus();

                // Populate housing cards
                this.populateHousingCards();

                // Populate housing cards
                this.populateHousingCards();

                // Populate vehicle cards
                this.populateVehicleCards();

                // Populate pets
                this.populatePetCards();
            },

            updateLifestyleModalStatus() {
                const currentHousing = HOUSING.find(h => h.id === state.housing);
                const currentVehicle = VEHICLES.find(v => v.id === state.vehicle);

                document.getElementById('lifestyle-money').textContent = `$${state.money.toLocaleString()}`;
                document.getElementById('lifestyle-status').textContent = state.status;
                document.getElementById('lifestyle-current-housing').textContent = currentHousing.name;
                document.getElementById('lifestyle-current-vehicle').textContent = currentVehicle.name;
                document.getElementById('lifestyle-money').textContent = `$${state.money.toLocaleString()}`;
                document.getElementById('lifestyle-status').textContent = state.status;
                document.getElementById('lifestyle-current-housing').textContent = currentHousing.name;
                document.getElementById('lifestyle-current-vehicle').textContent = currentVehicle.name;
                document.getElementById('status-display-btn').textContent = state.status;
            },

            populatePetCards() {
                const grid = document.getElementById('pets-grid');
                if (!grid) return;
                grid.innerHTML = '';

                PETS.forEach(pet => {
                    const isOwned = state.pets.some(p => p.id === pet.id);
                    const canAfford = state.money >= pet.cost;

                    const card = document.createElement('div');
                    card.className = `lifestyle-card ${isOwned ? 'current' : ''}`;

                    card.innerHTML = `
                        <div class="lifestyle-card-title">${pet.name}</div>
                        <div class="lifestyle-card-desc">${pet.desc}</div>
                        <div class="lifestyle-card-stats">
                            <div class="lifestyle-card-stat">
                                <span class="lifestyle-card-stat-label">üí∞ Costo:</span>
                                <span class="lifestyle-card-stat-value">$${pet.cost}</span>
                            </div>
                            <div class="lifestyle-card-stat">
                                <span class="lifestyle-card-stat-label">üîß Mant/Mes:</span>
                                <span class="lifestyle-card-stat-value">$${pet.maint}</span>
                            </div>
                        </div>
                        <button class="lifestyle-card-btn" onclick="Game.adoptPet('${pet.id}')">
                            ${isOwned ? 'Adoptar Otro' : (canAfford ? 'Adoptar' : 'Sin Fondos')}
                        </button>
                    `;
                    grid.appendChild(card);
                });
            },

            populateHousingCards() {
                const grid = document.getElementById('housing-grid');
                grid.innerHTML = '';

                HOUSING.forEach(housing => {
                    const isCurrent = housing.id === state.housing;
                    const canAfford = state.money >= housing.cost;

                    const card = document.createElement('div');
                    card.className = `lifestyle-card ${isCurrent ? 'current' : ''}`;

                    card.innerHTML = `
                        <div class="lifestyle-card-title">${housing.name}</div>
                        <div class="lifestyle-card-desc">${housing.desc}</div>
                        <div class="lifestyle-card-stats">
                            <div class="lifestyle-card-stat">
                                <span class="lifestyle-card-stat-label">üí∞ Costo:</span>
                                <span class="lifestyle-card-stat-value">${housing.cost === 0 ? 'Gratis' : '$' + housing.cost.toLocaleString()}</span>
                            </div>
                            <div class="lifestyle-card-stat">
                                <span class="lifestyle-card-stat-label">üîß Mant/Mes:</span>
                                <span class="lifestyle-card-stat-value">$${housing.maint.toLocaleString()}</span>
                            </div>
                            <div class="lifestyle-card-stat">
                                <span class="lifestyle-card-stat-label">üòä Felicidad:</span>
                                <span class="lifestyle-card-stat-value ${housing.happiness >= 0 ? 'positive' : 'negative'}">${housing.happiness > 0 ? '+' : ''}${housing.happiness}</span>
                            </div>
                            <div class="lifestyle-card-stat">
                                <span class="lifestyle-card-stat-label">‚ö° Energ√≠a:</span>
                                <span class="lifestyle-card-stat-value ${housing.energyRecovery >= 0 ? 'positive' : 'negative'}">${housing.energyRecovery > 0 ? '+' : ''}${housing.energyRecovery}</span>
                            </div>
                            <div class="lifestyle-card-stat">
                                <span class="lifestyle-card-stat-label">‚≠ê Estatus:</span>
                                <span class="lifestyle-card-stat-value positive">+${housing.status}</span>
                            </div>
                        </div>
                        <button class="lifestyle-card-btn" ${isCurrent || !canAfford ? 'disabled' : ''} onclick="Game.buyHousingFromModal('${housing.id}')">
                            ${isCurrent ? '‚úì Actual' : (canAfford ? 'Comprar' : 'Sin Fondos')}
                        </button>
                    `;

                    grid.appendChild(card);
                });
            },

            populateVehicleCards() {
                const grid = document.getElementById('vehicles-grid');
                grid.innerHTML = '';

                VEHICLES.forEach(vehicle => {
                    const isCurrent = vehicle.id === state.vehicle;
                    const canAfford = state.money >= vehicle.cost;

                    const card = document.createElement('div');
                    card.className = `lifestyle-card ${isCurrent ? 'current' : ''}`;

                    card.innerHTML = `
                        <div class="lifestyle-card-title">${vehicle.name}</div>
                        <div class="lifestyle-card-desc">${vehicle.desc}</div>
                        <div class="lifestyle-card-stats">
                            <div class="lifestyle-card-stat">
                                <span class="lifestyle-card-stat-label">üí∞ Costo:</span>
                                <span class="lifestyle-card-stat-value">${vehicle.cost === 0 ? 'Gratis' : '$' + vehicle.cost.toLocaleString()}</span>
                            </div>
                            <div class="lifestyle-card-stat">
                                <span class="lifestyle-card-stat-label">üîß Mant/Mes:</span>
                                <span class="lifestyle-card-stat-value">$${vehicle.maint.toLocaleString()}</span>
                            </div>
                            <div class="lifestyle-card-stat">
                                <span class="lifestyle-card-stat-label">‚ö° Reduce Energ√≠a:</span>
                                <span class="lifestyle-card-stat-value positive">-${vehicle.energyReduction}</span>
                            </div>
                            <div class="lifestyle-card-stat">
                                <span class="lifestyle-card-stat-label">‚≠ê Estatus:</span>
                                <span class="lifestyle-card-stat-value positive">+${vehicle.status}</span>
                            </div>
                        </div>
                        <button class="lifestyle-card-btn" ${isCurrent || !canAfford ? 'disabled' : ''} onclick="Game.buyVehicleFromModal('${vehicle.id}')">
                            ${isCurrent ? '‚úì Actual' : (canAfford ? 'Comprar' : 'Sin Fondos')}
                        </button>
                    `;

                    grid.appendChild(card);
                });
            },

            buyHousingFromModal(housingId) {
                this.buyHousing(housingId);
                this.updateLifestyleModalStatus();
                this.populateHousingCards();
                this.populateVehicleCards();
            },

            buyVehicleFromModal(vehicleId) {
                this.buyVehicle(vehicleId);
                this.updateLifestyleModalStatus();
                this.populateHousingCards();
                this.populateVehicleCards();
            },

            renderCourses() {
                UI.els.btns.study.click(); // Hacky reuse of existing render logic in the study button handler
            },

            calculateFinancials() {
                // 1. Assets
                let cash = state.money;

                // Inv
                let investments = 0;
                ASSETS.forEach(a => {
                    investments += state.portfolio[a.id].qty * state.marketPrices[a.id];
                });

                // RE
                let realEstate = 0;
                let passiveIncome = 0;
                let reMaint = 0;

                state.realEstate.forEach(id => {
                    const price = state.rePrices[id];
                    const prop = REAL_ESTATE.find(p => p.id === id);
                    if (prop) {
                        realEstate += price;
                        passiveIncome += prop.rent;
                        reMaint += prop.maint;
                    }
                });

                // Net Passive (Rent - Maint)
                passiveIncome -= reMaint;

                // 2. Expenses
                const itemEffects = this.calculateItemEffects();
                const totalMaint = itemEffects.maint; // Items maint
                let baseLiving = CONFIG.costOfLiving;

                // PARTNER EFFECT
                let partnerIncome = 0;
                if (state.partner && (state.partner.status === 'living' || state.partner.status === 'married')) {
                    baseLiving /= 2; // Split costs
                    partnerIncome = state.partner.salary;
                }

                // DIET COST
                let dietCost = 0;
                if (state.diet === 'fast_food') dietCost = 100;
                else if (state.diet === 'balanced') dietCost = 300;
                else if (state.diet === 'chef') dietCost = 1000;

                const expenses = baseLiving + totalMaint + dietCost;

                // FAMILY EXPENSES
                // Pets
                let petCost = 0;
                state.pets.forEach(p => {
                    const def = PETS.find(x => x.id === p.id);
                    if (def) petCost += def.maint;
                });

                // Children
                let childCost = 0;
                state.children.forEach(c => {
                    if (c.ageMonths < 216) { // Under 18
                        childCost += CHILD_COST;
                    }
                });

                const totalExpenses = expenses + petCost + childCost;

                // Royalties
                let royalties = 0;
                if (state.creations) {
                    state.creations.forEach(c => royalties += c.royalty);
                }
                passiveIncome += royalties;

                // 3. Active
                const job = JOBS.find(j => j.id === state.currJobId);
                let activeIncome = job ? job.salary : 0;
                if (state.inventory.includes('suit')) activeIncome *= 1.1; // simplified reuse logic

                // Add partner income to active for display purposes mostly, or separate? 
                // Plan said "Household income". Let's add to active for simple Net calculation
                activeIncome += partnerIncome;

                return {
                    cash,
                    investments,
                    realEstate,
                    netWorth: cash + investments + realEstate,
                    passiveIncome, // Net
                    activeIncome,
                    expenses: totalExpenses,
                    breakdown: { base: expenses, pets: petCost, children: childCost }
                };
            }
        };

        // --- 5. SUPABASE LOGIC ---
        const DB = {
            user: null,

            async init() {
                if (!sb) return;
                try {
                    const { data: { session } } = await sb.auth.getSession();
                    this.user = session?.user || null;
                    UI.updateAuthUI(this.user);

                    sb.auth.onAuthStateChange((_event, session) => {
                        this.user = session?.user || null;
                        UI.updateAuthUI(this.user);
                    });
                } catch (e) { console.log("Supabase/Auth offline or not conn."); }
            },

            async login(email, password) {
                if (!sb) return UI.showAlert("Error", "Configura SUPABASE_URL en el c√≥digo.");
                UI.els.auth.msg.innerText = "Conectando...";

                // Try SignIn
                let { data, error } = await sb.auth.signInWithPassword({ email, password });

                if (error) {
                    // Try SignUp
                    console.log("Login failed, trying signup:", error.message);
                    const { data: signUpData, error: signUpError } = await sb.auth.signUp({ email, password });
                    if (signUpError) {
                        UI.els.auth.msg.innerText = "Error: " + signUpError.message;
                    } else {
                        UI.els.auth.msg.innerText = "¬°Registro exitoso!";
                    }
                } else {
                    UI.els.auth.msg.innerText = "";
                    UI.showAlert("Bienvenido", "Sesi√≥n iniciada correctamente.");
                    UI.els.modals.settings.classList.remove('active');
                }
            },

            async logout() {
                if (!sb) return;
                await sb.auth.signOut();
            },

            async saveGame() {
                if (!this.user) return;
                UI.els.auth.saveMsg.innerText = "Guardando...";

                const { error } = await sb
                    .from('saves')
                    .upsert({ user_id: this.user.id, game_data: state });

                if (error) {
                    UI.els.auth.saveMsg.innerText = "Error al guardar: " + error.message;
                } else {
                    UI.els.auth.saveMsg.innerText = "¬°Partida guardada!";
                    setTimeout(() => UI.els.auth.saveMsg.innerText = "Sesi√≥n activa.", 2000);
                }
            },

            async loadGame() {
                if (!this.user) return;
                UI.els.auth.saveMsg.innerText = "Cargando...";

                const { data, error } = await sb
                    .from('saves')
                    .select('game_data')
                    .single();

                if (error) {
                    UI.els.auth.saveMsg.innerText = "No se encontr√≥ partida guardada.";
                } else if (data) {
                    state = data.game_data;
                    UI.render();
                    Game.randomEvent(); // Just to refresh state/visuals maybe
                    UI.log("Partida cargada desde la nube.", "info");
                    UI.els.modals.settings.classList.remove('active');
                }
            },

            async submitScore(score) {
                if (!this.user || !sb) return;
                // Assuming 'leaderboard' table exists: id, user_id, email, score, created_at
                await sb.from('leaderboard').insert({
                    user_id: this.user.id,
                    email: this.user.email,
                    score: score
                });
            },

            async logHistory(month, fin) {
                if (!this.user || !sb) return;
                try {
                    await sb.from('game_history').insert({
                        user_id: this.user.id,
                        month: month,
                        net_worth: fin.netWorth,
                        cash: fin.cash,
                        assets: fin.investments + fin.realEstate
                    });
                } catch (e) { console.log("Log history fail", e); }
            }
        };

        // Activity Modal (Dynamic Courses)
        UI.els.btns.work.onclick = () => Game.work();
        UI.els.btns.study.onclick = () => {
            const list = document.getElementById('courses-list');
            list.innerHTML = '';

            COURSES.forEach(c => {
                const isActive = state.activeCourse && state.activeCourse.id === c.id;
                const isOwned = state.education && state.education.includes(c.id);

                let statusHtml = '';
                if (isActive) statusHtml = `<span style="color:#4dffea">En Curso (${state.activeCourse.monthsLeft} meses)</span>`;
                else if (isOwned) statusHtml = `<span style="color:#aaa">Completado</span>`;

                const btn = document.createElement('button');
                btn.className = 'act-btn';
                btn.onclick = () => Game.startCourse(c.id);
                if (isActive || isOwned) btn.disabled = true;

                btn.innerHTML = `
                    <div class="act-info">
                        <h4>${c.title}</h4>
                        <p>${c.duration} meses. Penalidad: -${c.penalty} Energ√≠a/mes.</p>
                        ${statusHtml}
                    </div>
                    <div class="act-cost">-$${c.cost}</div>
                 `;
                list.appendChild(btn);
            });

            UI.els.modals.act.classList.add('active');
        };
        UI.els.modals.closeAct.onclick = () => UI.els.modals.act.classList.remove('active');
        UI.els.btns.rest.onclick = () => Game.rest();
        UI.els.btns.next.onclick = () => Game.nextMonth();

        // Jobs Modal
        UI.els.jobTrigger.onclick = () => {
            const container = UI.els.modals.jobList;
            container.innerHTML = '';

            // Group by Career
            const careers = {
                'tech': 'Tecnolog√≠a',
                'corp': 'Corporativo',
                'sport': 'Deportes'
            };

            Object.entries(careers).forEach(([key, label]) => {
                const header = document.createElement('h3');
                header.style.cssText = "color: #fff; border-bottom: 1px solid #444; padding-bottom: 5px; margin-top:15px;";
                header.innerText = label;
                container.appendChild(header);

                JOBS.filter(j => j.career === key).forEach(job => {
                    const isCurrent = state.currJobId === job.id;
                    const div = document.createElement('div');
                    div.className = 'job-item';

                    // Build req string
                    let reqText = [];
                    if (job.req.int) reqText.push(`Int ${job.req.int}`);
                    if (job.req.exp) reqText.push(`Exp ${job.req.exp}`);
                    if (job.req.health) reqText.push(`Salud ${job.req.health}`);

                    div.innerHTML = `
                        <div class="job-details">
                            <h4>${job.title} ${isCurrent ? '(Actual)' : ''}</h4>
                            <p>Salario: $${job.salary}</p>
                            <div class="job-req">${reqText.join(' | ') || 'Sin requisitos'}</div>
                        </div>
                        ${!isCurrent ? `<button class="btn-select-job" onclick="Game.applyToJob('${job.id}')">Postular</button>` : ''}
                    `;
                    container.appendChild(div);
                });
            });

            UI.els.modals.job.classList.add('active');
        };
        UI.els.modals.closeJob.onclick = () => UI.els.modals.job.classList.remove('active');

        // Settings Modal
        UI.els.btns.settings.onclick = () => {
            const dietSel = document.getElementById('diet-selector');
            dietSel.value = state.diet;
            UI.els.modals.settings.classList.add('active');
        };
        document.getElementById('diet-selector').onchange = (e) => {
            state.diet = e.target.value;
            UI.log(`Dieta cambiada a: ${state.diet}`, "info");
        };
        UI.els.modals.closeSettings.onclick = () => UI.els.modals.settings.classList.remove('active');

        // Shop Modal
        UI.els.modals.shopBtn.onclick = () => {
            const container = UI.els.modals.shopList;
            container.innerHTML = '';
            SHOP_ITEMS.forEach(item => {
                const owned = state.inventory.includes(item.id);
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `
                    <div class="shop-details">
                        <h4>${item.name} ${owned ? '<span class="owned-tag">(En Posesi√≥n)</span>' : ''}</h4>
                        <p>${item.desc}</p>
                        <div class="shop-cost">$${item.price} ${item.maint > 0 ? `<span class="shop-maint">(-$${item.maint}/mes)</span>` : ''}</div>
                    </div>
                    <button class="btn-buy" onclick="Game.buyItem('${item.id}')" ${owned || state.money < item.price ? 'disabled' : ''}>
                        ${owned ? 'Comprado' : 'Comprar'}
                    </button>
                 `;
                container.appendChild(div);
            });
            UI.els.modals.shop.classList.add('active');
        };
        UI.els.modals.closeShop.onclick = () => UI.els.modals.shop.classList.remove('active');

        // Auth Listeners
        UI.els.auth.loginBtn.onclick = () => {
            const email = UI.els.auth.emailInput.value;
            const pass = UI.els.auth.passInput.value;
            if (email && pass) DB.login(email, pass);
        };
        UI.els.auth.logoutBtn.onclick = () => DB.logout();
        UI.els.auth.saveBtn.onclick = () => DB.saveGame();
        UI.els.auth.loadBtn.onclick = () => DB.loadGame();

        // Lifestyle Modal
        document.getElementById('close-lifestyle').onclick = () => {
            document.getElementById('lifestyle-modal').classList.remove('active');
        };

        // Home Modal
        document.getElementById('home-trigger').onclick = () => {
            document.getElementById('home-modal').classList.add('active');
            UI.renderMyHome();
        };
        document.getElementById('close-home-modal').onclick = () => {
            document.getElementById('home-modal').classList.remove('active');
        };

        // Init
        setTimeout(() => DB.init(), 500); // Small delay to ensure Supabase loads
        UI.render();

        // ============================================
        // DEV MODE (REMOVE IN PRODUCTION)
        // ============================================
        const DevMode = {
            keySequence: [],
            sequenceTimeout: null,
            longPressTimer: null,
            isAuthenticated: false,

            init() {
                // Check session auth
                this.isAuthenticated = sessionStorage.getItem('devModeAuth') === 'true';

                // Keyboard activation (d + e + v)
                document.addEventListener('keydown', (e) => this.handleKeyPress(e));

                // Long press activation on money display
                const moneyEl = document.getElementById('money-display');
                if (moneyEl) {
                    // Touch events (mobile)
                    moneyEl.addEventListener('touchstart', (e) => this.startLongPress(e));
                    moneyEl.addEventListener('touchend', () => this.cancelLongPress());
                    moneyEl.addEventListener('touchcancel', () => this.cancelLongPress());
                    moneyEl.addEventListener('touchmove', () => this.cancelLongPress()); // Cancel on scroll

                    // Mouse events (desktop)
                    moneyEl.addEventListener('mousedown', (e) => this.startLongPress(e));
                    moneyEl.addEventListener('mouseup', () => this.cancelLongPress());
                    moneyEl.addEventListener('mouseleave', () => this.cancelLongPress());
                }

                // Close button
                document.getElementById('close-dev-modal')?.addEventListener('click', () => {
                    this.closePanel();
                });

                // Auth button
                document.getElementById('dev-auth-btn')?.addEventListener('click', () => {
                    this.authenticate();
                });

                // Allow Enter key on password input
                document.getElementById('dev-password')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.authenticate();
                });
            },

            handleKeyPress(e) {
                const key = e.key.toLowerCase();
                this.keySequence.push(key);

                // Keep only last 3 keys
                if (this.keySequence.length > 3) {
                    this.keySequence.shift();
                }

                // Check if sequence matches 'dev'
                if (this.keySequence.join('') === 'dev') {
                    this.activate();
                    this.keySequence = [];
                }

                // Reset sequence after 2 seconds of inactivity
                clearTimeout(this.sequenceTimeout);
                this.sequenceTimeout = setTimeout(() => {
                    this.keySequence = [];
                }, 2000);
            },

            startLongPress(e) {
                // e.preventDefault(); // Removed to allow scrolling interaction
                this.longPressTimer = setTimeout(() => {
                    this.activate();
                }, 1500); // Reduced from 3000ms
            },

            cancelLongPress() {
                clearTimeout(this.longPressTimer);
            },

            activate() {
                if (this.isAuthenticated) {
                    this.showPanel();
                } else {
                    this.showAuthPrompt();
                }
            },

            showAuthPrompt() {
                const modal = document.getElementById('dev-modal');
                const authSection = document.getElementById('dev-auth');
                const contentSection = document.getElementById('dev-content');

                modal.classList.add('active');
                authSection.classList.remove('hidden');
                contentSection.classList.add('hidden');

                setTimeout(() => {
                    document.getElementById('dev-password')?.focus();
                }, 100);
            },

            authenticate() {
                const password = document.getElementById('dev-password').value;
                if (password === 'admin123') {
                    this.isAuthenticated = true;
                    sessionStorage.setItem('devModeAuth', 'true');
                    document.getElementById('dev-password').value = '';
                    this.showPanel();
                } else {
                    alert('‚ùå Invalid password');
                    document.getElementById('dev-password').value = '';
                }
            },

            showPanel() {
                const modal = document.getElementById('dev-modal');
                const authSection = document.getElementById('dev-auth');
                const contentSection = document.getElementById('dev-content');

                modal.classList.add('active');
                authSection.classList.add('hidden');
                contentSection.classList.remove('hidden');

                this.loadCurrentValues();
                this.refreshState();
            },

            closePanel() {
                document.getElementById('dev-modal').classList.remove('active');
            },

            // ========== CHEAT FUNCTIONS ==========

            addMoney() {
                Game.updateStat('money', 100000);
                UI.log('[DEV] üí∞ Added $100,000', 'good');
                this.refreshState();
            },

            maxStats() {
                state.physicalHealth = 100;
                state.mentalHealth = 100;
                state.happiness = 100;
                state.energy = 100;
                UI.render();
                UI.log('[DEV] ‚ö° All stats maxed to 100', 'good');
                this.refreshState();
            },

            advanceYear() {
                for (let i = 0; i < 12; i++) {
                    Game.nextMonth();
                }
                UI.log('[DEV] üìÖ Advanced 1 year (12 months)', 'info');
                this.refreshState();
            },

            // ========== UNIVERSAL STAT SETTER ==========

            setStat(statName) {
                // Map stat names to input IDs
                const inputMap = {
                    'money': 'dev-money',
                    'totalMonths': 'dev-age',
                    'physicalHealth': 'dev-phealth',
                    'mentalHealth': 'dev-mhealth',
                    'happiness': 'dev-happiness',
                    'energy': 'dev-energy',
                    'intelligence': 'dev-int',
                    'experience': 'dev-exp',
                    'jobXP': 'dev-jobxp',
                    'diet': 'dev-diet',
                    'housing': 'dev-housing',
                    'vehicle': 'dev-vehicle'
                };

                const inputId = inputMap[statName];
                if (!inputId) {
                    alert('‚ùå Unknown stat: ' + statName);
                    return;
                }

                const element = document.getElementById(inputId);
                if (!element) {
                    alert('‚ùå Input not found');
                    return;
                }

                // Handle select elements (diet, housing, vehicle)
                if (['diet', 'housing', 'vehicle'].includes(statName)) {
                    state[statName] = element.value;
                    if (statName === 'housing' || statName === 'vehicle') {
                        Game.updateStatus();
                    }
                    const emoji = { 'diet': 'üçΩÔ∏è', 'housing': 'üè†', 'vehicle': 'üöó' }[statName];
                    UI.log(`[DEV] ${emoji} ${statName} set to ${element.value}`, 'info');
                    UI.render();
                    this.refreshState();
                    return;
                }

                // Handle numeric values
                const val = parseInt(element.value);
                if (isNaN(val)) {
                    alert('‚ùå Please enter a valid number');
                    return;
                }

                // Apply value with appropriate constraints
                if (statName === 'money') {
                    state.money = val;
                    UI.log(`[DEV] üí∞ Money set to $${val.toLocaleString()}`, 'info');
                } else if (statName === 'totalMonths') {
                    state.totalMonths = Math.max(0, val);
                    UI.log(`[DEV] üìÖ Age set to ${val} months (${Math.floor(((18 * 12) + val) / 12)} years)`, 'info');
                } else if (['physicalHealth', 'mentalHealth', 'happiness', 'energy', 'intelligence', 'jobXP'].includes(statName)) {
                    state[statName] = Math.max(0, Math.min(100, val));
                    const emoji = {
                        'physicalHealth': 'üí™',
                        'mentalHealth': 'üß†',
                        'happiness': 'üòä',
                        'energy': '‚ö°',
                        'intelligence': 'üß†',
                        'jobXP': 'üíº'
                    }[statName];
                    UI.log(`[DEV] ${emoji} ${statName} set to ${val}`, 'info');
                } else if (statName === 'experience') {
                    state.experience = Math.max(0, val);
                    UI.log(`[DEV] üìà Experience set to ${val}`, 'info');
                } else {
                    state[statName] = val;
                    UI.log(`[DEV] ${statName} set to ${val}`, 'info');
                }

                UI.render();
                this.refreshState();
            },

            // ========== LOAD CURRENT VALUES ==========

            loadCurrentValues() {
                // Pre-populate all inputs with current values
                document.getElementById('dev-money').value = state.money;
                document.getElementById('dev-age').value = state.totalMonths;
                document.getElementById('dev-phealth').value = Math.floor(state.physicalHealth);
                document.getElementById('dev-mhealth').value = Math.floor(state.mentalHealth);
                document.getElementById('dev-happiness').value = Math.floor(state.happiness);
                document.getElementById('dev-energy').value = Math.floor(state.energy);
                document.getElementById('dev-int').value = Math.floor(state.intelligence);
                document.getElementById('dev-exp').value = state.experience;
                document.getElementById('dev-jobxp').value = Math.floor(state.jobXP);
                document.getElementById('dev-diet').value = state.diet;
                document.getElementById('dev-housing').value = state.housing;
                document.getElementById('dev-vehicle').value = state.vehicle;
            },

            refreshState() {
                const viewer = document.getElementById('dev-state-viewer');
                if (viewer) {
                    // Create a simplified state view for readability
                    const stateSnapshot = {
                        // Core Stats
                        money: state.money,
                        physicalHealth: state.physicalHealth,
                        mentalHealth: state.mentalHealth,
                        happiness: state.happiness,
                        energy: state.energy,
                        intelligence: state.intelligence,
                        experience: state.experience,

                        // Time
                        totalMonths: state.totalMonths,
                        age: Math.floor(((18 * 12) + state.totalMonths) / 12),

                        // Career
                        currJobId: state.currJobId,
                        jobXP: state.jobXP,
                        promotions: state.promotions,

                        // Lifestyle
                        diet: state.diet,
                        housing: state.housing,
                        vehicle: state.vehicle,
                        status: state.status,

                        // Relationships
                        partner: state.partner ? {
                            name: state.partner.name,
                            status: state.partner.status,
                            relation: state.partner.relation
                        } : null,
                        friendsCount: state.friends?.length || 0,

                        // Assets
                        inventory: state.inventory,
                        realEstateCount: state.realEstate?.length || 0,
                        education: state.education
                    };

                    viewer.textContent = JSON.stringify(stateSnapshot, null, 2);
                }
            }
        };

        // Trophy Listeners
        document.getElementById('trophy-trigger').onclick = () => Game.openTrophyGallery();
        document.getElementById('close-trophy-modal').onclick = () => document.getElementById('trophy-modal').classList.remove('active');

        // Initialize Dev Mode
        DevMode.init();
        console.log('üîß Dev Mode initialized. Press "d+e+v" or long-press money to activate.');

        // ============================================
        // PWA GLOBAL LISTENERS (Re-added)
        // ============================================

        // Global Click Sound
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                AudioSys.playClick();
                if (window.navigator && window.navigator.vibrate) Haptics.pulse();
            }
            // Init Audio Context on first interaction
            AudioSys.init();
        });

        // Offline Mode Detection
        window.addEventListener('offline', () => {
            GameUI.showAlert("üîå Modo Offline", "Has perdido la conexi√≥n. Jugando en modo local.");
            GameUI.floatText("Offline", "#aaa");
        });
        window.addEventListener('online', () => {
            GameUI.floatText("Online üåê", "#4dffea");
        });

    </script>
</body>

</html>