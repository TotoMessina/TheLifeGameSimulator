<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simulador de Vida: Pobre a Rico</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <!-- Import Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --text-color: #E0E0E0;
            --accent-color: #39FF14;
            /* Neon Green */
            --danger-color: #FF3939;
            --info-color: #4da6ff;
            --secondary-text: #A0A0A0;
            --font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            flex: 0 0 auto;
            background-color: #1a1a1a;
            padding: 15px;
            border-bottom: 1px solid #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .money-display {
            color: var(--accent-color);
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(57, 255, 20, 0.3);
            transition: color 0.3s, transform 0.2s;
        }

        .money-display.gain {
            color: #39FF14;
            transform: scale(1.1);
        }

        .money-display.loss {
            color: #FF3939;
            transform: scale(1.1);
        }

        /* Settings Button styled as transparent icon */
        .settings-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .date-display {
            color: var(--secondary-text);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .job-display {
            font-size: 0.8rem;
            color: #ddd;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            /* Stack title and bar */
            background: #252525;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #444;
            gap: 2px;
        }

        .job-xp-bg {
            height: 4px;
            background: #111;
            border-radius: 2px;
            width: 100%;
            overflow: hidden;
            margin-top: 2px;
        }

        .job-xp-fill {
            height: 100%;
            background: var(--info-color);
            width: 0%;
            transition: width 0.3s;
        }

        .job-row-top {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .bar-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bar-label {
            font-size: 0.75rem;
            color: var(--secondary-text);
            display: flex;
            justify-content: space-between;
        }

        .progress-bg {
            height: 6px;
            background-color: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 50%;
            transition: width 0.4s ease;
        }

        .health-fill {
            background-color: #ff4d4d;
        }

        .happiness-fill {
            background-color: #4dffea;
        }

        .intelligence-fill {
            background-color: #cf39ff;
        }

        .energy-fill {
            background-color: #ffd700;
        }

        @keyframes blinkRed {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        .critical {
            animation: blinkRed 1s infinite;
        }

        /* Activity Modal Buttons */
        .act-btn {
            background: #252525;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 10px;
            width: 100%;
            color: #fff;
            text-align: left;
        }

        .act-btn:active {
            background: #333;
        }

        .act-info h4 {
            margin: 0;
            color: var(--accent-color);
            font-size: 1rem;
        }

        .act-info p {
            margin: 2px 0 0;
            font-size: 0.8rem;
            color: #aaa;
        }

        .act-cost {
            text-align: right;
            font-size: 0.9rem;
            font-weight: bold;
            color: #ff6b6b;
        }


        /* --- Main Content (Log) --- */
        main {
            flex: 1 1 auto;
            position: relative;
            /* For floating text */
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scroll-behavior: smooth;
        }

        .float-text {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
            animation: floatUp 1.2s forwards;
            text-shadow: 1px 1px 2px black;
            z-index: 100;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                top: 40%;
                transform: translate(-50%, 0) scale(0.8);
            }

            50% {
                transform: translate(-50%, -20px) scale(1.2);
            }

            100% {
                opacity: 0;
                top: 20%;
                transform: translate(-50%, -40px) scale(1);
            }
        }

        .event-card {
            background-color: var(--card-bg);
            border-left: 3px solid var(--accent-color);
            padding: 12px 15px;
            border-radius: 4px;
            animation: fadeIn 0.4s ease-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-size: 0.95rem;
            line-height: 1.4;
            flex-shrink: 0;
        }

        .event-card.bad {
            border-left-color: var(--danger-color);
            color: #ffaaaa;
        }

        .event-card.good {
            border-left-color: var(--accent-color);
            color: #ccffcc;
        }

        .event-card.info {
            border-left-color: var(--info-color);
        }

        .event-date {
            font-size: 0.7rem;
            color: #666;
            display: block;
            margin-bottom: 3px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Event Choice Modal */
        .choice-btn {
            background-color: #333;
            color: #fff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #444;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
        }

        .choice-btn:active {
            background-color: #444;
        }

        .choice-text {
            display: block;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .choice-sub {
            font-size: 0.8rem;
            color: #aaa;
        }

        /* Shop Items */
        .shop-item {
            background: #252525;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shop-details h4 {
            margin: 0 0 5px 0;
            font-size: 0.95rem;
            color: var(--text-color);
        }

        .shop-details p {
            margin: 0;
            font-size: 0.8rem;
            color: #aaa;
        }

        .shop-cost {
            font-size: 0.85rem;
            color: var(--accent-color);
            font-weight: bold;
            margin-top: 4px;
        }

        .shop-maint {
            font-size: 0.75rem;
            color: #ff6b6b;
        }

        .btn-buy {
            padding: 6px 12px;
            font-size: 0.75rem;
            background: var(--accent-color);
            color: #000;
            border: none;
            border-radius: 4px;
            font-weight: bold;
        }

        .btn-buy:disabled {
            background: #444;
            color: #888;
        }

        .owned-tag {
            color: #4dffea;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Footer (Bottom Nav) */
        footer {
            flex: 0 0 auto;
            background-color: #1a1a1a;
            border-top: 1px solid #333;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            height: auto;
            min-height: 60px;
            padding: 4px;
            padding-bottom: max(4px, env(safe-area-inset-bottom));
        }

        footer button {
            background: transparent;
            border: none;
            border-radius: 4px;
            padding: 4px;
            color: #888;
            font-size: 0.65rem;
            gap: 2px;
            height: 100%;
        }

        footer button:active:not([disabled]) {
            background-color: #252525;
            transform: scale(0.95);
        }

        footer button.primary {
            background: transparent;
            color: var(--accent-color);
            box-shadow: none;
        }

        footer button .btn-icon {
            font-size: 1.4rem;
            display: block;
            margin-bottom: 2px;
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(0.8);
        }

        button.primary {
            background-color: var(--accent-color);
            color: #000;
            border: none;
            box-shadow: 0 0 8px rgba(57, 255, 20, 0.2);
        }

        button.primary:active:not([disabled]) {
            background-color: #2ecc12;
        }

        .btn-icon {
            font-size: 1.3rem;
            margin-bottom: 2px;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: #1E1E1E;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .modal-body {
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .job-item {
            background: #252525;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .job-details h4 {
            margin: 0 0 5px 0;
            font-size: 1rem;
            color: var(--accent-color);
        }

        .job-details p {
            margin: 0;
            font-size: 0.8rem;
            color: #aaa;
        }

        .job-req {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }

        .job-item.locked {
            opacity: 0.6;
        }

        .btn-select-job {
            padding: 6px 12px;
            font-size: 0.75rem;
            background: #444;
            color: #fff;
            border: none;
            border-radius: 4px;
        }

        .btn-select-job.active-job {
            background: var(--accent-color);
            color: #000;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #fff;
            padding: 0;
        }

        /* Settings specific */
        .settings-group {
            border: 1px solid #333;
            padding: 10px;
            border-radius: 6px;
            background: #252525;
        }

        .settings-group h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: #888;
        }

        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
        }

        .btn-full {
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            flex-direction: row;
        }

        .status-msg {
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: center;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <header>
        <div class="header-top">
            <div class="date-display" id="date-display">A√±o 18 - Mes 1</div>
            <button class="settings-btn" id="shop-trigger" style="margin-right:10px;">üõí</button>
            <button class="settings-btn" id="settings-trigger">‚öôÔ∏è</button>
        </div>

        <div class="stats-row">
            <div class="money-display" id="money-display">$0</div>
        </div>

        <div class="job-display" id="job-trigger">
            <div class="job-row-top">
                <span id="job-title-display">Mendigo ($0/mes)</span>
                <span>‚ÑπÔ∏è Cambiar</span>
            </div>
            <div class="job-xp-bg">
                <div class="job-xp-fill" id="job-xp-bar"></div>
            </div>
            <div id="diploma-display" style="font-size: 0.7rem; color: var(--accent-color); margin-top: 2px;"></div>
        </div>

        <div class="stat-grid">
            <!-- Row 1 -->
            <div class="bar-group">
                <div class="bar-label"><span>Salud</span> <span id="health-val">100%</span></div>
                <div class="progress-bg">
                    <div class="progress-fill health-fill" id="health-bar" style="width: 100%;"></div>
                </div>
            </div>
            <div class="bar-group">
                <div class="bar-label"><span>Felicidad</span> <span id="happiness-val">100%</span></div>
                <div class="progress-bg">
                    <div class="progress-fill happiness-fill" id="happiness-bar" style="width: 100%;"></div>
                </div>
            </div>
            <!-- Row 2 -->
            <div class="bar-group">
                <div class="bar-label"><span>Energ√≠a</span> <span id="energy-val">100%</span></div>
                <div class="progress-bg">
                    <div class="progress-fill energy-fill" id="energy-bar" style="width: 100%;"></div>
                </div>
            </div>
            <div class="bar-group">
                <div class="bar-label"><span>Inteligencia</span> <span id="intel-val">10</span></div>
                <div class="progress-bg">
                    <div class="progress-fill intelligence-fill" id="intel-bar" style="width: 10%;"></div>
                </div>
            </div>
        </div>
    </header>

    <main id="event-log">
        <div class="event-card info">
            <span class="event-date">Inicio</span>
            Bienvenido. Tienes 18 a√±os. Comienza tu historia.
        </div>
    </main>

    <footer>
        <button id="btn-work">
            <span class="btn-icon">üíº</span>Trabajar
        </button>
        <button id="btn-study">
            <span class="btn-icon">‚ö°</span>Mejorar
        </button>
        <button id="btn-rest">
            <span class="btn-icon">üí§</span>Descansar
        </button>
        <button id="btn-next" class="primary">
            <span class="btn-icon">üìÖ</span>Sig. Mes
        </button>
    </footer>

    <!-- Event Choice Modal -->
    <div class="modal-overlay" id="event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Evento</span>
            </div>
            <div class="modal-body">
                <p id="event-text" style="font-size: 1rem; line-height: 1.5; margin-bottom: 20px;">...</p>
                <div id="event-choices">
                    <!-- Choices injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Job Modal -->
    <div class="modal-overlay" id="job-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Oportunidades de Empleo</span>
                <button class="close-btn" id="close-job-modal">&times;</button>
            </div>
            <div class="modal-body" id="job-list-container">
                <!-- Job items injected here -->
            </div>
        </div>
    </div>

    <!-- Generic Alert Modal -->
    <div class="modal-overlay" id="end-game-modal" style="z-index: 200;">
        <div class="modal-content">
            <h2>¬°Jubilaci√≥n! üë¥</h2>
            <div id="end-game-summary" style="margin: 20px 0; text-align: left;"></div>
            <h3 id="end-game-score" style="color: var(--gold-color); text-align: center; font-size: 1.5rem;"></h3>

            <h4 style="margin-top:20px; border-bottom:1px solid #333;">Legado (Herencia)</h4>
            <p style="font-size:0.9rem; color:#aaa;">Elige qu√© dejarle a tu pr√≥xima vida:</p>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="act-btn" onclick="Game.claimLegacy('money')">
                    <div class="act-info">
                        <h4>Fortuna</h4>
                        <p>Hereda el 10% de tu dinero.</p>
                    </div>
                </button>
                <button class="act-btn" onclick="Game.claimLegacy('genetics')">
                    <div class="act-info">
                        <h4>Gen√©tica</h4>
                        <p>Hereda el 20% de tu Inteligencia.</p>
                    </div>
                </button>
            </div>

            <div style="margin-top:20px;">
                <button class="btn-select-job" style="width:100%" onclick="Game.restartGame()">Nueva Vida (Sin
                    Herencia)</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="alert-modal" style="z-index: 100;">
        <div class="modal-content" style="max-width:300px; text-align: center;">
            <div class="modal-body">
                <h3 id="alert-title" style="margin-top:0; color:var(--text-color);">Alerta</h3>
                <p id="alert-msg" style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">Mensaje</p>
                <button class="btn-full primary" id="alert-ok-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- Activity Modal -->
    <div class="modal-overlay" id="activity-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Actividades</span>
                <button class="close-btn" id="close-act-modal">&times;</button>
            </div>
            <div class="modal-body">
                <h4 style="margin-top:0; color:#aaa; border-bottom:1px solid #333; padding-bottom:5px;">Acciones R√°pidas
                </h4>
                <button class="act-btn" onclick="Game.doActivity('study')">
                    <div class="act-info">
                        <h4>Estudiar</h4>
                        <p>Mejora tu Inteligencia.</p>
                    </div>
                    <div class="act-cost">-$200<br>-25 E</div>
                </button>
                <button class="act-btn" onclick="Game.doActivity('gym')">
                    <div class="act-info">
                        <h4>Gimnasio</h4>
                        <p>Ejercicio moderado.</p>
                    </div>
                    <div class="act-cost">-$40<br>-20 E</div>
                </button>
                <button class="act-btn" onclick="Game.doActivity('marathon')">
                    <div class="act-info">
                        <h4>Marat√≥n</h4>
                        <p>Gran impulso a Salud y Felicidad.</p>
                    </div>
                    <div class="act-cost">-$100<br>-50 E</div>
                </button>

                <h4 style="margin-top:20px; color:#aaa; border-bottom:1px solid #333; padding-bottom:5px;">Educaci√≥n
                    Superior</h4>
                <div id="courses-list">
                    <!-- Courses injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Shop Modal -->
    <div class="modal-overlay" id="shop-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Mercado & Inventario</span>
                <button class="close-btn" id="close-shop-modal">&times;</button>
            </div>
            <div class="modal-body" id="shop-list-container">
                <!-- Shop items injected here -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Ajustes & Guardado</span>
                <button class="close-btn" id="close-settings-modal">&times;</button>
            </div>
            <div class="modal-body">

                <!-- Auth Section -->
                <div class="settings-group" id="auth-section">
                    <h4>Cuenta (Cloud Save)</h4>
                    <div id="auth-form">
                        <input type="email" id="email-input" placeholder="Email">
                        <input type="password" id="pass-input" placeholder="Contrase√±a">
                        <button class="btn-full primary" id="btn-login">Iniciar / Registrar</button>
                    </div>
                    <div id="user-info" class="hidden">
                        <p style="font-size: 0.85rem; margin-bottom:10px;">Usuario: <span id="user-email"></span></p>
                        <button class="btn-full" id="btn-logout">Cerrar Sesi√≥n</button>
                    </div>
                    <div class="status-msg" id="auth-msg"></div>
                </div>

                <!-- Save/Load Section -->
                <div class="settings-group">
                    <h4>Partida</h4>
                    <button class="btn-full" id="btn-save" disabled>üíæ Guardar en Nube</button>
                    <button class="btn-full" id="btn-load" disabled>üìÇ Cargar de Nube</button>
                    <div class="status-msg" id="save-msg">Inicia sesi√≥n para guardar.</div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE CONFIG ---
        // TODO: Replace with your actual Supabase URL and Key
        const SUPABASE_URL = 'https://ulqifkyuklkjywlpkauw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVscWlma3l1a2xranl3bHBrYXV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyODE0ODQsImV4cCI6MjA4NTg1NzQ4NH0.CVgCUF_Hy06Ks2Q0xyJiKUBsx_G-y5PA59ArRRtLjYE';

        let sb = null;
        try {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
                sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch (e) {
            console.error("Supabase init error:", e);
        }

        // --- 1. CONFIG & DATA ---
        const CONFIG = {
            startAge: 18,
            costOfLiving: 500,
            studyCost: 200,
            baseWage: 0 // Base added to job salary if relevant
        };

        const JOBS = [
            // None
            { id: 'unemployed', title: 'Sin Empleo', salary: 0, career: 'none', req: {} },

            // Tech Path (Inteligence Focus)
            { id: 'tech_trainee', title: 'Trainee IT', salary: 800, career: 'tech', req: { int: 20 } },
            { id: 'tech_jr', title: 'Junior Dev', salary: 1500, career: 'tech', req: { int: 40, exp: 5 } },
            { id: 'tech_sr', title: 'Senior Dev', salary: 3500, career: 'tech', req: { int: 70, exp: 20, deg: 'dev_bootcamp' } },
            { id: 'tech_cto', title: 'CTO', salary: 8000, career: 'tech', req: { int: 90, exp: 50, deg: 'dev_bootcamp' } },

            // Corporate Path (Balanced)
            { id: 'corp_assist', title: 'Asistente', salary: 1000, career: 'corp', req: { int: 15, happy: 50 } },
            { id: 'corp_analyst', title: 'Analista', salary: 2000, career: 'corp', req: { int: 40, exp: 10 } },
            { id: 'corp_manager', title: 'Gerente', salary: 4000, career: 'corp', req: { int: 60, exp: 30 } },
            { id: 'corp_ceo', title: 'CEO', salary: 12000, career: 'corp', req: { int: 85, exp: 70, deg: 'mba_biz' } },

            // Sports Path (Health/Energy Focus)
            { id: 'sport_amateur', title: 'Amateur Deport.', salary: 500, career: 'sport', req: { health: 60, energy: 50 } },
            { id: 'sport_pro', title: 'Deportista Pro', salary: 3000, career: 'sport', req: { health: 80, exp: 10 } },
            { id: 'sport_star', title: 'Estrella Mundial', salary: 15000, career: 'sport', req: { health: 95, exp: 40, happy: 70, deg: 'sport_cert' } },
            { id: 'sport_legend', title: 'Leyenda', salary: 25000, career: 'sport', req: { health: 100, exp: 80, deg: 'sport_cert' } }
        ];

        const COURSES = [
            { id: 'dev_bootcamp', title: 'Bootcamp Full Stack', cost: 5000, duration: 6, penalty: 30, degree: 'Dev Certified' },
            { id: 'mba_biz', title: 'MBA Ejecutivo', cost: 15000, duration: 12, penalty: 40, degree: 'Master Business' },
            { id: 'sport_cert', title: 'Certificaci√≥n Entrenador', cost: 3000, duration: 4, penalty: 20, degree: 'Coach Lic.' }
        ];

        const SHOP_ITEMS = [
            { id: 'book_stats', name: 'Libros T√©cnicos', price: 150, maint: 0, desc: '+10% ganancia al Estudiar', effect: { type: 'study_boost', val: 1.1 } },
            { id: 'bike', name: 'Bicicleta', price: 300, maint: 0, desc: 'Reduce costos transporte (-$20/mes)', effect: { type: 'col_red', val: 20 } },
            { id: 'phone', name: 'Smartphone Alta Gama', price: 800, maint: 20, desc: '+2 Felicidad/mes', effect: { type: 'happy_boost', val: 2 } },
            { id: 'suit', name: 'Traje Elegante', price: 500, maint: 0, desc: '+10% Salario (Oficina)', effect: { type: 'wage_mult', val: 1.1 } }, // Simplified to all jobs for MVP
            { id: 'laptop', name: 'Laptop Gamer', price: 2000, maint: 0, desc: '+20% Salario (Devs) y Felicidad', effect: { type: 'wage_mult_high', val: 1.2 } },
            { id: 'car', name: 'Autom√≥vil', price: 5000, maint: 200, desc: 'Gran estatus (+5 Felicidad/mes)', effect: { type: 'happy_boost', val: 5 } },
            { id: 'apt', name: 'Apartamento Lujoso', price: 50000, maint: 800, desc: 'Vida de rico. +20 Felicidad/mes', effect: { type: 'happy_boost', val: 20 } }
        ];

        // --- EVENTS DB ---
        const EVENTS = [
            // Instant Events
            { id: 1, type: 'instant', text: "Encontraste $50 en el suelo.", effect: (s) => ({ money: 50, msg: "¬°Suerte! +$50", type: 'good' }) },
            { id: 2, type: 'instant', text: "Perdiste tu billetera.", effect: (s) => ({ money: -100, happiness: -5, msg: "Qu√© mala suerte. -$100", type: 'bad' }) },
            { id: 3, type: 'instant', text: "Te enfermaste de gripe.", effect: (s) => ({ health: -10, energy: -20, msg: "Gripe fuerte. -Salud, -Energ√≠a", type: 'bad' }) },
            { id: 4, type: 'instant', text: "Un amigo te invita a cenar.", effect: (s) => ({ happiness: 10, msg: "Cena gratis. +Felicidad", type: 'good' }) },
            { id: 5, type: 'instant', text: "Tu ropa se rompi√≥.", effect: (s) => ({ money: -50, msg: "Gastos de ropa. -$50", type: 'bad' }) },

            // Choice Events
            {
                id: 6, type: 'choice', text: "Te ofrecen un 'negocio' r√°pido pero dudoso.",
                choices: [
                    {
                        text: "Aceptar (Riesgo)", sub: "Ganar mucho o perder mucho", action: (s) => {
                            return Math.random() > 0.5
                                ? { money: 1000, msg: "¬°Sali√≥ bien! Ganaste $1000", type: 'good' }
                                : { money: -500, happiness: -10, msg: "Era una estafa. Perdiste $500", type: 'bad' };
                        }
                    },
                    { text: "Rechazar", sub: "Mejor prevenir", action: (s) => ({ happiness: 2, msg: "Evitaste problemas.", type: 'info' }) }
                ]
            },
            {
                id: 7, type: 'choice', text: "Tu jefe te pide trabajar horas extra no pagadas.",
                choices: [
                    { text: "Hacerlo", sub: "Ganas experiencia, pierdes energ√≠a", action: (s) => ({ experience: 2, energy: -30, happiness: -5, msg: "Tu jefe lo valora. +Exp", type: 'info' }) },
                    { text: "Negarse", sub: "Mantienes dignidad", action: (s) => ({ happiness: 5, msg: "Te respetaste a ti mismo. +Felicidad", type: 'good' }) }
                ]
            },
            {
                id: 8, type: 'choice', text: "Oferta de curso online con descuento.",
                choices: [
                    {
                        text: "Comprar ($150)", sub: "+Inteligencia", action: (s) => {
                            if (s.money < 150) return { msg: "No tienes dinero suficiente.", type: 'bad' };
                            return { money: -150, intelligence: 5, msg: "Aprendiste mucho. +Int", type: 'good' };
                        }
                    },
                    { text: "No gracias", sub: "Ahorrar dinero", action: (s) => ({ msg: "Pasaste la oferta.", type: 'info' }) }
                ]
            },
            {
                id: 9, type: 'choice', text: "Un mendigo te pide ayuda.",
                choices: [
                    {
                        text: "Dar $10", sub: "Te sientes bien", action: (s) => {
                            if (s.money < 10) return { msg: "No tienes cambio.", type: 'info' };
                            return { money: -10, happiness: 5, msg: "Ayudaste a alguien. +Felicidad", type: 'good' };
                        }
                    },
                    { text: "Ignorar", sub: "Nada cambia", action: (s) => ({ msg: "Seguiste caminando.", type: 'info' }) }
                ]
            },
            {
                id: 10, type: 'choice', text: "Encuentras un gatito abandonado.",
                choices: [
                    { text: "Adoptarlo ($50/mes)", sub: "+Felicidad constante, -Dinero", action: (s) => ({ money: -100, happiness: 15, msg: "Tienes mascota nueva (Gastos veterinario -$100).", type: 'good' }) },
                    { text: "Llevarlo a refugio", sub: "Haces lo correcto", action: (s) => ({ happiness: 2, msg: "El gatito est√° a salvo.", type: 'info' }) }
                ]
            }
        ];

        // --- 2. GAME STATE ---
        let state = {
            totalMonths: 0,
            money: 600,
            health: 100,
            happiness: 100,
            intelligence: 10,
            energy: 100,
            experience: 0,
            experience: 0,
            currJobId: 'unemployed',
            jobXP: 0,
            promotions: 0,
            education: [],
            activeCourse: null,
            inventory: [],
            consecutiveWork: 0,
            sickDuration: 0
        };

        // Load Legacy
        const legacyData = JSON.parse(localStorage.getItem('lifeSim_legacy'));
        if (legacyData) {
            if (legacyData.type === 'money') state.money += legacyData.val;
            if (legacyData.type === 'genetics') state.intelligence += legacyData.val;
            console.log("Legacy loaded:", legacyData);
            // Clear legacy after loading so it's one-time use
            localStorage.removeItem('lifeSim_legacy');
        }

        // --- 3. UI CONTROLLER ---
        const UI = {
            els: {
                date: document.getElementById('date-display'),
                money: document.getElementById('money-display'),
                jobTitle: document.getElementById('job-title-display'),
                jobTrigger: document.getElementById('job-trigger'),
                bars: {
                    health: document.getElementById('health-bar'),
                    happy: document.getElementById('happiness-bar'),
                    energy: document.getElementById('energy-bar'),
                    intel: document.getElementById('intel-bar'),
                },
                vals: {
                    health: document.getElementById('health-val'),
                    happy: document.getElementById('happiness-val'),
                    energy: document.getElementById('energy-val'),
                    intel: document.getElementById('intel-val'),
                },
                log: document.getElementById('event-log'),
                btns: {
                    work: document.getElementById('btn-work'),
                    study: document.getElementById('btn-study'),
                    rest: document.getElementById('btn-rest'),
                    next: document.getElementById('btn-next'),
                    settings: document.getElementById('settings-trigger')
                },
                modals: {
                    job: document.getElementById('job-modal'),
                    jobList: document.getElementById('job-list-container'),
                    closeJob: document.getElementById('close-job-modal'),
                    settings: document.getElementById('settings-modal'),
                    closeSettings: document.getElementById('close-settings-modal'),
                    event: document.getElementById('event-modal'),
                    eventText: document.getElementById('event-text'),
                    eventChoices: document.getElementById('event-choices'),
                    shop: document.getElementById('shop-modal'),
                    shopList: document.getElementById('shop-list-container'),
                    closeShop: document.getElementById('close-shop-modal'),
                    shopBtn: document.getElementById('shop-trigger'),
                    act: document.getElementById('activity-modal'),
                    closeAct: document.getElementById('close-act-modal'),
                    closeAct: document.getElementById('close-act-modal'),
                    endGame: document.getElementById('end-game-modal'),
                    endSummary: document.getElementById('end-game-summary'),
                    endScore: document.getElementById('end-game-score'),
                    alert: document.getElementById('alert-modal'),
                    alertTitle: document.getElementById('alert-title'),
                    alertMsg: document.getElementById('alert-msg'),
                    alertBtn: document.getElementById('alert-ok-btn')
                },
                auth: {
                    section: document.getElementById('auth-section'),
                    form: document.getElementById('auth-form'),
                    userInfo: document.getElementById('user-info'),
                    email: document.getElementById('user-email'),
                    msg: document.getElementById('auth-msg'),
                    loginBtn: document.getElementById('btn-login'),
                    logoutBtn: document.getElementById('btn-logout'),
                    emailInput: document.getElementById('email-input'),
                    passInput: document.getElementById('pass-input'),
                    saveBtn: document.getElementById('btn-save'),
                    loadBtn: document.getElementById('btn-load'),
                    saveMsg: document.getElementById('save-msg')
                }
            },

            render() {
                // Date
                const totalM = (CONFIG.startAge * 12) + state.totalMonths;
                const yrs = Math.floor(totalM / 12);
                const mos = (totalM % 12) + 1;
                this.els.date.innerText = `A√±o ${yrs} - Mes ${mos}`;

                this.els.date.innerText = `A√±o ${yrs} - Mes ${mos}`;

                // Money Animation
                this.animateNumber(this.els.money, parseInt(this.els.money.innerText.replace(/[^0-9-]/g, '')) || 0, state.money);

                // Job
                const job = JOBS.find(j => j.id === state.currJobId) || JOBS[0];
                this.els.jobTitle.innerText = `${job.title} ($${job.salary}/mes)`;
                // XP Bar
                document.getElementById('job-xp-bar').style.width = `${state.jobXP}%`;

                // Calculate Energy Cost for display (optional, but good for UX)
                let energyCost = Math.max(10, 30 - (state.promotions * 2));
                const workBtnIcon = this.els.btns.work.querySelector('.btn-icon');

                // Diploma Display
                const diploContainer = document.getElementById('diploma-display');
                if (state.education && state.education.length > 0) {
                    diploContainer.innerHTML = 'üéì ' + state.education.map(d => COURSES.find(c => c.id === d)?.degree || d).join(', ');
                } else {
                    diploContainer.innerHTML = '';
                }

                // Active Course Status (in log or header? header is full. maybe just toast logic on nextMonth)

                // Bars

                // Bars
                const setBar = (type, val, max = 100) => {
                    const pct = Math.min(100, Math.max(0, (val / max) * 100));
                    this.els.bars[type].style.width = `${pct}%`;
                    this.els.vals[type].innerText = type === 'intel' ? val : `${Math.floor(val)}%`;
                };

                setBar('health', state.health);
                if (state.health < 20) this.els.bars.health.classList.add('critical');
                else this.els.bars.health.classList.remove('critical');

                setBar('happy', state.happiness);
                setBar('energy', state.energy);
                setBar('intel', state.intelligence, 100);

                // Button States (Energy Check)
                const hasEnergy = state.energy >= 20;
                const isSick = state.sickDuration > 0;

                this.els.btns.work.disabled = !hasEnergy || isSick;
                this.els.btns.study.disabled = !hasEnergy; // This is now 'Mejorar' btn
                this.els.btns.rest.disabled = state.energy >= 100;

                if (isSick) {
                    this.els.btns.work.innerHTML = '<span class="btn-icon">ü§í</span>Enfermo';
                } else {
                    this.els.btns.work.innerHTML = '<span class="btn-icon">üíº</span>Trabajar';
                }

                // Auto Scroll
                setTimeout(() => {
                    this.els.log.scrollTop = this.els.log.scrollHeight;
                }, 50);
            },

            log(msg, type = 'normal') {
                const card = document.createElement('div');
                card.className = `event-card ${type}`;
                const totalM = (CONFIG.startAge * 12) + state.totalMonths;
                const yrs = Math.floor(totalM / 12);
                const mos = (totalM % 12) + 1;

                card.innerHTML = `<span class="event-date">A√±o ${yrs}/${mos}</span>${msg}`;
                this.els.log.appendChild(card);
            },

            floatText(text, color) {
                const el = document.createElement('div');
                el.className = 'float-text';
                el.innerText = text;
                el.style.color = color;
                el.style.left = (50 + (Math.random() * 20 - 10)) + '%';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 1300);
            },

            flashMoney(amount) {
                const el = this.els.money;
                const isGain = amount > 0;
                el.classList.remove('gain', 'loss');
                void el.offsetWidth;
                el.classList.add(isGain ? 'gain' : 'loss');

                const color = isGain ? '#39FF14' : '#FF3939';
                const sign = isGain ? '+' : '';
                this.floatText(`${sign}$${Math.abs(amount)}`, color);
            },

            updateAuthUI(user) {
                if (user) {
                    this.els.auth.form.classList.add('hidden');
                    this.els.auth.userInfo.classList.remove('hidden');
                    this.els.auth.email.innerText = user.email;
                    this.els.auth.saveBtn.disabled = false;
                    this.els.auth.loadBtn.disabled = false;
                    this.els.auth.saveMsg.innerText = "Sesi√≥n activa.";
                    this.els.auth.saveMsg.style.color = "#4dffea";
                } else {
                    this.els.auth.form.classList.remove('hidden');
                    this.els.auth.userInfo.classList.add('hidden');
                    this.els.auth.email.innerText = "";
                    this.els.auth.saveBtn.disabled = true;
                    this.els.auth.loadBtn.disabled = true;
                    this.els.auth.saveMsg.innerText = "Inicia sesi√≥n para guardar.";
                    this.els.auth.saveMsg.style.color = "#888";
                }
            },

            animateNumber(el, start, end) {
                if (start === end) return;
                const duration = 500;
                const startTime = performance.now();

                const step = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    // Ease out quart
                    const ease = 1 - Math.pow(1 - progress, 4);

                    const current = Math.floor(start + (end - start) * ease);
                    el.innerText = `$${current.toLocaleString()}`;

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        el.innerText = `$${end.toLocaleString()}`; // Ensure final value
                    }
                };
                requestAnimationFrame(step);
            },

            showAlert(title, msg, callback) {
                this.els.modals.alertTitle.innerText = title;
                this.els.modals.alertMsg.innerText = msg;
                this.els.modals.alert.classList.add('active');
                this.els.modals.alertBtn.onclick = () => {
                    this.els.modals.alert.classList.remove('active');
                    if (callback) callback();
                };
            }
        };

        // --- 4. GAME LOGIC ---
        const Game = {
            checkGameOver() {
                if (state.health <= 0) {
                    UI.showAlert("GAME OVER", "Has muerto debido a tu mala salud. ‚ò†Ô∏è", () => location.reload()); // Simple reload for death
                    return true;
                }
                // Retirement Check (Age 65 = 47 years * 12 months = 564 months)
                if (state.totalMonths >= 564) {
                    this.showEndGame();
                    return true;
                }
                return false;
            },

            calculateScore() {
                let score = 0;
                score += state.money * 0.01;
                score += state.happiness * 50;
                score += state.intelligence * 20;
                score += state.education.length * 1000;

                const job = JOBS.find(j => j.id === state.currJobId);
                if (job) score += job.salary * 0.5;

                return Math.floor(score);
            },

            showEndGame() {
                const score = this.calculateScore();

                // Submit Score (Fire & Forget)
                DB.submitScore(score);

                UI.els.modals.endSummary.innerHTML = `
                    <p><strong>Edad Final:</strong> 65 a√±os</p>
                    <p><strong>Dinero:</strong> $${state.money.toLocaleString()}</p>
                    <p><strong>Felicidad:</strong> ${Math.floor(state.happiness)}%</p>
                    <p><strong>T√≠tulos:</strong> ${state.education.length}</p>
                    <p><strong>√öltimo Trabajo:</strong> ${JOBS.find(j => j.id === state.currJobId)?.title || 'N/A'}</p>
                `;
                UI.els.modals.endScore.innerText = `Puntuaci√≥n Final: ${score}`;
                UI.els.modals.endGame.classList.add('active');
            },

            claimLegacy(type) {
                let val = 0;
                if (type === 'money') val = Math.floor(state.money * 0.1);
                if (type === 'genetics') val = Math.floor(state.intelligence * 0.2);

                localStorage.setItem('lifeSim_legacy', JSON.stringify({ type, val }));
                location.reload();
            },

            restartGame() {
                location.reload();
            },

            updateStat(key, amount) {
                state[key] += amount;
                if (key !== 'money' && key !== 'intelligence' && key !== 'experience') {
                    if (state[key] > 100) state[key] = 100;
                    if (state[key] < 0) state[key] = 0;
                }
                if (key === 'money') UI.flashMoney(amount);
            },

            work() {
                if (state.sickDuration > 0) {
                    UI.log("Est√°s demasiado enfermo para trabajar.", "bad");
                    return;
                }
                if (state.energy < 20) return;

                // Burnout Check
                state.consecutiveWork++;
                if (state.consecutiveWork > 2) {
                    this.updateStat('health', -10);
                    this.updateStat('happiness', -15);
                    UI.log("¬°BURNOUT! Est√°s trabajando demasiado seguido. Descansa un poco.", "bad");
                }

                const job = JOBS.find(j => j.id === state.currJobId);
                if (state.currJobId === 'unemployed') {
                    UI.log("No tienes empleo. Consigue uno tocando la barra de arriba.", "info");
                    return;
                }

                // Check for Promotion triggers
                if (state.jobXP >= 100) {
                    this.triggerPerformanceReview(job);
                    return;
                }

                let earned = job.salary;

                // Item Effects: Wage Multiplier
                if (state.inventory.includes('suit')) earned *= 1.1;
                if (state.inventory.includes('laptop') && (job.career === 'tech')) earned *= 1.2;

                // Energy Cost with Efficiency Bonus
                let energyCost = Math.max(10, 30 - (state.promotions * 2));

                this.updateStat('money', Math.floor(earned));
                this.updateStat('energy', -energyCost);
                this.updateStat('health', -2);
                this.updateStat('experience', 1);

                // XP Gain
                if (job.career !== 'none') {
                    state.jobXP = Math.min(100, state.jobXP + 10);
                }

                UI.log(`Trabajaste como ${job.title}. Ganaste $${Math.floor(earned)}.`, "normal");
                UI.render();
            },

            triggerPerformanceReview(currentJob) {
                this.showEventModal({
                    text: "EVALUACI√ìN DE DESEMPE√ëO: Has alcanzado el m√°ximo de experiencia en tu puesto actual. ¬øQu√© har√°s?",
                    choices: [
                        {
                            text: "Exigir Ascenso",
                            sub: "Riesgo alto. Si fallas, pierdes felicidad. Si ganas, asciendes.",
                            action: () => {
                                // 70% chance success
                                if (Math.random() < 0.7) {
                                    this.promote(currentJob);
                                    return { msg: "¬°Ascenso concedido! Tu audacia dio frutos.", type: 'good' };
                                } else {
                                    state.jobXP = 50; // Setback
                                    state.happiness -= 20;
                                    return { msg: "Tu jefe se ri√≥ en tu cara. Int√©ntalo m√°s tarde.", type: 'bad' };
                                }
                            }
                        },
                        {
                            text: "Esperar turno",
                            sub: "Seguro. Tarde o temprano te ascender√°n.",
                            action: () => {
                                this.promote(currentJob);
                                return { msg: "Tu paciencia fue recompensada (eventualmente). Ascendido.", type: 'good' };
                            }
                        }
                    ]
                });
            },

            promote(currentJob) {
                // Find next job in same career
                const careerJobs = JOBS.filter(j => j.career === currentJob.career);
                const currentIndex = careerJobs.findIndex(j => j.id === currentJob.id);

                if (currentIndex >= 0 && currentIndex < careerJobs.length - 1) {
                    const nextJob = careerJobs[currentIndex + 1];
                    state.currJobId = nextJob.id;
                    state.jobXP = 0;
                    state.promotions++;
                } else {
                    // Top of ladder
                    state.jobXP = 100; // Keep at max
                    // Maybe give a bonus?
                    this.updateStat('money', 5000);
                    UI.log("¬°Eres una leyenda en tu campo! Bono de $5000.", "good");
                }
            },

            doActivity(type) {
                if (state.energy < 20) return;

                if (type === 'study') {
                    if (state.money < CONFIG.studyCost) return UI.log("Dinero insuficiente.", "bad");
                    this.updateStat('money', -CONFIG.studyCost);
                    this.updateStat('energy', -25);

                    let gain = 2 + Math.floor(state.intelligence * 0.05);
                    // Item Effect
                    if (state.inventory.includes('book_stats')) gain = Math.ceil(gain * 1.5);

                    this.updateStat('intelligence', gain);
                    UI.log(`Estudiaste intensamente. +${gain} Int.`, "info");
                }
                else if (type === 'gym') {
                    if (state.money < 40) return UI.log("Dinero insuficiente.", "bad");
                    this.updateStat('money', -40);
                    this.updateStat('energy', -20);
                    this.updateStat('health', 5);
                    this.updateStat('happiness', 2);
                    UI.log("Buena sesi√≥n en el gym. +Salud, +Felicidad.", "good");
                }
                else if (type === 'marathon') {
                    if (state.money < 100) return UI.log("Dinero insuficiente.", "bad");
                    this.updateStat('money', -100);
                    this.updateStat('energy', -50);
                    this.updateStat('health', 15);
                    this.updateStat('happiness', 10);
                    UI.log("Corriste una marat√≥n. ¬°Te sientes genial!", "good");
                }

                UI.els.modals.act.classList.remove('active');
                UI.render();
            },



            startCourse(courseId) {
                if (state.activeCourse) {
                    UI.showAlert("Ya est√°s estudiando", "Termina tu curso actual antes de empezar otro.");
                    return;
                }
                const course = COURSES.find(c => c.id === courseId);
                if (state.money < course.cost) {
                    UI.showAlert("Fondos Insuficientes", `El curso cuesta $${course.cost}.`);
                    return;
                }
                if (state.education.includes(courseId)) {
                    UI.showAlert("Ya tienes este t√≠tulo", "No puedes cursarlo de nuevo.");
                    return;
                }

                this.updateStat('money', -course.cost);
                state.activeCourse = { id: courseId, monthsLeft: course.duration };

                UI.showAlert("Matriculado", `Has comenzado el ${course.title}. Duraci√≥n: ${course.duration} meses. Prep√°rate para perder energ√≠a.`);
                UI.els.modals.act.classList.remove('active');
                UI.render();
            },

            rest() {
                state.consecutiveWork = 0; // Reset burnout
                this.updateStat('energy', 40);
                this.updateStat('health', 2);
                this.updateStat('happiness', 3);
                UI.log("Tomaste un descanso y te relajaste.", "normal");
                UI.render();
            },

            nextMonth() {
                if (this.checkGameOver()) return;
                state.totalMonths++;

                state.consecutiveWork = 0; // Reset burnout monthly

                // Sickness Check
                if (state.sickDuration > 0) {
                    state.sickDuration--;
                    UI.log("Sigues recuper√°ndote de tu enfermedad...", "bad");
                } else if (state.health < 30) {
                    if (Math.random() < 0.3) {
                        state.sickDuration = 2;
                        UI.log("¬°Te has enfermado gravemente! No podr√°s trabajar por 2 meses.", "bad");
                        this.updateStat('happiness', -20);
                    } else {
                        UI.log("Tu salud es fr√°gil. Cuidate o te enfermar√°s.", "info");
                    }
                }

                // Mantenimiento de Items
                let stats = this.calculateItemEffects();
                let totalCost = CONFIG.costOfLiving + stats.maint;

                this.updateStat('money', -totalCost);
                this.updateStat('happiness', stats.happy);

                let msg = `Mes nuevo. Gastos: -$${totalCost} (Vida + Mantenimiento)`;
                let type = 'normal';

                if (state.money < 0) {
                    msg += " ¬°Est√°s en DEUDA! (-Felicidad)";
                    this.updateStat('happiness', -5);
                    this.updateStat('health', -2);
                    type = 'bad';
                }

                // Education Progress
                let maxEnergy = 100;
                if (state.activeCourse) {
                    state.activeCourse.monthsLeft--;
                    const course = COURSES.find(c => c.id === state.activeCourse.id);
                    maxEnergy -= course.penalty; // Apply penalty to max energy logic

                    if (state.activeCourse.monthsLeft <= 0) {
                        state.education.push(state.activeCourse.id);
                        UI.showAlert("¬°Felicidades!", `Has completado el curso: ${course.title}. Obtuviste el t√≠tulo: ${course.degree}.`);
                        state.activeCourse = null;
                        maxEnergy = 100; // Reset penalty
                    } else {
                        msg += ` | Estudiando: ${course.title} (-${course.penalty} E Max)`;
                    }
                }

                state.energy = maxEnergy;
                UI.log(msg, type);
                this.randomEvent();
                UI.render();
            },

            randomEvent() {
                // 20% Chance
                if (Math.random() > 0.2) return;

                const event = EVENTS[Math.floor(Math.random() * EVENTS.length)];

                if (event.type === 'instant') {
                    const res = event.effect(state);
                    this.applyEffect(res);
                } else if (event.type === 'choice') {
                    this.showEventModal(event);
                }
            },

            applyEffect(res) {
                if (res.money) this.updateStat('money', res.money);
                if (res.health) this.updateStat('health', res.health);
                if (res.happiness) this.updateStat('happiness', res.happiness);
                if (res.energy) this.updateStat('energy', res.energy);
                if (res.intelligence) this.updateStat('intelligence', res.intelligence);
                if (res.experience) this.updateStat('experience', res.experience);

                UI.log(res.msg || "Evento procesado.", res.type || 'info');
                UI.render();
            },

            showEventModal(event) {
                UI.els.modals.eventText.innerText = event.text;
                UI.els.modals.eventChoices.innerHTML = '';

                event.choices.forEach(choice => {
                    const btn = document.createElement('div');
                    btn.className = 'choice-btn';
                    btn.innerHTML = `<span class="choice-text">${choice.text}</span><span class="choice-sub">${choice.sub}</span>`;
                    btn.onclick = () => {
                        const res = choice.action(state);
                        this.applyEffect(res);
                        UI.els.modals.event.classList.remove('active');
                    };
                    UI.els.modals.eventChoices.appendChild(btn);
                });

                UI.els.modals.event.classList.add('active');
            },

            applyToJob(jobId) {
                const job = JOBS.find(j => j.id === jobId);
                if (!job) return;

                // Verify Requirements
                const reqs = job.req;
                let missing = [];

                if (reqs.int && state.intelligence < reqs.int) missing.push(`Inteligencia ${reqs.int}`);
                if (reqs.exp && state.experience < reqs.exp) missing.push(`Experiencia ${reqs.exp}`);
                if (reqs.health && state.health < reqs.health) missing.push(`Salud ${reqs.health}`);
                if (reqs.happy && state.happiness < reqs.happy) missing.push(`Felicidad ${reqs.happy}`);
                if (reqs.deg && !state.education.includes(reqs.deg)) {
                    const c = COURSES.find(x => x.id === reqs.deg);
                    missing.push(`T√≠tulo: ${c ? c.degree : reqs.deg}`);
                }

                if (missing.length > 0) {
                    UI.showAlert("Requisitos Insuficientes", `Te falta: ${missing.join(', ')}`);
                    return;
                }

                state.currJobId = jobId;
                state.jobXP = 0; // Reset XP on new job
                // Do not reset promotions count, as it reflects career efficiency
                UI.showAlert("¬°Contratado!", `Has sido contratado como ${job.title}.`);
                UI.log(`Nueva carrera: ${job.title}`, "good");
                UI.render();
                UI.els.modals.job.classList.remove('active');
            },

            checkGameOver() {
                if (state.health <= 0) {
                    UI.showAlert("GAME OVER", "Tu cuerpo no pudo m√°s. Has muerto.", () => location.reload()); // Simple reload for now
                    this.disableGame();
                    return true;
                }
                return false;
            },
            disableGame() { Object.values(UI.els.btns).forEach(b => b.disabled = true); },

            buyItem(itemId) {
                const item = SHOP_ITEMS.find(i => i.id === itemId);
                if (state.money < item.price) {
                    UI.showAlert("Fondos Insuficientes", "No tienes suficiente dinero para comprar esto.");
                    return;
                }
                if (state.inventory.includes(itemId)) return;

                this.updateStat('money', -item.price);
                state.inventory.push(itemId);
                UI.log(`Compraste: ${item.name}`, "good");

                // Refresh Shop UI if open
                const container = UI.els.modals.shopList;
                if (container && UI.els.modals.shop.classList.contains('active')) {
                    // Could re-render shop here but lazy way is nice
                    UI.els.modals.shopBtn.click();
                }
                UI.render();
            },

            calculateItemEffects() {
                let maint = 0;
                let happy = 0;
                let colRed = 0;

                state.inventory.forEach(id => {
                    const item = SHOP_ITEMS.find(i => i.id === id);
                    if (!item) return;
                    maint += item.maint;
                    if (item.effect.type === 'col_red') colRed += item.effect.val;
                    if (item.effect.type === 'happy_boost') happy += item.effect.val;
                });

                return { maint: Math.max(0, maint - colRed), happy };
            }
        };

        // --- 5. SUPABASE LOGIC ---
        const DB = {
            user: null,

            async init() {
                if (!sb) return;
                try {
                    const { data: { session } } = await sb.auth.getSession();
                    this.user = session?.user || null;
                    UI.updateAuthUI(this.user);

                    sb.auth.onAuthStateChange((_event, session) => {
                        this.user = session?.user || null;
                        UI.updateAuthUI(this.user);
                    });
                } catch (e) { console.log("Supabase/Auth offline or not conn."); }
            },

            async login(email, password) {
                if (!sb) return UI.showAlert("Error", "Configura SUPABASE_URL en el c√≥digo.");
                UI.els.auth.msg.innerText = "Conectando...";

                // Try SignIn
                let { data, error } = await sb.auth.signInWithPassword({ email, password });

                if (error) {
                    // Try SignUp
                    console.log("Login failed, trying signup:", error.message);
                    const { data: signUpData, error: signUpError } = await sb.auth.signUp({ email, password });
                    if (signUpError) {
                        UI.els.auth.msg.innerText = "Error: " + signUpError.message;
                    } else {
                        UI.els.auth.msg.innerText = "¬°Registro exitoso!";
                    }
                } else {
                    UI.els.auth.msg.innerText = "";
                    UI.showAlert("Bienvenido", "Sesi√≥n iniciada correctamente.");
                    UI.els.modals.settings.classList.remove('active');
                }
            },

            async logout() {
                if (!sb) return;
                await sb.auth.signOut();
            },

            async saveGame() {
                if (!this.user) return;
                UI.els.auth.saveMsg.innerText = "Guardando...";

                const { error } = await sb
                    .from('saves')
                    .upsert({ user_id: this.user.id, game_data: state });

                if (error) {
                    UI.els.auth.saveMsg.innerText = "Error al guardar: " + error.message;
                } else {
                    UI.els.auth.saveMsg.innerText = "¬°Partida guardada!";
                    setTimeout(() => UI.els.auth.saveMsg.innerText = "Sesi√≥n activa.", 2000);
                }
            },

            async loadGame() {
                if (!this.user) return;
                UI.els.auth.saveMsg.innerText = "Cargando...";

                const { data, error } = await sb
                    .from('saves')
                    .select('game_data')
                    .single();

                if (error) {
                    UI.els.auth.saveMsg.innerText = "No se encontr√≥ partida guardada.";
                } else if (data) {
                    state = data.game_data;
                    UI.render();
                    Game.randomEvent(); // Just to refresh state/visuals maybe
                    UI.log("Partida cargada desde la nube.", "info");
                    UI.els.modals.settings.classList.remove('active');
                }
            },

            async submitScore(score) {
                if (!this.user || !sb) return;
                // Assuming 'leaderboard' table exists: id, user_id, email, score, created_at
                await sb.from('leaderboard').insert({
                    user_id: this.user.id,
                    email: this.user.email,
                    score: score
                });
            }
        };

        // Activity Modal (Dynamic Courses)
        UI.els.btns.work.onclick = () => Game.work();
        UI.els.btns.study.onclick = () => {
            const list = document.getElementById('courses-list');
            list.innerHTML = '';

            COURSES.forEach(c => {
                const isActive = state.activeCourse && state.activeCourse.id === c.id;
                const isOwned = state.education && state.education.includes(c.id);

                let statusHtml = '';
                if (isActive) statusHtml = `<span style="color:#4dffea">En Curso (${state.activeCourse.monthsLeft} meses)</span>`;
                else if (isOwned) statusHtml = `<span style="color:#aaa">Completado</span>`;

                const btn = document.createElement('button');
                btn.className = 'act-btn';
                btn.onclick = () => Game.startCourse(c.id);
                if (isActive || isOwned) btn.disabled = true;

                btn.innerHTML = `
                    <div class="act-info">
                        <h4>${c.title}</h4>
                        <p>${c.duration} meses. Penalidad: -${c.penalty} Energ√≠a/mes.</p>
                        ${statusHtml}
                    </div>
                    <div class="act-cost">-$${c.cost}</div>
                 `;
                list.appendChild(btn);
            });

            UI.els.modals.act.classList.add('active');
        };
        UI.els.modals.closeAct.onclick = () => UI.els.modals.act.classList.remove('active');
        UI.els.btns.rest.onclick = () => Game.rest();
        UI.els.btns.next.onclick = () => Game.nextMonth();

        // Jobs Modal
        UI.els.jobTrigger.onclick = () => {
            const container = UI.els.modals.jobList;
            container.innerHTML = '';

            // Group by Career
            const careers = {
                'tech': 'Tecnolog√≠a',
                'corp': 'Corporativo',
                'sport': 'Deportes'
            };

            Object.entries(careers).forEach(([key, label]) => {
                const header = document.createElement('h3');
                header.style.cssText = "color: #fff; border-bottom: 1px solid #444; padding-bottom: 5px; margin-top:15px;";
                header.innerText = label;
                container.appendChild(header);

                JOBS.filter(j => j.career === key).forEach(job => {
                    const isCurrent = state.currJobId === job.id;
                    const div = document.createElement('div');
                    div.className = 'job-item';

                    // Build req string
                    let reqText = [];
                    if (job.req.int) reqText.push(`Int ${job.req.int}`);
                    if (job.req.exp) reqText.push(`Exp ${job.req.exp}`);
                    if (job.req.health) reqText.push(`Salud ${job.req.health}`);

                    div.innerHTML = `
                        <div class="job-details">
                            <h4>${job.title} ${isCurrent ? '(Actual)' : ''}</h4>
                            <p>Salario: $${job.salary}</p>
                            <div class="job-req">${reqText.join(' | ') || 'Sin requisitos'}</div>
                        </div>
                        ${!isCurrent ? `<button class="btn-select-job" onclick="Game.applyToJob('${job.id}')">Postular</button>` : ''}
                    `;
                    container.appendChild(div);
                });
            });

            UI.els.modals.job.classList.add('active');
        };
        UI.els.modals.closeJob.onclick = () => UI.els.modals.job.classList.remove('active');

        // Settings Modal
        UI.els.btns.settings.onclick = () => UI.els.modals.settings.classList.add('active');
        UI.els.modals.closeSettings.onclick = () => UI.els.modals.settings.classList.remove('active');

        // Shop Modal
        UI.els.modals.shopBtn.onclick = () => {
            const container = UI.els.modals.shopList;
            container.innerHTML = '';
            SHOP_ITEMS.forEach(item => {
                const owned = state.inventory.includes(item.id);
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `
                    <div class="shop-details">
                        <h4>${item.name} ${owned ? '<span class="owned-tag">(En Posesi√≥n)</span>' : ''}</h4>
                        <p>${item.desc}</p>
                        <div class="shop-cost">$${item.price} ${item.maint > 0 ? `<span class="shop-maint">(-$${item.maint}/mes)</span>` : ''}</div>
                    </div>
                    <button class="btn-buy" onclick="Game.buyItem('${item.id}')" ${owned || state.money < item.price ? 'disabled' : ''}>
                        ${owned ? 'Comprado' : 'Comprar'}
                    </button>
                 `;
                container.appendChild(div);
            });
            UI.els.modals.shop.classList.add('active');
        };
        UI.els.modals.closeShop.onclick = () => UI.els.modals.shop.classList.remove('active');

        // Auth Listeners
        UI.els.auth.loginBtn.onclick = () => {
            const email = UI.els.auth.emailInput.value;
            const pass = UI.els.auth.passInput.value;
            if (email && pass) DB.login(email, pass);
        };
        UI.els.auth.logoutBtn.onclick = () => DB.logout();
        UI.els.auth.saveBtn.onclick = () => DB.saveGame();
        UI.els.auth.loadBtn.onclick = () => DB.loadGame();

        // Init
        setTimeout(() => DB.init(), 500); // Small delay to ensure Supabase loads
        UI.render();

    </script>
</body>

</html>